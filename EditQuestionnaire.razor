@page "/customization/questionnaires/edit/{Id:int}"
@using Aloha.Domain.Questionnaires
@using Microsoft.AspNetCore.Authorization
@using Aloha.Domain.Services.AdminAudit
@using Aloha.Domain.Identity.AdminUsers.Activities
@using Aloha.Domain.Identity.AdminUsers
@using Microsoft.AspNetCore.Identity
@using Aloha.Domain.Services.Translations
@using System.Globalization
@using Aloha.Domain.Localization
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Roles = "MahaloAdmin, MasterAdmin, FormManager, Audit")]
@inject AuthenticationStateProvider authStateProvider
@inject IDbContextFactory<AlohaDb> DbFactory
@inject NavigationManager Nav
@inject IAdminActivityService adminActivityService
@inject UserManager<AdminUser> UserManager
@inject ITranslationHelper TranslationHelper
@inject ILanguageConfigurationService LanguageConfigService
@rendermode InteractiveServer

<h3>Edit Questionnaire</h3>
<p>Submission of this form will update an existing questionnaire</p>
<p class="form-text">* Indicate Required Fields</p>
@if (questionnaireToEdit is not null)
{
    @* Language selector at the top - controls all text inputs - sticky and full width *@
    @if (isMultiLanguageEnabled)
    {
        <div class="sticky-top bg-white border-bottom p-3 mb-3 shadow-sm" style="z-index: 1020; margin-left: -15px; margin-right: -15px; padding-left: 15px !important; padding-right: 15px !important;">
            <div class="d-flex align-items-end gap-3">
                <div class="flex-grow-1">
                    <label class="form-label fw-bold mb-2">Editing Language:</label>
                    <InputSelect @bind-Value="bulkSelectedCulture" 
                                @bind-Value:after="OnLanguageChanged"
                                class="form-select" 
                                style="width: 100%;"
                                id="questionnaire-language-select">
                        <option value="@primaryLanguage">@(languageDisplayNames.TryGetValue(primaryLanguage, out var primaryDisplayName) ? primaryDisplayName : primaryLanguage) (Primary)</option>
                        @foreach (var lang in availableLanguages)
                        {
                            <option value="@lang">@(languageDisplayNames.TryGetValue(lang, out var displayName) ? displayName : lang)</option>
                        }
                    </InputSelect>
                </div>
                <div class="mb-0">
                    <BulkTranslateButton @ref="bulkTranslateButton"
                                        SelectedCulture="@bulkSelectedCulture"
                                        SelectedCultureChanged="@OnBulkCultureChanged"
                                        OnBulkTranslate="@OnBulkTranslateAll"
                                        OnBulkTranslateAllLanguages="@OnBulkTranslateAllLanguages"
                                        GetFieldsWithExistingText="@GetFieldsWithExistingText"
                                        HasEnglishTextFunc="@HasEnglishText" />
                </div>
            </div>
        </div>
    }

    <QuestionnaireForm 
    @ref="qForm"
    InitialValues="questionnaireToEdit"
    IsReadOnly="isReadOnly"
    SelectedCulture="@bulkSelectedCulture"
    OnCancel="HandleCancel"
    OnSubmit="HandleSubmit"
    />
}

@code {

    [Parameter]
    public int Id { get; set; }

    private Questionnaire? questionnaireToEdit;
    private QuestionnaireForm? qForm;
    private bool isReadOnly = true;
    private AdminUser? AdminUser = default!;
    private string bulkSelectedCulture = "en-US"; // Will be initialized to primary language
    private string primaryLanguage = "en-US";
    private bool isMultiLanguageEnabled = false;
    private List<string> availableLanguages = new();
    private Dictionary<string, string> languageDisplayNames = new();
    private BulkTranslateButton? bulkTranslateButton;

    protected override async Task OnInitializedAsync()
    {
        await CheckRoleAndUpdateReadOnlyFlagAsync();
        primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
        bulkSelectedCulture = primaryLanguage;
        isMultiLanguageEnabled = await LanguageConfigService.IsMultiLanguageEnabledAsync();
        
        // Load available languages and display names
        if (isMultiLanguageEnabled)
        {
            var allEnabledLanguages = await LanguageConfigService.GetEnabledLanguagesAsync();
            availableLanguages = allEnabledLanguages.Where(l => l != primaryLanguage).ToList();
            
            languageDisplayNames = new Dictionary<string, string>();
            languageDisplayNames[primaryLanguage] = await LanguageConfigService.GetLanguageDisplayNameAsync(primaryLanguage);
            foreach (var lang in availableLanguages)
            {
                languageDisplayNames[lang] = await LanguageConfigService.GetLanguageDisplayNameAsync(lang);
            }
        }
        
        await using var db = await DbFactory.CreateDbContextAsync();

        questionnaireToEdit = await db.Questionnaires
            .Include(questionnaire => questionnaire.Questions)!
            .ThenInclude(question => question.MultipleChoiceOptions)!
            .ThenInclude(multipleChoiceOption => multipleChoiceOption.DependentMultipleChoiceOptions)
            .Include(questionnaire => questionnaire.QuestionGroups)
            .Include(questionnaire => questionnaire.QuestionnaireApplicationTypeLinks)
            .Include(questionnaire => questionnaire.QuestionnaireShareProductLinks)
            .Include(questionnaire => questionnaire.QuestionnaireLoanProductLinks)
            .FirstOrDefaultAsync(q => q.Id == Id);

        if (questionnaireToEdit is null)
        {
            Nav.NavigateTo("/customization/questionnaires");
            return;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
            bulkSelectedCulture = primaryLanguage;
            StateHasChanged();
        }
    }

    private async Task CheckRoleAndUpdateReadOnlyFlagAsync()
    {
        var authUser = (await authStateProvider.GetAuthenticationStateAsync()).User;
        AdminUser = await UserManager.FindByEmailAsync(authUser.Identity!.Name!);

        isReadOnly = !(
            authUser.IsInRole("MahaloAdmin") ||
            authUser.IsInRole("MasterAdmin") ||
            authUser.IsInRole("FormManager"));
    }

    private void HandleCancel()
    {
        Nav.NavigateTo("/customization/questionnaires");
    }

    private async Task OnLanguageChanged()
    {
        StateHasChanged();
    }

    private async Task OnBulkCultureChanged(string culture)
    {
        bulkSelectedCulture = culture;
        StateHasChanged();
    }

    private bool HasEnglishText()
    {
        // Check if questionnaire has English text
        if (questionnaireToEdit == null) return false;
        
        return !string.IsNullOrWhiteSpace(questionnaireToEdit.Name) ||
               !string.IsNullOrWhiteSpace(questionnaireToEdit.Description);
    }

    private List<string> GetFieldsWithExistingText()
    {
        var fields = new List<string>();
        if (questionnaireToEdit == null) return fields;
        
        // This would need to check all nested fields - for now, just return empty
        // The bulk translate functionality can be enhanced later if needed
        return fields;
    }

    private async Task OnBulkTranslateAll()
    {
        bulkTranslateButton?.ClearError();
        // Bulk translate functionality would go here
        // For now, just a placeholder
        await Task.CompletedTask;
    }

    private async Task OnBulkTranslateAllLanguages()
    {
        bulkTranslateButton?.ClearError();
        // Bulk translate all languages functionality would go here
        // For now, just a placeholder
        await Task.CompletedTask;
    }

    // Translation loading helper methods for nested entities
    public static async Task<Dictionary<string, string>> LoadQuestionTranslations(IDbContextFactory<AlohaDb> dbFactory, int questionId, string fieldKey, string primaryLanguage, List<string> enabledLanguages)
    {
        await using var db = await dbFactory.CreateDbContextAsync();
        var resourceKey = $"Question.{questionId}";
        
        var translations = await db.Set<LocalizationString>()
            .Where(s => s.ResourceKey == resourceKey && s.Key == fieldKey)
            .Include(s => s.LocalizationCulture)
            .ToListAsync();
        
        var result = new Dictionary<string, string>();
        
        foreach (var trans in translations)
        {
            var culture = trans.LocalizationCulture?.Culture;
            if (string.IsNullOrWhiteSpace(culture) || culture == primaryLanguage || !enabledLanguages.Contains(culture))
            {
                continue;
            }
            
            result[culture] = trans.DefaultText ?? "";
        }
        
        return result;
    }

    public static async Task<Dictionary<string, string>> LoadQuestionGroupTranslations(IDbContextFactory<AlohaDb> dbFactory, int groupId, string fieldKey, string primaryLanguage, List<string> enabledLanguages)
    {
        await using var db = await dbFactory.CreateDbContextAsync();
        var resourceKey = $"QuestionGroup.{groupId}";
        
        var translations = await db.Set<LocalizationString>()
            .Where(s => s.ResourceKey == resourceKey && s.Key == fieldKey)
            .Include(s => s.LocalizationCulture)
            .ToListAsync();
        
        var result = new Dictionary<string, string>();
        
        foreach (var trans in translations)
        {
            var culture = trans.LocalizationCulture?.Culture;
            if (string.IsNullOrWhiteSpace(culture) || culture == primaryLanguage || !enabledLanguages.Contains(culture))
            {
                continue;
            }
            
            result[culture] = trans.DefaultText ?? "";
        }
        
        return result;
    }

    public static async Task<Dictionary<string, string>> LoadOptionTranslations(IDbContextFactory<AlohaDb> dbFactory, int optionId, string fieldKey, string primaryLanguage, List<string> enabledLanguages)
    {
        await using var db = await dbFactory.CreateDbContextAsync();
        var resourceKey = $"MultipleChoiceOption.{optionId}";
        
        var translations = await db.Set<LocalizationString>()
            .Where(s => s.ResourceKey == resourceKey && s.Key == fieldKey)
            .Include(s => s.LocalizationCulture)
            .ToListAsync();
        
        var result = new Dictionary<string, string>();
        
        foreach (var trans in translations)
        {
            var culture = trans.LocalizationCulture?.Culture;
            if (string.IsNullOrWhiteSpace(culture) || culture == primaryLanguage || !enabledLanguages.Contains(culture))
            {
                continue;
            }
            
            result[culture] = trans.DefaultText ?? "";
        }
        
        return result;
    }

    public static async Task<Dictionary<string, string>> LoadDependentOptionTranslations(IDbContextFactory<AlohaDb> dbFactory, int dependentOptionId, string fieldKey, string primaryLanguage, List<string> enabledLanguages)
    {
        await using var db = await dbFactory.CreateDbContextAsync();
        var resourceKey = $"DependentMultipleChoiceOption.{dependentOptionId}";
        
        var translations = await db.Set<LocalizationString>()
            .Where(s => s.ResourceKey == resourceKey && s.Key == fieldKey)
            .Include(s => s.LocalizationCulture)
            .ToListAsync();
        
        var result = new Dictionary<string, string>();
        
        foreach (var trans in translations)
        {
            var culture = trans.LocalizationCulture?.Culture;
            if (string.IsNullOrWhiteSpace(culture) || culture == primaryLanguage || !enabledLanguages.Contains(culture))
            {
                continue;
            }
            
            result[culture] = trans.DefaultText ?? "";
        }
        
        return result;
    }

    private async Task HandleSubmit(QuestionnaireForm.Input values)
    {
        Console.WriteLine($"[EditQuestionnaire.HandleSubmit] START");
        Console.WriteLine($"[EditQuestionnaire.HandleSubmit] values.Name: '{values.Name}'");
        Console.WriteLine($"[EditQuestionnaire.HandleSubmit] values.Description: '{values.Description}'");
        Console.WriteLine($"[EditQuestionnaire.HandleSubmit] values.NameTranslations: {string.Join(", ", values.NameTranslations.Select(kvp => $"{kvp.Key}='{kvp.Value}'"))}");
        Console.WriteLine($"[EditQuestionnaire.HandleSubmit] values.DescriptionTranslations: {string.Join(", ", values.DescriptionTranslations.Select(kvp => $"{kvp.Key}='{kvp.Value}'"))}");
        
        // Log all questions
        foreach (var question in values.UngroupedQuestions)
        {
            var nameTranslationsArray = question.NameTranslations.Select(kvp => string.Format("{0}='{1}'", kvp.Key, kvp.Value)).ToArray();
            var nameTranslationsStr = string.Join(", ", (IEnumerable<string>)nameTranslationsArray);
            var questionName = question.Name ?? "";
            Console.WriteLine($"[EditQuestionnaire.HandleSubmit] Ungrouped Question - Name: '{questionName}', NameTranslations: {nameTranslationsStr}");
        }
        
        foreach (var group in values.QuestionGroups)
        {
            var groupNameTranslationsArray = group.NameTranslations.Select(kvp => string.Format("{0}='{1}'", kvp.Key, kvp.Value)).ToArray();
            var groupNameTranslationsStr = string.Join(", ", (IEnumerable<string>)groupNameTranslationsArray);
            var groupName = group.Name ?? "";
            Console.WriteLine($"[EditQuestionnaire.HandleSubmit] Group - Name: '{groupName}', NameTranslations: {groupNameTranslationsStr}");
            foreach (var question in group.Questions)
            {
                var questionNameTranslationsArray = question.NameTranslations.Select(kvp => string.Format("{0}='{1}'", kvp.Key, kvp.Value)).ToArray();
                var questionNameTranslationsStr = string.Join(", ", (IEnumerable<string>)questionNameTranslationsArray);
                var questionName2 = question.Name ?? "";
                Console.WriteLine($"[EditQuestionnaire.HandleSubmit] Grouped Question - Name: '{questionName2}', NameTranslations: {questionNameTranslationsStr}");
            }
        }
        
        try
        {
            qForm?.SetSaving(true);
            var questionnaireId = questionnaireToEdit!.Id;
            
            await using var db = await DbFactory.CreateDbContextAsync();
            await DeleteQuestionnaireLinkedEntities(db, questionnaireId);
            Console.WriteLine($"[EditQuestionnaire.HandleSubmit] Calling UpdateQuestionnaire...");
            await UpdateQuestionnaire(db, questionnaireId, values);
            Console.WriteLine($"[EditQuestionnaire.HandleSubmit] UpdateQuestionnaire completed successfully");
            qForm?.Notify(new(ToastType.Success, string.Empty));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[EditQuestionnaire.HandleSubmit] ERROR: {ex.Message}");
            Console.WriteLine($"[EditQuestionnaire.HandleSubmit] StackTrace: {ex.StackTrace}");
            qForm?.Notify(new(ToastType.Warning, string.Empty));
        }
    }

    private async Task UpdateQuestionnaire(AlohaDb db, int questionnaireId, QuestionnaireForm.Input values)
    {
        var questionnaire = await db.Questionnaires
               .Include(q => q.Questions!)
               .ThenInclude(q => q.QuestionGroup)
               .Include(q => q.Questions!)
               .ThenInclude(q => q.MultipleChoiceOptions!)
               .ThenInclude(q => q.DependentMultipleChoiceOptions)
               .Include(q => q.QuestionGroups)
               .Include(questionnaire => questionnaire.QuestionnaireApplicationTypeLinks)
               .Include(questionnaire => questionnaire.QuestionnaireShareProductLinks)
               .Include(questionnaire => questionnaire.QuestionnaireLoanProductLinks)
               .FirstAsync(q => q.Id == questionnaireId);
        var oldConfig = db.Entry(questionnaire).CurrentValues.Clone().ToObject();

        // Get primary language and enabled languages to determine save strategy
        var primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
        var enabledLanguages = await LanguageConfigService.GetEnabledLanguagesAsync();

        // Create Ungrouped Questions
        foreach (var draftQuestion in values.UngroupedQuestions)
        {
            // Entity properties always contain English values, regardless of primary language setting
            string englishQuestionName;
            string? englishQuestionDescription;
            
            if (primaryLanguage.StartsWith("en"))
            {
                // Primary language is English, so draftQuestion.Name contains English
                englishQuestionName = draftQuestion.Name ?? "";
                englishQuestionDescription = draftQuestion.Description;
            }
            else
            {
                // Primary language is Spanish, so get English from translations dictionary
                Console.WriteLine($"[UpdateQuestionnaire] Primary language is Spanish, extracting English from translations");
                var draftQuestionName = draftQuestion.Name ?? "";
                Console.WriteLine($"[UpdateQuestionnaire] draftQuestion.Name (Spanish): '{draftQuestionName}'");
                var nameTranslationsArray = draftQuestion.NameTranslations.Select(kvp => string.Format("{0}='{1}'", kvp.Key, kvp.Value)).ToArray();
                var nameTranslationsStr = string.Join(", ", (IEnumerable<string>)nameTranslationsArray);
                Console.WriteLine($"[UpdateQuestionnaire] draftQuestion.NameTranslations: {nameTranslationsStr}");
                var englishCulture = enabledLanguages.FirstOrDefault(l => l.StartsWith("en"));
                if (englishCulture != null && draftQuestion.NameTranslations.TryGetValue(englishCulture, out var enName))
                {
                    englishQuestionName = enName;
                    Console.WriteLine($"[UpdateQuestionnaire] Found English in NameTranslations[{englishCulture}]: '{englishQuestionName}'");
                }
                else
                {
                    // Fallback to draftQuestion.Name if English translation not found
                    englishQuestionName = draftQuestion.Name ?? "";
                    Console.WriteLine($"[UpdateQuestionnaire] English not found in NameTranslations, using fallback draftQuestion.Name: '{englishQuestionName}'");
                }
                
                if (englishCulture != null && draftQuestion.DescriptionTranslations.TryGetValue(englishCulture, out var enDesc))
                {
                    englishQuestionDescription = enDesc;
                    Console.WriteLine($"[UpdateQuestionnaire] Found English in DescriptionTranslations[{englishCulture}]: '{englishQuestionDescription}'");
                }
                else
                {
                    englishQuestionDescription = draftQuestion.Description;
                    Console.WriteLine($"[UpdateQuestionnaire] English not found in DescriptionTranslations, using fallback draftQuestion.Description: '{englishQuestionDescription}'");
                }
            }
            
            Console.WriteLine($"[UpdateQuestionnaire] Final englishQuestionName: '{englishQuestionName}'");
            Console.WriteLine($"[UpdateQuestionnaire] Final englishQuestionDescription: '{englishQuestionDescription}'");
            
            var question = Question.Create(
                questionnaire.Id,
                englishQuestionName,
                draftQuestion.IsRequired,
                draftQuestion.SortOrder,
                draftQuestion.Type,
                englishQuestionDescription,
                questionGroupId: null);

            db.Add(question);
            await db.SaveChangesAsync();

            // Save question translations
            Console.WriteLine($"[UpdateQuestionnaire] Before SaveQuestionTranslations - QuestionId: {question.Id}");
            var draftQuestionName2 = draftQuestion.Name ?? "";
            var draftQuestionDesc = draftQuestion.Description ?? "";
            Console.WriteLine($"[UpdateQuestionnaire] draftQuestion.Name: '{draftQuestionName2}'");
            Console.WriteLine($"[UpdateQuestionnaire] draftQuestion.Description: '{draftQuestionDesc}'");
            var nameTranslationsArray2 = draftQuestion.NameTranslations.Select(kvp => string.Format("{0}='{1}'", kvp.Key, kvp.Value)).ToArray();
            var nameTranslationsStr2 = string.Join(", ", (IEnumerable<string>)nameTranslationsArray2);
            var descTranslationsArray = draftQuestion.DescriptionTranslations.Select(kvp => string.Format("{0}='{1}'", kvp.Key, kvp.Value)).ToArray();
            var descTranslationsStr = string.Join(", ", (IEnumerable<string>)descTranslationsArray);
            Console.WriteLine($"[UpdateQuestionnaire] draftQuestion.NameTranslations: {nameTranslationsStr2}");
            Console.WriteLine($"[UpdateQuestionnaire] draftQuestion.DescriptionTranslations: {descTranslationsStr}");
            await SaveQuestionTranslations(db, question.Id, draftQuestion.Name, draftQuestion.Description, draftQuestion.NameTranslations, draftQuestion.DescriptionTranslations);

            var excludedQuestionProperties = new List<string> { nameof(question.QuestionnaireId), nameof(question.QuestionGroupId), nameof(question.MultipleChoiceOptions), nameof(question.Questionnaire), nameof(question.QuestionGroup) };
            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Question created for questionnaire {questionnaire.Name}: ", oldConfig, question, excludedQuestionProperties);

            // Create multiple choice options
            if (draftQuestion.Type is QuestionType.SingleSelect or QuestionType.MultipleSelect &&
                draftQuestion.MultipleChoiceOptions is not null &&
                draftQuestion.MultipleChoiceOptions.Any())
            {
                foreach (var draftOption in draftQuestion.MultipleChoiceOptions!)
                {
                    // Entity properties always contain English values, regardless of primary language setting
                    string englishOptionName;
                    string? englishDependentQuestionName;
                    
                    if (primaryLanguage.StartsWith("en"))
                    {
                        // Primary language is English
                        englishOptionName = draftOption.Name ?? "";
                        englishDependentQuestionName = draftOption.DependentQuestionName;
                    }
                    else
                    {
                        // Primary language is Spanish, so get English from translations dictionary
                        var englishCulture = enabledLanguages.FirstOrDefault(l => l.StartsWith("en"));
                        if (englishCulture != null && draftOption.NameTranslations.TryGetValue(englishCulture, out var enName))
                        {
                            englishOptionName = enName;
                        }
                        else
                        {
                            englishOptionName = draftOption.Name ?? "";
                        }
                        
                        if (englishCulture != null && draftOption.DependentQuestionNameTranslations.TryGetValue(englishCulture, out var enDepName))
                        {
                            englishDependentQuestionName = enDepName;
                        }
                        else
                        {
                            englishDependentQuestionName = draftOption.DependentQuestionName;
                        }
                    }
                    
                    var option = MultipleChoiceOption.Create(
                        englishOptionName,
                        draftOption.SortOrder,
                        draftOption.DependentQuestionType,
                        question.Id,
                        englishDependentQuestionName);

                    db.Add(option);
                    await db.SaveChangesAsync();

                    // Save option translations
                    await SaveOptionTranslations(db, option.Id, draftOption.Name, draftOption.DependentQuestionName, draftOption.NameTranslations, draftOption.DependentQuestionNameTranslations);

                    var excludedOptionProperties = new List<string> { nameof(option.DependentQuestionName), nameof(option.QuestionId), nameof(option.DependentMultipleChoiceOptions) };
                    await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Option created for question {question.Name}: ", option, excludedOptionProperties);

                    if (draftOption.HasDependentQuestion &&
                        draftOption.DependentQuestionType is DependentQuestionType.MultipleSelect or DependentQuestionType.SingleSelect &&
                        draftOption.DependentMultipleChoiceOptions is not null &&
                        draftOption.DependentMultipleChoiceOptions.Any())
                    {
                        foreach (var draftDependentOption in draftOption.DependentMultipleChoiceOptions!)
                        {
                            // Entity properties always contain English values, regardless of primary language setting
                            string englishDepOptionName;
                            string? englishFreeFormDescription;
                            
                            if (primaryLanguage.StartsWith("en"))
                            {
                                // Primary language is English
                                englishDepOptionName = draftDependentOption.Name ?? "";
                                englishFreeFormDescription = draftDependentOption.FreeFormFieldDescription;
                            }
                            else
                            {
                                // Primary language is Spanish, so get English from translations dictionary
                                var englishCulture = enabledLanguages.FirstOrDefault(l => l.StartsWith("en"));
                                if (englishCulture != null && draftDependentOption.NameTranslations.TryGetValue(englishCulture, out var enName))
                                {
                                    englishDepOptionName = enName;
                                }
                                else
                                {
                                    englishDepOptionName = draftDependentOption.Name ?? "";
                                }
                                
                                if (englishCulture != null && draftDependentOption.FreeFormFieldDescriptionTranslations.TryGetValue(englishCulture, out var enDesc))
                                {
                                    englishFreeFormDescription = enDesc;
                                }
                                else
                                {
                                    englishFreeFormDescription = draftDependentOption.FreeFormFieldDescription;
                                }
                            }
                            
                            var dependentOption = DependentMultipleChoiceOption.Create(
                                englishDepOptionName,
                                draftDependentOption.SortOrder,
                                draftDependentOption.HasFreeFormField,
                                option.Id,
                                englishFreeFormDescription);

                            db.Add(dependentOption);
                            await db.SaveChangesAsync();

                            // Save dependent option translations
                            await SaveDependentOptionTranslations(db, dependentOption.Id, draftDependentOption.Name, draftDependentOption.FreeFormFieldDescription, draftDependentOption.NameTranslations, draftDependentOption.FreeFormFieldDescriptionTranslations);

                            var excludedDependentOptionProperties = new List<string> { nameof(dependentOption.MultipleChoiceOptionId), nameof(dependentOption.MultipleChoiceOption) };
                            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Dependent Option created for option {option.Name}: ", dependentOption, excludedDependentOptionProperties);
                        }

                        await db.SaveChangesAsync();
                    }
                }

                await db.SaveChangesAsync();
            }
        }

        await db.SaveChangesAsync();

        // Create Question Groups
        foreach (var draftQuestionGroup in values.QuestionGroups)
        {
            // Entity properties always contain English values, regardless of primary language setting
            string englishGroupName;
            string? englishGroupDescription;
            
            if (primaryLanguage.StartsWith("en"))
            {
                // Primary language is English, so draftQuestionGroup.Name contains English
                englishGroupName = draftQuestionGroup.Name ?? "";
                englishGroupDescription = draftQuestionGroup.Description;
            }
            else
            {
                // Primary language is Spanish, so get English from translations dictionary
                var englishCulture = enabledLanguages.FirstOrDefault(l => l.StartsWith("en"));
                if (englishCulture != null && draftQuestionGroup.NameTranslations.TryGetValue(englishCulture, out var enName))
                {
                    englishGroupName = enName;
                }
                else
                {
                    // Fallback to draftQuestionGroup.Name if English translation not found
                    englishGroupName = draftQuestionGroup.Name ?? "";
                }
                
                if (englishCulture != null && draftQuestionGroup.DescriptionTranslations.TryGetValue(englishCulture, out var enDesc))
                {
                    englishGroupDescription = enDesc;
                }
                else
                {
                    englishGroupDescription = draftQuestionGroup.Description;
                }
            }
            
            var questionGroup = QuestionGroup.Create(
                englishGroupName,
                draftQuestionGroup.SortOrder,
                questionnaire.Id,
                englishGroupDescription);

            db.Add(questionGroup);
            await db.SaveChangesAsync();

            // Save question group translations
            await SaveQuestionGroupTranslations(db, questionGroup.Id, draftQuestionGroup.Name!, draftQuestionGroup.Description, draftQuestionGroup.NameTranslations, draftQuestionGroup.DescriptionTranslations);

            var excludedQuestionGroupProperties = new List<string> { nameof(questionGroup.QuestionnaireId), nameof(questionGroup.Questions), nameof(questionGroup.Questionnaire) };
            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Question group created for questionnaire {questionnaire.Name}: ", questionGroup, excludedQuestionGroupProperties);

            // Create Grouped Questions
            foreach (var draftQuestion in draftQuestionGroup.Questions)
            {
                // Entity properties always contain English values, regardless of primary language setting
                string englishQuestionName;
                string? englishQuestionDescription;
                
                if (primaryLanguage.StartsWith("en"))
                {
                    // Primary language is English, so draftQuestion.Name contains English
                    englishQuestionName = draftQuestion.Name ?? "";
                    englishQuestionDescription = draftQuestion.Description;
                }
                else
                {
                    // Primary language is Spanish, so get English from translations dictionary
                    var englishCulture = enabledLanguages.FirstOrDefault(l => l.StartsWith("en"));
                    if (englishCulture != null && draftQuestion.NameTranslations.TryGetValue(englishCulture, out var enName))
                    {
                        englishQuestionName = enName;
                    }
                    else
                    {
                        // Fallback to draftQuestion.Name if English translation not found
                        englishQuestionName = draftQuestion.Name ?? "";
                    }
                    
                    if (englishCulture != null && draftQuestion.DescriptionTranslations.TryGetValue(englishCulture, out var enDesc))
                    {
                        englishQuestionDescription = enDesc;
                    }
                    else
                    {
                        englishQuestionDescription = draftQuestion.Description;
                    }
                }
                
                var question = Question.Create(
                    questionnaire.Id,
                    englishQuestionName,
                    draftQuestion.IsRequired,
                    draftQuestion.SortOrder,
                    draftQuestion.Type,
                    englishQuestionDescription,
                    questionGroup.Id);

                db.Add(question);
                await db.SaveChangesAsync();

                // Save question translations
                await SaveQuestionTranslations(db, question.Id, draftQuestion.Name, draftQuestion.Description, draftQuestion.NameTranslations, draftQuestion.DescriptionTranslations);

                // Create multiple choice options
                if (draftQuestion.Type is QuestionType.SingleSelect or QuestionType.MultipleSelect &&
                    draftQuestion.MultipleChoiceOptions is not null &&
                    draftQuestion.MultipleChoiceOptions.Any())
                {
                    foreach (var draftOption in draftQuestion.MultipleChoiceOptions!)
                    {
                        // Entity properties always contain English values, regardless of primary language setting
                        string englishOptionName;
                        string? englishDependentQuestionName;
                        
                        if (primaryLanguage.StartsWith("en"))
                        {
                            // Primary language is English
                            englishOptionName = draftOption.Name ?? "";
                            englishDependentQuestionName = draftOption.DependentQuestionName;
                        }
                        else
                        {
                            // Primary language is Spanish, so get English from translations dictionary
                            var englishCulture = enabledLanguages.FirstOrDefault(l => l.StartsWith("en"));
                            if (englishCulture != null && draftOption.NameTranslations.TryGetValue(englishCulture, out var enName))
                            {
                                englishOptionName = enName;
                            }
                            else
                            {
                                englishOptionName = draftOption.Name ?? "";
                            }
                            
                            if (englishCulture != null && draftOption.DependentQuestionNameTranslations.TryGetValue(englishCulture, out var enDepName))
                            {
                                englishDependentQuestionName = enDepName;
                            }
                            else
                            {
                                englishDependentQuestionName = draftOption.DependentQuestionName;
                            }
                        }
                        
                        var option = MultipleChoiceOption.Create(
                            englishOptionName,
                            draftOption.SortOrder,
                            draftOption.DependentQuestionType,
                            question.Id,
                            englishDependentQuestionName);

                        db.Add(option);
                        await db.SaveChangesAsync();

                        // Save option translations
                        await SaveOptionTranslations(db, option.Id, draftOption.Name, draftOption.DependentQuestionName, draftOption.NameTranslations, draftOption.DependentQuestionNameTranslations);

                        var excludedQuestionProperties = new List<string> { nameof(question.QuestionnaireId), nameof(question.QuestionGroupId), nameof(question.MultipleChoiceOptions), nameof(question.Questionnaire), nameof(question.QuestionGroup) };
                        await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Grouped Question created for questionnaire {questionnaire.Name}: ", question, excludedQuestionProperties);

                        if (draftOption.HasDependentQuestion &&
                            draftOption.DependentQuestionType is DependentQuestionType.MultipleSelect or DependentQuestionType.SingleSelect &&
                            draftOption.DependentMultipleChoiceOptions is not null &&
                            draftOption.DependentMultipleChoiceOptions.Any())
                        {
                            foreach (var draftDependentOption in draftOption.DependentMultipleChoiceOptions!)
                            {
                                // Entity properties always contain English values, regardless of primary language setting
                                string englishDepOptionName;
                                string? englishFreeFormDescription;
                                
                                if (primaryLanguage.StartsWith("en"))
                                {
                                    // Primary language is English
                                    englishDepOptionName = draftDependentOption.Name ?? "";
                                    englishFreeFormDescription = draftDependentOption.FreeFormFieldDescription;
                                }
                                else
                                {
                                    // Primary language is Spanish, so get English from translations dictionary
                                    var englishCulture = enabledLanguages.FirstOrDefault(l => l.StartsWith("en"));
                                    if (englishCulture != null && draftDependentOption.NameTranslations.TryGetValue(englishCulture, out var enName))
                                    {
                                        englishDepOptionName = enName;
                                    }
                                    else
                                    {
                                        englishDepOptionName = draftDependentOption.Name ?? "";
                                    }
                                    
                                    if (englishCulture != null && draftDependentOption.FreeFormFieldDescriptionTranslations.TryGetValue(englishCulture, out var enDesc))
                                    {
                                        englishFreeFormDescription = enDesc;
                                    }
                                    else
                                    {
                                        englishFreeFormDescription = draftDependentOption.FreeFormFieldDescription;
                                    }
                                }
                                
                                var dependentOption = DependentMultipleChoiceOption.Create(
                                    englishDepOptionName,
                                    draftDependentOption.SortOrder,
                                    draftDependentOption.HasFreeFormField,
                                    option.Id,
                                    englishFreeFormDescription);

                                db.Add(dependentOption);
                                await db.SaveChangesAsync();

                                // Save dependent option translations
                                await SaveDependentOptionTranslations(db, dependentOption.Id, draftDependentOption.Name, draftDependentOption.FreeFormFieldDescription, draftDependentOption.NameTranslations, draftDependentOption.FreeFormFieldDescriptionTranslations);

                                var excludedDependentOptionProperties = new List<string> { nameof(dependentOption.MultipleChoiceOptionId), nameof(dependentOption.MultipleChoiceOption) };
                                await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Dependent Option created for option {option.Name}: ", dependentOption, excludedDependentOptionProperties);
                            }
                            await db.SaveChangesAsync();
                        }
                    }

                    await db.SaveChangesAsync();
                }
            }

            await db.SaveChangesAsync();
        }

        // Create Application Type Links
        foreach (var appTypeCheckbox in values.ApplicationTypes.Where(x => x.IsChecked))
        {
            var link = QuestionnaireApplicationTypeLink.Create(
                questionnaire.Id,
                appTypeCheckbox.Id);

            db.Add(link);
            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Application type {appTypeCheckbox.DisplayName} was linked to questionnaire {questionnaire.Id}");
        }

        await db.SaveChangesAsync();

        if (values.Level == QuestionnaireLevel.Product)
        {
            // Create Share Product Links
            foreach (var productCheckbox in values.Products
                         .Where(x => x.Type == QuestionnaireForm.ProductType.Share)
                         .Where(x => x.IsChecked))
            {
                var link = QuestionnaireShareProductLink.Create(
                    questionnaire.Id,
                    productCheckbox.Id);

                db.Add(link);
                await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Share product {productCheckbox.DisplayName} was linked to questionnaire {questionnaire.Id}");
            }

            // Create Loan Product Links
            foreach (var productCheckbox in values.Products
                         .Where(x => x.Type == QuestionnaireForm.ProductType.Loan)
                         .Where(x => x.IsChecked))
            {
                var link = QuestionnaireLoanProductLink.Create(
                    questionnaire.Id,
                    productCheckbox.Id);

                db.Add(link);
                await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Loan product {productCheckbox.DisplayName} was linked to questionnaire {questionnaire.Id}");
            }

            await db.SaveChangesAsync();
        }

        // Entity properties always contain English values, regardless of primary language setting
        // When primary language is English: values.Name contains English
        // When primary language is Spanish: values.NameTranslations["en-US"] contains English
        string englishName;
        string? englishDescription;
        
        if (primaryLanguage.StartsWith("en"))
        {
            // Primary language is English, so values.Name contains English
            englishName = values.Name ?? "";
            englishDescription = values.Description;
        }
        else
        {
            // Primary language is Spanish, so get English from translations dictionary
            var englishCulture = enabledLanguages.FirstOrDefault(l => l.StartsWith("en"));
            if (englishCulture != null && values.NameTranslations.TryGetValue(englishCulture, out var enName))
            {
                englishName = enName;
            }
            else
            {
                // Fallback to values.Name if English translation not found (shouldn't happen, but safety check)
                englishName = values.Name ?? "";
            }
            
            if (englishCulture != null && values.DescriptionTranslations.TryGetValue(englishCulture, out var enDesc))
            {
                englishDescription = enDesc;
            }
            else
            {
                englishDescription = values.Description;
            }
        }
        
        questionnaire.Update(englishName, values.IsEnabled, values.IsRequired, values.Level, englishDescription);
        questionnaire.BumpVersion();

        await db.SaveChangesAsync();

        // Save translations to LocalizationStrings table
        var resourceKey = $"Questionnaire.{questionnaireId}";
        
        // Get all cultures from database
        var cultures = await db.Set<LocalizationCulture>().ToListAsync();
        var cultureMap = cultures.ToDictionary(c => c.Culture, c => c.Id);
        
        // Save Name translations from QuestionnaireForm.Input
        foreach (var translation in values.NameTranslations)
        {
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                continue; // Skip if culture doesn't exist
            }
            
            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Name");
            
            if (existing != null)
            {
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Name",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }
        
        // Save primary language Name to database if primary is not English
        // (When primary is English, it's saved in the entity property, not in LocalizationStrings)
        if (!primaryLanguage.StartsWith("en"))
        {
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Name");
                
                if (existing != null)
                {
                    existing.UpdateDefault(values.Name ?? "");
                }
                else
                {
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Name",
                        defaultText: values.Name ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
        }
        
        // Save Description translations from QuestionnaireForm.Input
        foreach (var translation in values.DescriptionTranslations)
        {
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                continue; // Skip if culture doesn't exist
            }
            
            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Description");
            
            if (existing != null)
            {
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Description",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }
        
        // Save primary language Description to database if primary is not English
        // (When primary is English, it's saved in the entity property, not in LocalizationStrings)
        if (!primaryLanguage.StartsWith("en"))
        {
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Description");
                
                if (existing != null)
                {
                    existing.UpdateDefault(values.Description ?? "");
                }
                else
                {
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Description",
                        defaultText: values.Description ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
        }

        await db.SaveChangesAsync();

        // Update cache with saved translations
        foreach (var translation in values.NameTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "Name", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en") && cultureMap.TryGetValue(primaryLanguage, out _))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "Name", values.Name ?? "");
        }
        foreach (var translation in values.DescriptionTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "Description", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en") && cultureMap.TryGetValue(primaryLanguage, out _))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "Description", values.Description ?? "");
        }

        var excludedProperties = new List<string> { nameof(questionnaire.Questions), nameof(questionnaire.QuestionGroups), nameof(questionnaire.QuestionnaireResponses),
                nameof(questionnaire.QuestionnaireShareProductLinks), nameof(questionnaire.QuestionnaireApplicationTypeLinks), nameof(questionnaire.QuestionnaireLoanProductLinks) };
        if (AdminUser != null)
        {
            await adminActivityService.TrackAdminUserActivityAsync(AdminUser, AdminActivityType.Questionnaires, $"Questionnaire Id: {questionnaire.Id} was edited: ", oldConfig, questionnaire, excludedProperties);
        }
    }

    // Translation saving helper methods
    private async Task SaveQuestionTranslations(AlohaDb db, int questionId, string name, string? description, Dictionary<string, string> nameTranslations, Dictionary<string, string> descriptionTranslations)
    {
        var resourceKey = $"Question.{questionId}";
        var cultures = await db.Set<LocalizationCulture>().ToListAsync();
        var cultureMap = cultures.ToDictionary(c => c.Culture, c => c.Id);
        var primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
        
        Console.WriteLine($"[SaveQuestionTranslations] QuestionId: {questionId}, PrimaryLanguage: {primaryLanguage}");
        Console.WriteLine($"[SaveQuestionTranslations] name parameter (primary language value): '{name}'");
        Console.WriteLine($"[SaveQuestionTranslations] nameTranslations dictionary: {string.Join(", ", nameTranslations.Select(kvp => $"{kvp.Key}='{kvp.Value}'"))}");
        Console.WriteLine($"[SaveQuestionTranslations] description parameter (primary language value): '{description}'");
        Console.WriteLine($"[SaveQuestionTranslations] descriptionTranslations dictionary: {string.Join(", ", descriptionTranslations.Select(kvp => $"{kvp.Key}='{kvp.Value}'"))}");

        // Save Name translations (excluding primary language - it's saved separately)
        foreach (var translation in nameTranslations)
        {
            // Skip primary language - it's saved separately below
            if (translation.Key == primaryLanguage)
            {
                Console.WriteLine($"[SaveQuestionTranslations] Skipping primary language '{translation.Key}' from nameTranslations dictionary");
                continue;
            }
            
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                Console.WriteLine($"[SaveQuestionTranslations] Culture '{translation.Key}' not found in cultureMap");
                continue;
            }

            Console.WriteLine($"[SaveQuestionTranslations] Saving Name translation: {translation.Key} = '{translation.Value}'");
            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Name");

            if (existing != null)
            {
                Console.WriteLine($"[SaveQuestionTranslations] Updating existing Name translation for {translation.Key}");
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                Console.WriteLine($"[SaveQuestionTranslations] Creating new Name translation for {translation.Key}");
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Name",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }

        // Save primary language Name if not English
        if (!primaryLanguage.StartsWith("en"))
        {
            Console.WriteLine($"[SaveQuestionTranslations] Saving primary language ({primaryLanguage}) Name: '{name}'");
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Name");

                if (existing != null)
                {
                    Console.WriteLine($"[SaveQuestionTranslations] Updating existing primary language Name translation");
                    existing.UpdateDefault(name ?? "");
                }
                else
                {
                    Console.WriteLine($"[SaveQuestionTranslations] Creating new primary language Name translation");
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Name",
                        defaultText: name ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
            else
            {
                Console.WriteLine($"[SaveQuestionTranslations] ERROR: Primary language '{primaryLanguage}' not found in cultureMap!");
            }
        }
        else
        {
            Console.WriteLine($"[SaveQuestionTranslations] Primary language is English, Name saved to entity property, not LocalizationStrings");
        }

        // Save Description translations (excluding primary language - it's saved separately)
        foreach (var translation in descriptionTranslations)
        {
            // Skip primary language - it's saved separately below
            if (translation.Key == primaryLanguage)
            {
                Console.WriteLine($"[SaveQuestionTranslations] Skipping primary language '{translation.Key}' from descriptionTranslations dictionary");
                continue;
            }
            
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                Console.WriteLine($"[SaveQuestionTranslations] Culture '{translation.Key}' not found in cultureMap for Description");
                continue;
            }

            Console.WriteLine($"[SaveQuestionTranslations] Saving Description translation: {translation.Key} = '{translation.Value}'");
            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Description");

            if (existing != null)
            {
                Console.WriteLine($"[SaveQuestionTranslations] Updating existing Description translation for {translation.Key}");
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                Console.WriteLine($"[SaveQuestionTranslations] Creating new Description translation for {translation.Key}");
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Description",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }

        // Save primary language Description if not English
        if (!primaryLanguage.StartsWith("en") && !string.IsNullOrWhiteSpace(description))
        {
            Console.WriteLine($"[SaveQuestionTranslations] Saving primary language ({primaryLanguage}) Description: '{description}'");
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Description");

                if (existing != null)
                {
                    Console.WriteLine($"[SaveQuestionTranslations] Updating existing primary language Description translation");
                    existing.UpdateDefault(description ?? "");
                }
                else
                {
                    Console.WriteLine($"[SaveQuestionTranslations] Creating new primary language Description translation");
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Description",
                        defaultText: description ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
            else
            {
                Console.WriteLine($"[SaveQuestionTranslations] ERROR: Primary language '{primaryLanguage}' not found in cultureMap for Description!");
            }
        }
        else if (primaryLanguage.StartsWith("en"))
        {
            Console.WriteLine($"[SaveQuestionTranslations] Primary language is English, Description saved to entity property, not LocalizationStrings");
        }

        Console.WriteLine($"[SaveQuestionTranslations] Calling SaveChangesAsync...");
        await db.SaveChangesAsync();
        Console.WriteLine($"[SaveQuestionTranslations] SaveChangesAsync completed");
        
        // Update cache with saved translations
        foreach (var translation in nameTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "Name", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en"))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "Name", name ?? "");
        }
        foreach (var translation in descriptionTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "Description", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en") && !string.IsNullOrWhiteSpace(description))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "Description", description ?? "");
        }
    }

    private async Task SaveQuestionGroupTranslations(AlohaDb db, int groupId, string name, string? description, Dictionary<string, string> nameTranslations, Dictionary<string, string> descriptionTranslations)
    {
        var resourceKey = $"QuestionGroup.{groupId}";
        var cultures = await db.Set<LocalizationCulture>().ToListAsync();
        var cultureMap = cultures.ToDictionary(c => c.Culture, c => c.Id);
        var primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();

        // Save Name translations (excluding primary language - it's saved separately)
        foreach (var translation in nameTranslations)
        {
            // Skip primary language - it's saved separately below
            if (translation.Key == primaryLanguage)
            {
                continue;
            }
            
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                continue;
            }

            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Name");

            if (existing != null)
            {
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Name",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }

        // Save primary language Name if not English
        if (!primaryLanguage.StartsWith("en"))
        {
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Name");

                if (existing != null)
                {
                    existing.UpdateDefault(name ?? "");
                }
                else
                {
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Name",
                        defaultText: name ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
        }

        // Save Description translations (excluding primary language - it's saved separately)
        foreach (var translation in descriptionTranslations)
        {
            // Skip primary language - it's saved separately below
            if (translation.Key == primaryLanguage)
            {
                continue;
            }
            
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                continue;
            }

            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Description");

            if (existing != null)
            {
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Description",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }

        // Save primary language Description if not English
        if (!primaryLanguage.StartsWith("en") && !string.IsNullOrWhiteSpace(description))
        {
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Description");

                if (existing != null)
                {
                    existing.UpdateDefault(description ?? "");
                }
                else
                {
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Description",
                        defaultText: description ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
        }

        await db.SaveChangesAsync();
        
        // Update cache with saved translations
        foreach (var translation in nameTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "Name", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en"))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "Name", name ?? "");
        }
        foreach (var translation in descriptionTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "Description", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en") && !string.IsNullOrWhiteSpace(description))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "Description", description ?? "");
        }
    }

    private async Task SaveOptionTranslations(AlohaDb db, int optionId, string name, string? dependentQuestionName, Dictionary<string, string> nameTranslations, Dictionary<string, string> dependentQuestionNameTranslations)
    {
        var resourceKey = $"MultipleChoiceOption.{optionId}";
        var cultures = await db.Set<LocalizationCulture>().ToListAsync();
        var cultureMap = cultures.ToDictionary(c => c.Culture, c => c.Id);
        var primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();

        // Save Name translations (excluding primary language - it's saved separately)
        foreach (var translation in nameTranslations)
        {
            // Skip primary language - it's saved separately below
            if (translation.Key == primaryLanguage)
            {
                continue;
            }
            
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                continue;
            }

            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Name");

            if (existing != null)
            {
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Name",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }

        // Save primary language Name if not English
        if (!primaryLanguage.StartsWith("en"))
        {
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Name");

                if (existing != null)
                {
                    existing.UpdateDefault(name ?? "");
                }
                else
                {
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Name",
                        defaultText: name ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
        }

        // Save DependentQuestionName translations (excluding primary language - it's saved separately)
        foreach (var translation in dependentQuestionNameTranslations)
        {
            // Skip primary language - it's saved separately below
            if (translation.Key == primaryLanguage)
            {
                continue;
            }
            
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                continue;
            }

            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "DependentQuestionName");

            if (existing != null)
            {
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "DependentQuestionName",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }

        // Save primary language DependentQuestionName if not English
        if (!primaryLanguage.StartsWith("en") && !string.IsNullOrWhiteSpace(dependentQuestionName))
        {
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "DependentQuestionName");

                if (existing != null)
                {
                    existing.UpdateDefault(dependentQuestionName ?? "");
                }
                else
                {
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "DependentQuestionName",
                        defaultText: dependentQuestionName ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
        }

        await db.SaveChangesAsync();
        
        // Update cache with saved translations
        foreach (var translation in nameTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "Name", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en"))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "Name", name ?? "");
        }
        foreach (var translation in dependentQuestionNameTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "DependentQuestionName", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en") && !string.IsNullOrWhiteSpace(dependentQuestionName))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "DependentQuestionName", dependentQuestionName ?? "");
        }
    }

    private async Task SaveDependentOptionTranslations(AlohaDb db, int dependentOptionId, string name, string? freeFormDescription, Dictionary<string, string> nameTranslations, Dictionary<string, string> freeFormDescriptionTranslations)
    {
        var resourceKey = $"DependentMultipleChoiceOption.{dependentOptionId}";
        var cultures = await db.Set<LocalizationCulture>().ToListAsync();
        var cultureMap = cultures.ToDictionary(c => c.Culture, c => c.Id);
        var primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();

        // Save Name translations (excluding primary language - it's saved separately)
        foreach (var translation in nameTranslations)
        {
            // Skip primary language - it's saved separately below
            if (translation.Key == primaryLanguage)
            {
                continue;
            }
            
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                continue;
            }

            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Name");

            if (existing != null)
            {
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Name",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }

        // Save primary language Name if not English
        if (!primaryLanguage.StartsWith("en"))
        {
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Name");

                if (existing != null)
                {
                    existing.UpdateDefault(name ?? "");
                }
                else
                {
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Name",
                        defaultText: name ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
        }

        // Save FreeFormFieldDescription translations (excluding primary language - it's saved separately)
        foreach (var translation in freeFormDescriptionTranslations)
        {
            // Skip primary language - it's saved separately below
            if (translation.Key == primaryLanguage)
            {
                continue;
            }
            
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                continue;
            }

            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "FreeFormFieldDescription");

            if (existing != null)
            {
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "FreeFormFieldDescription",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }

        // Save primary language FreeFormFieldDescription if not English
        if (!primaryLanguage.StartsWith("en") && !string.IsNullOrWhiteSpace(freeFormDescription))
        {
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "FreeFormFieldDescription");

                if (existing != null)
                {
                    existing.UpdateDefault(freeFormDescription ?? "");
                }
                else
                {
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "FreeFormFieldDescription",
                        defaultText: freeFormDescription ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
        }

        await db.SaveChangesAsync();
        
        // Update cache with saved translations
        foreach (var translation in nameTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "Name", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en"))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "Name", name ?? "");
        }
        foreach (var translation in freeFormDescriptionTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "FreeFormFieldDescription", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en") && !string.IsNullOrWhiteSpace(freeFormDescription))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "FreeFormFieldDescription", freeFormDescription ?? "");
        }
    }

    private static async Task DeleteQuestionnaireLinkedEntities(AlohaDb db, int questionnaireId)
    {
        var questionnaire = await db.Questionnaires
            .Include(questionnaire => questionnaire.QuestionGroups)
            .Include(questionnaire => questionnaire.QuestionnaireApplicationTypeLinks)
            .Include(questionnaire => questionnaire.QuestionnaireShareProductLinks)
            .Include(questionnaire => questionnaire.QuestionnaireLoanProductLinks)
            .Include(questionnaire => questionnaire.Questions)!
            .ThenInclude(question => question.MultipleChoiceOptions)!
            .ThenInclude(multipleChoiceOption => multipleChoiceOption.DependentMultipleChoiceOptions)
            .FirstAsync(q => q.Id == questionnaireId);

        if (questionnaire.Questions != null)
        {
            foreach (var question in questionnaire.Questions)
            {
                if (question.MultipleChoiceOptions != null)
                {
                    foreach (var option in question.MultipleChoiceOptions)
                    {
                        if (option.DependentMultipleChoiceOptions != null)
                        {
                            foreach (var depOption in option.DependentMultipleChoiceOptions)
                            {
                                db.Remove(depOption);
                            }
                        }
                        db.Remove(option);
                    }
                }
                db.Remove(question);
            }
        }

        if (questionnaire.QuestionGroups != null)
        {
            foreach (var group in questionnaire.QuestionGroups)
            {
                db.Remove(group);
            }
        }

        if (questionnaire.QuestionnaireApplicationTypeLinks != null)
        {
            foreach (var link in questionnaire.QuestionnaireApplicationTypeLinks)
            {
                db.Remove(link);
            }
        }

        if (questionnaire.QuestionnaireShareProductLinks != null)
        {
            foreach (var link in questionnaire.QuestionnaireShareProductLinks)
            {
                db.Remove(link);
            }
        }

        if (questionnaire.QuestionnaireLoanProductLinks != null)
        {
            foreach (var link in questionnaire.QuestionnaireLoanProductLinks)
            {
                db.Remove(link);
            }
        }

        await db.SaveChangesAsync();
    }
}