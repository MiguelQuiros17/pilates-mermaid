@page "/customization/questionnaires/edit/{Id:int}"
@using Aloha.Domain.Questionnaires
@using Microsoft.AspNetCore.Authorization
@using Aloha.Domain.Services.AdminAudit
@using Aloha.Domain.Identity.AdminUsers.Activities
@using Aloha.Domain.Identity.AdminUsers
@using Microsoft.AspNetCore.Identity
@using Aloha.Domain.Services.Translations
@using System.Globalization
@using Aloha.Domain.Localization
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Roles = "MahaloAdmin, MasterAdmin, FormManager, Audit")]
@inject AuthenticationStateProvider authStateProvider
@inject IDbContextFactory<AlohaDb> DbFactory
@inject NavigationManager Nav
@inject IAdminActivityService adminActivityService
@inject UserManager<AdminUser> UserManager
@inject ITranslationHelper TranslationHelper
@inject ILanguageConfigurationService LanguageConfigService
@rendermode InteractiveServer

<h3>Edit Questionnaire</h3>
<p>Submission of this form will update an existing questionnaire</p>
<p class="form-text">* Indicate Required Fields</p>
@if (questionnaireToEdit is not null)
{
    @* BulkTranslateButton includes the language selector *@
    @if (isMultiLanguageEnabled)
    {
        <BulkTranslateButton @ref="bulkTranslateButton"
                            SelectedCulture="@bulkSelectedCulture"
                            SelectedCultureChanged="@OnBulkCultureChanged"
                            OnBulkTranslate="@OnBulkTranslateAll"
                            OnBulkTranslateAllLanguages="@OnBulkTranslateAllLanguages"
                            GetFieldsWithExistingText="@GetFieldsWithExistingText"
                            HasEnglishTextFunc="@HasEnglishText"
                            FieldIdPrefix="questionnaire" />
    }

    <QuestionnaireForm 
    @ref="qForm"
    InitialValues="questionnaireToEdit"
    IsReadOnly="isReadOnly"
    SelectedCulture="@bulkSelectedCulture"
    OnCancel="HandleCancel"
    OnSubmit="HandleSubmit"
    />
}

@code {

    [Parameter]
    public int Id { get; set; }

    private Questionnaire? questionnaireToEdit;
    private QuestionnaireForm? qForm;
    private bool isReadOnly = true;
    private AdminUser? AdminUser = default!;
    private string bulkSelectedCulture = "en-US"; // Will be initialized to primary language
    private string primaryLanguage = "en-US";
    private bool isMultiLanguageEnabled = false;
    private List<string> availableLanguages = new();
    private Dictionary<string, string> languageDisplayNames = new();
    private BulkTranslateButton? bulkTranslateButton;

    protected override async Task OnInitializedAsync()
    {
        await CheckRoleAndUpdateReadOnlyFlagAsync();
        primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
        bulkSelectedCulture = primaryLanguage;
        isMultiLanguageEnabled = await LanguageConfigService.IsMultiLanguageEnabledAsync();
        
        // Load available languages and display names
        if (isMultiLanguageEnabled)
        {
            var allEnabledLanguages = await LanguageConfigService.GetEnabledLanguagesAsync();
            availableLanguages = allEnabledLanguages.Where(l => l != primaryLanguage).ToList();
            
            languageDisplayNames = new Dictionary<string, string>();
            languageDisplayNames[primaryLanguage] = await LanguageConfigService.GetLanguageDisplayNameAsync(primaryLanguage);
            foreach (var lang in availableLanguages)
            {
                languageDisplayNames[lang] = await LanguageConfigService.GetLanguageDisplayNameAsync(lang);
            }
        }
        
        await using var db = await DbFactory.CreateDbContextAsync();

        questionnaireToEdit = await db.Questionnaires
            .Include(questionnaire => questionnaire.Questions)!
            .ThenInclude(question => question.MultipleChoiceOptions)!
            .ThenInclude(multipleChoiceOption => multipleChoiceOption.DependentMultipleChoiceOptions)
            .Include(questionnaire => questionnaire.QuestionGroups)
            .Include(questionnaire => questionnaire.QuestionnaireApplicationTypeLinks)
            .Include(questionnaire => questionnaire.QuestionnaireShareProductLinks)
            .Include(questionnaire => questionnaire.QuestionnaireLoanProductLinks)
            .FirstOrDefaultAsync(q => q.Id == Id);

        if (questionnaireToEdit is null)
        {
            Nav.NavigateTo("/customization/questionnaires");
            return;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
            bulkSelectedCulture = primaryLanguage;
            StateHasChanged();
        }
    }

    private async Task CheckRoleAndUpdateReadOnlyFlagAsync()
    {
        var authUser = (await authStateProvider.GetAuthenticationStateAsync()).User;
        AdminUser = await UserManager.FindByEmailAsync(authUser.Identity!.Name!);

        isReadOnly = !(
            authUser.IsInRole("MahaloAdmin") ||
            authUser.IsInRole("MasterAdmin") ||
            authUser.IsInRole("FormManager"));
    }

    private void HandleCancel()
    {
        Nav.NavigateTo("/customization/questionnaires");
    }

    private async Task OnLanguageChanged()
    {
        StateHasChanged();
    }

    private async Task OnBulkCultureChanged(string culture)
    {
        bulkSelectedCulture = culture;
        StateHasChanged();
    }

    private bool HasEnglishText()
    {
        // Check if questionnaire has English text
        if (questionnaireToEdit == null) return false;
        
        return !string.IsNullOrWhiteSpace(questionnaireToEdit.Name) ||
               !string.IsNullOrWhiteSpace(questionnaireToEdit.Description);
    }

    private List<string> GetFieldsWithExistingText()
    {
        var fields = new List<string>();
        if (questionnaireToEdit == null) return fields;
        
        // This would need to check all nested fields - for now, just return empty
        // The bulk translate functionality can be enhanced later if needed
        return fields;
    }

    private async Task OnBulkTranslateAll()
    {
        bulkTranslateButton?.ClearError();
        // Bulk translate functionality would go here
        // For now, just a placeholder
        await Task.CompletedTask;
    }

    private async Task OnBulkTranslateAllLanguages()
    {
        bulkTranslateButton?.ClearError();
        // Bulk translate all languages functionality would go here
        // For now, just a placeholder
        await Task.CompletedTask;
    }

    // Translation loading helper methods for nested entities
    public static async Task<Dictionary<string, string>> LoadQuestionTranslations(IDbContextFactory<AlohaDb> dbFactory, int questionId, string fieldKey, string primaryLanguage, List<string> enabledLanguages)
    {
        await using var db = await dbFactory.CreateDbContextAsync();
        var resourceKey = $"Question.{questionId}";
        
        var translations = await db.Set<LocalizationString>()
            .Where(s => s.ResourceKey == resourceKey && s.Key == fieldKey)
            .Include(s => s.LocalizationCulture)
            .ToListAsync();
        
        var result = new Dictionary<string, string>();
        
        foreach (var trans in translations)
        {
            var culture = trans.LocalizationCulture?.Culture;
            if (string.IsNullOrWhiteSpace(culture) || culture == primaryLanguage || !enabledLanguages.Contains(culture))
            {
                continue;
            }
            
            result[culture] = trans.DefaultText ?? "";
        }
        
        return result;
    }

    public static async Task<Dictionary<string, string>> LoadQuestionGroupTranslations(IDbContextFactory<AlohaDb> dbFactory, int groupId, string fieldKey, string primaryLanguage, List<string> enabledLanguages)
    {
        await using var db = await dbFactory.CreateDbContextAsync();
        var resourceKey = $"QuestionGroup.{groupId}";
        
        var translations = await db.Set<LocalizationString>()
            .Where(s => s.ResourceKey == resourceKey && s.Key == fieldKey)
            .Include(s => s.LocalizationCulture)
            .ToListAsync();
        
        var result = new Dictionary<string, string>();
        
        foreach (var trans in translations)
        {
            var culture = trans.LocalizationCulture?.Culture;
            if (string.IsNullOrWhiteSpace(culture) || culture == primaryLanguage || !enabledLanguages.Contains(culture))
            {
                continue;
            }
            
            result[culture] = trans.DefaultText ?? "";
        }
        
        return result;
    }

    public static async Task<Dictionary<string, string>> LoadOptionTranslations(IDbContextFactory<AlohaDb> dbFactory, int optionId, string fieldKey, string primaryLanguage, List<string> enabledLanguages)
    {
        await using var db = await dbFactory.CreateDbContextAsync();
        var resourceKey = $"MultipleChoiceOption.{optionId}";
        
        var translations = await db.Set<LocalizationString>()
            .Where(s => s.ResourceKey == resourceKey && s.Key == fieldKey)
            .Include(s => s.LocalizationCulture)
            .ToListAsync();
        
        var result = new Dictionary<string, string>();
        
        foreach (var trans in translations)
        {
            var culture = trans.LocalizationCulture?.Culture;
            if (string.IsNullOrWhiteSpace(culture) || culture == primaryLanguage || !enabledLanguages.Contains(culture))
            {
                continue;
            }
            
            result[culture] = trans.DefaultText ?? "";
        }
        
        return result;
    }

    public static async Task<Dictionary<string, string>> LoadDependentOptionTranslations(IDbContextFactory<AlohaDb> dbFactory, int dependentOptionId, string fieldKey, string primaryLanguage, List<string> enabledLanguages)
    {
        await using var db = await dbFactory.CreateDbContextAsync();
        var resourceKey = $"DependentMultipleChoiceOption.{dependentOptionId}";
        
        var translations = await db.Set<LocalizationString>()
            .Where(s => s.ResourceKey == resourceKey && s.Key == fieldKey)
            .Include(s => s.LocalizationCulture)
            .ToListAsync();
        
        var result = new Dictionary<string, string>();
        
        foreach (var trans in translations)
        {
            var culture = trans.LocalizationCulture?.Culture;
            if (string.IsNullOrWhiteSpace(culture) || culture == primaryLanguage || !enabledLanguages.Contains(culture))
            {
                continue;
            }
            
            result[culture] = trans.DefaultText ?? "";
        }
        
        return result;
    }

    private async Task HandleSubmit(QuestionnaireForm.Input values)
    {
        Console.WriteLine("[EditQuestionnaire.HandleSubmit] START");
        var nameValue = values.NameField.PrimaryValue ?? "";
        var descValue = values.DescriptionField.PrimaryValue ?? "";
        Console.WriteLine($"[EditQuestionnaire.HandleSubmit] values.Name: '{nameValue}'");
        Console.WriteLine($"[EditQuestionnaire.HandleSubmit] values.Description: '{descValue}'");
        var nameTransStr = string.Join(", ", values.NameField.Translations.Select(kvp => $"{kvp.Key}='{kvp.Value}'"));
        var descTransStr = string.Join(", ", values.DescriptionField.Translations.Select(kvp => $"{kvp.Key}='{kvp.Value}'"));
        Console.WriteLine($"[EditQuestionnaire.HandleSubmit] values.NameTranslations: {nameTransStr}");
        Console.WriteLine($"[EditQuestionnaire.HandleSubmit] values.DescriptionTranslations: {descTransStr}");
        
        // Log all questions
        foreach (var question in values.UngroupedQuestions)
        {
            var nameTranslationsArray = question.NameField.Translations.Select(kvp => string.Format("{0}='{1}'", kvp.Key, kvp.Value)).ToArray();
            var nameTranslationsStr = string.Join(", ", (IEnumerable<string>)nameTranslationsArray);
            var questionName = question.NameField.PrimaryValue ?? "";
            Console.WriteLine($"[EditQuestionnaire.HandleSubmit] Ungrouped Question - Name: '{questionName}', NameTranslations: {nameTranslationsStr}");
        }
        
        foreach (var group in values.QuestionGroups)
        {
            var groupNameTranslationsArray = group.NameField.Translations.Select(kvp => string.Format("{0}='{1}'", kvp.Key, kvp.Value)).ToArray();
            var groupNameTranslationsStr = string.Join(", ", (IEnumerable<string>)groupNameTranslationsArray);
            var groupName = group.NameField.PrimaryValue ?? "";
            Console.WriteLine($"[EditQuestionnaire.HandleSubmit] Group - Name: '{groupName}', NameTranslations: {groupNameTranslationsStr}");
            foreach (var question in group.Questions)
            {
                var questionNameTranslationsArray = question.NameField.Translations.Select(kvp => string.Format("{0}='{1}'", kvp.Key, kvp.Value)).ToArray();
                var questionNameTranslationsStr = string.Join(", ", (IEnumerable<string>)questionNameTranslationsArray);
                var questionName2 = question.NameField.PrimaryValue ?? "";
                Console.WriteLine($"[EditQuestionnaire.HandleSubmit] Grouped Question - Name: '{questionName2}', NameTranslations: {questionNameTranslationsStr}");
            }
        }
        
        try
        {
            qForm?.SetSaving(true);
            var questionnaireId = questionnaireToEdit!.Id;
            
            await using var db = await DbFactory.CreateDbContextAsync();
            await DeleteQuestionnaireLinkedEntities(db, questionnaireId);
            Console.WriteLine($"[EditQuestionnaire.HandleSubmit] Calling UpdateQuestionnaire...");
            await UpdateQuestionnaire(db, questionnaireId, values);
            Console.WriteLine($"[EditQuestionnaire.HandleSubmit] UpdateQuestionnaire completed successfully");
            qForm?.Notify(new(ToastType.Success, string.Empty));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[EditQuestionnaire.HandleSubmit] ERROR: {ex.Message}");
            Console.WriteLine($"[EditQuestionnaire.HandleSubmit] StackTrace: {ex.StackTrace}");
            qForm?.Notify(new(ToastType.Warning, string.Empty));
        }
    }

    private async Task UpdateQuestionnaire(AlohaDb db, int questionnaireId, QuestionnaireForm.Input values)
    {
        var questionnaire = await db.Questionnaires
               .Include(q => q.Questions!)
               .ThenInclude(q => q.QuestionGroup)
               .Include(q => q.Questions!)
               .ThenInclude(q => q.MultipleChoiceOptions!)
               .ThenInclude(q => q.DependentMultipleChoiceOptions)
               .Include(q => q.QuestionGroups)
               .Include(questionnaire => questionnaire.QuestionnaireApplicationTypeLinks)
               .Include(questionnaire => questionnaire.QuestionnaireShareProductLinks)
               .Include(questionnaire => questionnaire.QuestionnaireLoanProductLinks)
               .FirstAsync(q => q.Id == questionnaireId);
        var oldConfig = db.Entry(questionnaire).CurrentValues.Clone().ToObject();

        // Get primary language and enabled languages to determine save strategy
        var primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
        var enabledLanguages = await LanguageConfigService.GetEnabledLanguagesAsync();

        // Create Ungrouped Questions
        foreach (var draftQuestion in values.UngroupedQuestions)
        {
            // Entity properties always contain English values, regardless of primary language setting
            string englishQuestionName;
            string? englishQuestionDescription;
            
            // Get English values from MultilingualField
            englishQuestionName = draftQuestion.NameField.Get("en-US", primaryLanguage);
            englishQuestionDescription = draftQuestion.DescriptionField.Get("en-US", primaryLanguage);
            
            Console.WriteLine($"[UpdateQuestionnaire] Final englishQuestionName: '{englishQuestionName}'");
            Console.WriteLine($"[UpdateQuestionnaire] Final englishQuestionDescription: '{englishQuestionDescription}'");
            
            var question = Question.Create(
                questionnaire.Id,
                englishQuestionName,
                draftQuestion.IsRequired,
                draftQuestion.SortOrder,
                draftQuestion.Type,
                englishQuestionDescription,
                questionGroupId: null);

            db.Add(question);
            await db.SaveChangesAsync();

            // Save question translations using MultilingualFieldHelper
            var questionResourceKey = $"Question.{question.Id}";
            await MultilingualFieldHelper.SaveTranslationsAsync(
                draftQuestion.NameField, db, questionResourceKey, "Name", primaryLanguage);
            await MultilingualFieldHelper.SaveTranslationsAsync(
                draftQuestion.DescriptionField, db, questionResourceKey, "Description", primaryLanguage);
            MultilingualFieldHelper.UpdateCache(draftQuestion.NameField, questionResourceKey, "Name", primaryLanguage);
            MultilingualFieldHelper.UpdateCache(draftQuestion.DescriptionField, questionResourceKey, "Description", primaryLanguage);

            var excludedQuestionProperties = new List<string> { nameof(question.QuestionnaireId), nameof(question.QuestionGroupId), nameof(question.MultipleChoiceOptions), nameof(question.Questionnaire), nameof(question.QuestionGroup) };
            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Question created for questionnaire {questionnaire.Name}: ", oldConfig, question, excludedQuestionProperties);

            // Create multiple choice options
            if (draftQuestion.Type is QuestionType.SingleSelect or QuestionType.MultipleSelect &&
                draftQuestion.MultipleChoiceOptions is not null &&
                draftQuestion.MultipleChoiceOptions.Any())
            {
                foreach (var draftOption in draftQuestion.MultipleChoiceOptions!)
                {
                    // Get English values from MultilingualField
                    var englishOptionName = draftOption.NameField.Get("en-US", primaryLanguage);
                    var englishDependentQuestionName = draftOption.DependentQuestionNameField.Get("en-US", primaryLanguage);
                    
                    var option = MultipleChoiceOption.Create(
                        englishOptionName,
                        draftOption.SortOrder,
                        draftOption.DependentQuestionType,
                        question.Id,
                        englishDependentQuestionName);

                    db.Add(option);
                    await db.SaveChangesAsync();

                    // Save option translations using MultilingualFieldHelper
                    var optionResourceKey = $"MultipleChoiceOption.{option.Id}";
                    await MultilingualFieldHelper.SaveTranslationsAsync(
                        draftOption.NameField, db, optionResourceKey, "Name", primaryLanguage);
                    await MultilingualFieldHelper.SaveTranslationsAsync(
                        draftOption.DependentQuestionNameField, db, optionResourceKey, "DependentQuestionName", primaryLanguage);
                    MultilingualFieldHelper.UpdateCache(draftOption.NameField, optionResourceKey, "Name", primaryLanguage);
                    MultilingualFieldHelper.UpdateCache(draftOption.DependentQuestionNameField, optionResourceKey, "DependentQuestionName", primaryLanguage);

                    var excludedOptionProperties = new List<string> { nameof(option.DependentQuestionName), nameof(option.QuestionId), nameof(option.DependentMultipleChoiceOptions) };
                    await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Option created for question {question.Name}: ", option, excludedOptionProperties);

                    if (draftOption.HasDependentQuestion &&
                        draftOption.DependentQuestionType is DependentQuestionType.MultipleSelect or DependentQuestionType.SingleSelect &&
                        draftOption.DependentMultipleChoiceOptions is not null &&
                        draftOption.DependentMultipleChoiceOptions.Any())
                    {
                        foreach (var draftDependentOption in draftOption.DependentMultipleChoiceOptions!)
                        {
                            // Get English values from MultilingualField
                            var englishDepOptionName = draftDependentOption.NameField.Get("en-US", primaryLanguage);
                            var englishFreeFormDescription = draftDependentOption.FreeFormFieldDescriptionField.Get("en-US", primaryLanguage);
                            
                            var dependentOption = DependentMultipleChoiceOption.Create(
                                englishDepOptionName,
                                draftDependentOption.SortOrder,
                                draftDependentOption.HasFreeFormField,
                                option.Id,
                                englishFreeFormDescription);

                            db.Add(dependentOption);
                            await db.SaveChangesAsync();

                            // Save dependent option translations using MultilingualFieldHelper
                            var depOptionResourceKey = $"DependentMultipleChoiceOption.{dependentOption.Id}";
                            await MultilingualFieldHelper.SaveTranslationsAsync(
                                draftDependentOption.NameField, db, depOptionResourceKey, "Name", primaryLanguage);
                            await MultilingualFieldHelper.SaveTranslationsAsync(
                                draftDependentOption.FreeFormFieldDescriptionField, db, depOptionResourceKey, "FreeFormFieldDescription", primaryLanguage);
                            MultilingualFieldHelper.UpdateCache(draftDependentOption.NameField, depOptionResourceKey, "Name", primaryLanguage);
                            MultilingualFieldHelper.UpdateCache(draftDependentOption.FreeFormFieldDescriptionField, depOptionResourceKey, "FreeFormFieldDescription", primaryLanguage);

                            var excludedDependentOptionProperties = new List<string> { nameof(dependentOption.MultipleChoiceOptionId), nameof(dependentOption.MultipleChoiceOption) };
                            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Dependent Option created for option {option.Name}: ", dependentOption, excludedDependentOptionProperties);
                        }

                        await db.SaveChangesAsync();
                    }
                }

                await db.SaveChangesAsync();
            }
        }

        await db.SaveChangesAsync();

        // Create Question Groups
        foreach (var draftQuestionGroup in values.QuestionGroups)
        {
            // Get English values from MultilingualField
            var englishGroupName = draftQuestionGroup.NameField.Get("en-US", primaryLanguage);
            var englishGroupDescription = draftQuestionGroup.DescriptionField.Get("en-US", primaryLanguage);
            
            var questionGroup = QuestionGroup.Create(
                englishGroupName,
                draftQuestionGroup.SortOrder,
                questionnaire.Id,
                englishGroupDescription);

            db.Add(questionGroup);
            await db.SaveChangesAsync();

            // Save question group translations using MultilingualFieldHelper
            var groupResourceKey = $"QuestionGroup.{questionGroup.Id}";
            await MultilingualFieldHelper.SaveTranslationsAsync(
                draftQuestionGroup.NameField, db, groupResourceKey, "Name", primaryLanguage);
            await MultilingualFieldHelper.SaveTranslationsAsync(
                draftQuestionGroup.DescriptionField, db, groupResourceKey, "Description", primaryLanguage);
            MultilingualFieldHelper.UpdateCache(draftQuestionGroup.NameField, groupResourceKey, "Name", primaryLanguage);
            MultilingualFieldHelper.UpdateCache(draftQuestionGroup.DescriptionField, groupResourceKey, "Description", primaryLanguage);

            var excludedQuestionGroupProperties = new List<string> { nameof(questionGroup.QuestionnaireId), nameof(questionGroup.Questions), nameof(questionGroup.Questionnaire) };
            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Question group created for questionnaire {questionnaire.Name}: ", questionGroup, excludedQuestionGroupProperties);

            // Create Grouped Questions
            foreach (var draftQuestion in draftQuestionGroup.Questions)
            {
                // Get English values from MultilingualField
                var englishQuestionName = draftQuestion.NameField.Get("en-US", primaryLanguage);
                var englishQuestionDescription = draftQuestion.DescriptionField.Get("en-US", primaryLanguage);
                
                var question = Question.Create(
                    questionnaire.Id,
                    englishQuestionName,
                    draftQuestion.IsRequired,
                    draftQuestion.SortOrder,
                    draftQuestion.Type,
                    englishQuestionDescription,
                    questionGroup.Id);

                db.Add(question);
                await db.SaveChangesAsync();

                // Save question translations using MultilingualFieldHelper
                var questionResourceKey2 = $"Question.{question.Id}";
                await MultilingualFieldHelper.SaveTranslationsAsync(
                    draftQuestion.NameField, db, questionResourceKey2, "Name", primaryLanguage);
                await MultilingualFieldHelper.SaveTranslationsAsync(
                    draftQuestion.DescriptionField, db, questionResourceKey2, "Description", primaryLanguage);
                MultilingualFieldHelper.UpdateCache(draftQuestion.NameField, questionResourceKey2, "Name", primaryLanguage);
                MultilingualFieldHelper.UpdateCache(draftQuestion.DescriptionField, questionResourceKey2, "Description", primaryLanguage);

                // Create multiple choice options
                if (draftQuestion.Type is QuestionType.SingleSelect or QuestionType.MultipleSelect &&
                    draftQuestion.MultipleChoiceOptions is not null &&
                    draftQuestion.MultipleChoiceOptions.Any())
                {
                    foreach (var draftOption in draftQuestion.MultipleChoiceOptions!)
                    {
                        // Get English values from MultilingualField
                        var englishOptionName = draftOption.NameField.Get("en-US", primaryLanguage);
                        var englishDependentQuestionName = draftOption.DependentQuestionNameField.Get("en-US", primaryLanguage);
                        
                        var option = MultipleChoiceOption.Create(
                            englishOptionName,
                            draftOption.SortOrder,
                            draftOption.DependentQuestionType,
                            question.Id,
                            englishDependentQuestionName);

                        db.Add(option);
                        await db.SaveChangesAsync();

                        // Save option translations using MultilingualFieldHelper
                        var optionResourceKey = $"MultipleChoiceOption.{option.Id}";
                        await MultilingualFieldHelper.SaveTranslationsAsync(
                            draftOption.NameField, db, optionResourceKey, "Name", primaryLanguage);
                        await MultilingualFieldHelper.SaveTranslationsAsync(
                            draftOption.DependentQuestionNameField, db, optionResourceKey, "DependentQuestionName", primaryLanguage);
                        MultilingualFieldHelper.UpdateCache(draftOption.NameField, optionResourceKey, "Name", primaryLanguage);
                        MultilingualFieldHelper.UpdateCache(draftOption.DependentQuestionNameField, optionResourceKey, "DependentQuestionName", primaryLanguage);

                        var excludedQuestionProperties = new List<string> { nameof(question.QuestionnaireId), nameof(question.QuestionGroupId), nameof(question.MultipleChoiceOptions), nameof(question.Questionnaire), nameof(question.QuestionGroup) };
                        await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Grouped Question created for questionnaire {questionnaire.Name}: ", question, excludedQuestionProperties);

                        if (draftOption.HasDependentQuestion &&
                            draftOption.DependentQuestionType is DependentQuestionType.MultipleSelect or DependentQuestionType.SingleSelect &&
                            draftOption.DependentMultipleChoiceOptions is not null &&
                            draftOption.DependentMultipleChoiceOptions.Any())
                        {
                            foreach (var draftDependentOption in draftOption.DependentMultipleChoiceOptions!)
                            {
                            // Get English values from MultilingualField
                            var englishDepOptionName = draftDependentOption.NameField.Get("en-US", primaryLanguage);
                            var englishFreeFormDescription = draftDependentOption.FreeFormFieldDescriptionField.Get("en-US", primaryLanguage);
                                
                                var dependentOption = DependentMultipleChoiceOption.Create(
                                    englishDepOptionName,
                                    draftDependentOption.SortOrder,
                                    draftDependentOption.HasFreeFormField,
                                    option.Id,
                                    englishFreeFormDescription);

                                db.Add(dependentOption);
                                await db.SaveChangesAsync();

                                // Save dependent option translations
                                // Save dependent option translations using MultilingualFieldHelper
                                var depOptionResourceKey2 = $"DependentMultipleChoiceOption.{dependentOption.Id}";
                                await MultilingualFieldHelper.SaveTranslationsAsync(
                                    draftDependentOption.NameField, db, depOptionResourceKey2, "Name", primaryLanguage);
                                await MultilingualFieldHelper.SaveTranslationsAsync(
                                    draftDependentOption.FreeFormFieldDescriptionField, db, depOptionResourceKey2, "FreeFormFieldDescription", primaryLanguage);
                                MultilingualFieldHelper.UpdateCache(draftDependentOption.NameField, depOptionResourceKey2, "Name", primaryLanguage);
                                MultilingualFieldHelper.UpdateCache(draftDependentOption.FreeFormFieldDescriptionField, depOptionResourceKey2, "FreeFormFieldDescription", primaryLanguage);

                                var excludedDependentOptionProperties = new List<string> { nameof(dependentOption.MultipleChoiceOptionId), nameof(dependentOption.MultipleChoiceOption) };
                                await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Dependent Option created for option {option.Name}: ", dependentOption, excludedDependentOptionProperties);
                            }
                            await db.SaveChangesAsync();
                        }
                    }

                    await db.SaveChangesAsync();
                }
            }

            await db.SaveChangesAsync();
        }

        // Create Application Type Links
        foreach (var appTypeCheckbox in values.ApplicationTypes.Where(x => x.IsChecked))
        {
            var link = QuestionnaireApplicationTypeLink.Create(
                questionnaire.Id,
                appTypeCheckbox.Id);

            db.Add(link);
            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Application type {appTypeCheckbox.DisplayName} was linked to questionnaire {questionnaire.Id}");
        }

        await db.SaveChangesAsync();

        if (values.Level == QuestionnaireLevel.Product)
        {
            // Create Share Product Links
            foreach (var productCheckbox in values.Products
                         .Where(x => x.Type == QuestionnaireForm.ProductType.Share)
                         .Where(x => x.IsChecked))
            {
                var link = QuestionnaireShareProductLink.Create(
                    questionnaire.Id,
                    productCheckbox.Id);

                db.Add(link);
                await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Share product {productCheckbox.DisplayName} was linked to questionnaire {questionnaire.Id}");
            }

            // Create Loan Product Links
            foreach (var productCheckbox in values.Products
                         .Where(x => x.Type == QuestionnaireForm.ProductType.Loan)
                         .Where(x => x.IsChecked))
            {
                var link = QuestionnaireLoanProductLink.Create(
                    questionnaire.Id,
                    productCheckbox.Id);

                db.Add(link);
                await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Loan product {productCheckbox.DisplayName} was linked to questionnaire {questionnaire.Id}");
            }

            await db.SaveChangesAsync();
        }
        
        // Get English values from MultilingualField
        var englishName = values.NameField.Get("en-US", primaryLanguage);
        var englishDescription = values.DescriptionField.Get("en-US", primaryLanguage);
        
        questionnaire.Update(englishName, values.IsEnabled, values.IsRequired, values.Level, englishDescription);
        questionnaire.BumpVersion();

        await db.SaveChangesAsync();

        // Save translations using MultilingualFieldHelper
        var resourceKey = $"Questionnaire.{questionnaireId}";
        await MultilingualFieldHelper.SaveTranslationsAsync(
            values.NameField, db, resourceKey, "Name", primaryLanguage);
        await MultilingualFieldHelper.SaveTranslationsAsync(
            values.DescriptionField, db, resourceKey, "Description", primaryLanguage);
        MultilingualFieldHelper.UpdateCache(values.NameField, resourceKey, "Name", primaryLanguage);
        MultilingualFieldHelper.UpdateCache(values.DescriptionField, resourceKey, "Description", primaryLanguage);

        var excludedProperties = new List<string> { nameof(questionnaire.Questions), nameof(questionnaire.QuestionGroups), nameof(questionnaire.QuestionnaireResponses),
                nameof(questionnaire.QuestionnaireShareProductLinks), nameof(questionnaire.QuestionnaireApplicationTypeLinks), nameof(questionnaire.QuestionnaireLoanProductLinks) };
        if (AdminUser != null)
        {
            await adminActivityService.TrackAdminUserActivityAsync(AdminUser, AdminActivityType.Questionnaires, $"Questionnaire Id: {questionnaire.Id} was edited: ", oldConfig, questionnaire, excludedProperties);
        }
    }

    // Translation saving helper methods
    private async Task SaveQuestionTranslations(AlohaDb db, int questionId, string name, string? description, Dictionary<string, string> nameTranslations, Dictionary<string, string> descriptionTranslations)
    {
        var resourceKey = $"Question.{questionId}";
        var cultures = await db.Set<LocalizationCulture>().ToListAsync();
        var cultureMap = cultures.ToDictionary(c => c.Culture, c => c.Id);
        var primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();

        Console.WriteLine($"[SaveQuestionTranslations] QuestionId: {questionId}, PrimaryLanguage: {primaryLanguage}");
        Console.WriteLine($"[SaveQuestionTranslations] name parameter (primary language value): '{name}'");
        Console.WriteLine($"[SaveQuestionTranslations] nameTranslations dictionary: {string.Join(", ", nameTranslations.Select(kvp => $"{kvp.Key}='{kvp.Value}'"))}");
        Console.WriteLine($"[SaveQuestionTranslations] description parameter (primary language value): '{description}'");
        Console.WriteLine($"[SaveQuestionTranslations] descriptionTranslations dictionary: {string.Join(", ", descriptionTranslations.Select(kvp => $"{kvp.Key}='{kvp.Value}'"))}");

        // Save Name translations (excluding primary language - it's saved separately)
        foreach (var translation in nameTranslations)
        {
            // Skip primary language - it's saved separately below
            if (translation.Key == primaryLanguage)
            {
                Console.WriteLine($"[SaveQuestionTranslations] Skipping primary language '{translation.Key}' from nameTranslations dictionary");
                continue;
            }
            
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                Console.WriteLine($"[SaveQuestionTranslations] Culture '{translation.Key}' not found in cultureMap");
                continue;
            }

            Console.WriteLine($"[SaveQuestionTranslations] Saving Name translation: {translation.Key} = '{translation.Value}'");
            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Name");

            if (existing != null)
            {
                Console.WriteLine($"[SaveQuestionTranslations] Updating existing Name translation for {translation.Key}");
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                Console.WriteLine($"[SaveQuestionTranslations] Creating new Name translation for {translation.Key}");
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Name",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }

        // Save primary language Name if not English
        if (!primaryLanguage.StartsWith("en"))
        {
            Console.WriteLine($"[SaveQuestionTranslations] Saving primary language ({primaryLanguage}) Name: '{name}'");
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Name");

                if (existing != null)
                {
                    Console.WriteLine($"[SaveQuestionTranslations] Updating existing primary language Name translation");
                    existing.UpdateDefault(name ?? "");
                }
                else
                {
                    Console.WriteLine($"[SaveQuestionTranslations] Creating new primary language Name translation");
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Name",
                        defaultText: name ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
            else
            {
                Console.WriteLine($"[SaveQuestionTranslations] ERROR: Primary language '{primaryLanguage}' not found in cultureMap!");
            }
        }
        else
        {
            Console.WriteLine($"[SaveQuestionTranslations] Primary language is English, Name saved to entity property, not LocalizationStrings");
        }

        // Save Description translations (excluding primary language - it's saved separately)
        foreach (var translation in descriptionTranslations)
        {
            // Skip primary language - it's saved separately below
            if (translation.Key == primaryLanguage)
            {
                Console.WriteLine($"[SaveQuestionTranslations] Skipping primary language '{translation.Key}' from descriptionTranslations dictionary");
                continue;
            }
            
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                Console.WriteLine($"[SaveQuestionTranslations] Culture '{translation.Key}' not found in cultureMap for Description");
                continue;
            }

            Console.WriteLine($"[SaveQuestionTranslations] Saving Description translation: {translation.Key} = '{translation.Value}'");
            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Description");

            if (existing != null)
            {
                Console.WriteLine($"[SaveQuestionTranslations] Updating existing Description translation for {translation.Key}");
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                Console.WriteLine($"[SaveQuestionTranslations] Creating new Description translation for {translation.Key}");
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Description",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }

        // Save primary language Description if not English
        if (!primaryLanguage.StartsWith("en") && !string.IsNullOrWhiteSpace(description))
        {
            Console.WriteLine($"[SaveQuestionTranslations] Saving primary language ({primaryLanguage}) Description: '{description}'");
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Description");

                if (existing != null)
                {
                    Console.WriteLine($"[SaveQuestionTranslations] Updating existing primary language Description translation");
                    existing.UpdateDefault(description ?? "");
                }
                else
                {
                    Console.WriteLine($"[SaveQuestionTranslations] Creating new primary language Description translation");
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Description",
                        defaultText: description ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
            else
            {
                Console.WriteLine($"[SaveQuestionTranslations] ERROR: Primary language '{primaryLanguage}' not found in cultureMap for Description!");
            }
        }
        else if (primaryLanguage.StartsWith("en"))
        {
            Console.WriteLine($"[SaveQuestionTranslations] Primary language is English, Description saved to entity property, not LocalizationStrings");
        }

        Console.WriteLine($"[SaveQuestionTranslations] Calling SaveChangesAsync...");
        await db.SaveChangesAsync();
        Console.WriteLine($"[SaveQuestionTranslations] SaveChangesAsync completed");
        
        // Update cache with saved translations
        foreach (var translation in nameTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "Name", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en"))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "Name", name ?? "");
        }
        foreach (var translation in descriptionTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "Description", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en") && !string.IsNullOrWhiteSpace(description))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "Description", description ?? "");
        }
    }

    private async Task SaveQuestionGroupTranslations(AlohaDb db, int groupId, string name, string? description, Dictionary<string, string> nameTranslations, Dictionary<string, string> descriptionTranslations)
    {
        var resourceKey = $"QuestionGroup.{groupId}";
        var cultures = await db.Set<LocalizationCulture>().ToListAsync();
        var cultureMap = cultures.ToDictionary(c => c.Culture, c => c.Id);
        var primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();

        // Save Name translations (excluding primary language - it's saved separately)
        foreach (var translation in nameTranslations)
        {
            // Skip primary language - it's saved separately below
            if (translation.Key == primaryLanguage)
            {
                continue;
            }
            
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                continue;
            }

            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Name");

            if (existing != null)
            {
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Name",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }

        // Save primary language Name if not English
        if (!primaryLanguage.StartsWith("en"))
        {
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Name");

                if (existing != null)
                {
                    existing.UpdateDefault(name ?? "");
                }
                else
                {
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Name",
                        defaultText: name ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
        }

        // Save Description translations (excluding primary language - it's saved separately)
        foreach (var translation in descriptionTranslations)
        {
            // Skip primary language - it's saved separately below
            if (translation.Key == primaryLanguage)
            {
                continue;
            }
            
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                continue;
            }

            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Description");

            if (existing != null)
            {
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Description",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }

        // Save primary language Description if not English
        if (!primaryLanguage.StartsWith("en") && !string.IsNullOrWhiteSpace(description))
        {
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Description");

                if (existing != null)
                {
                    existing.UpdateDefault(description ?? "");
                }
                else
                {
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Description",
                        defaultText: description ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
        }

        await db.SaveChangesAsync();
        
        // Update cache with saved translations
        foreach (var translation in nameTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "Name", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en"))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "Name", name ?? "");
        }
        foreach (var translation in descriptionTranslations)
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(translation.Key, resourceKey, "Description", translation.Value ?? "");
        }
        if (!primaryLanguage.StartsWith("en") && !string.IsNullOrWhiteSpace(description))
        {
            Aloha.Domain.Services.Translations.TranslationHelper.UpdateCacheEntry(primaryLanguage, resourceKey, "Description", description ?? "");
        }
    }


    private static async Task DeleteQuestionnaireLinkedEntities(AlohaDb db, int questionnaireId)
    {
        var questionnaire = await db.Questionnaires
            .Include(questionnaire => questionnaire.QuestionGroups)
            .Include(questionnaire => questionnaire.QuestionnaireApplicationTypeLinks)
            .Include(questionnaire => questionnaire.QuestionnaireShareProductLinks)
            .Include(questionnaire => questionnaire.QuestionnaireLoanProductLinks)
            .Include(questionnaire => questionnaire.Questions)!
            .ThenInclude(question => question.MultipleChoiceOptions)!
            .ThenInclude(multipleChoiceOption => multipleChoiceOption.DependentMultipleChoiceOptions)
            .FirstAsync(q => q.Id == questionnaireId);

        if (questionnaire.Questions != null)
        {
            foreach (var question in questionnaire.Questions)
            {
                if (question.MultipleChoiceOptions != null)
                {
                    foreach (var option in question.MultipleChoiceOptions)
                    {
                        if (option.DependentMultipleChoiceOptions != null)
                        {
                            foreach (var depOption in option.DependentMultipleChoiceOptions)
                            {
                                db.Remove(depOption);
                            }
                        }
                        db.Remove(option);
                    }
                }
                db.Remove(question);
            }
        }

        if (questionnaire.QuestionGroups != null)
        {
            foreach (var group in questionnaire.QuestionGroups)
            {
                db.Remove(group);
            }
        }

        if (questionnaire.QuestionnaireApplicationTypeLinks != null)
        {
            foreach (var link in questionnaire.QuestionnaireApplicationTypeLinks)
            {
                db.Remove(link);
            }
        }

        if (questionnaire.QuestionnaireShareProductLinks != null)
        {
            foreach (var link in questionnaire.QuestionnaireShareProductLinks)
            {
                db.Remove(link);
            }
        }

        if (questionnaire.QuestionnaireLoanProductLinks != null)
        {
            foreach (var link in questionnaire.QuestionnaireLoanProductLinks)
            {
                db.Remove(link);
            }
        }

        await db.SaveChangesAsync();
    }
}