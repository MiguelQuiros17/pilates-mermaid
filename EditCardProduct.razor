@page "/ApplicationConfiguration/products/cardproducts/edit/{Id:int}"
@using Aloha.Domain.Products
@using Microsoft.AspNetCore.Authorization
@using Aloha.Domain.Services.AdminAudit
@using Aloha.Domain.Identity.AdminUsers.Activities
@using Aloha.Domain.Identity.AdminUsers
@using Microsoft.AspNetCore.Identity
@using Aloha.Domain.Services.Translations
@attribute [Authorize(Roles = "MahaloAdmin, MasterAdmin, Audit")]
@inject AuthenticationStateProvider authStateProvider
@inject IDbContextFactory<AlohaDb> dbFactory
@inject NavigationManager nav
@inject IAdminActivityService adminActivityService
@inject UserManager<AdminUser> UserManager
@inject ILanguageConfigurationService LanguageConfigService
@rendermode InteractiveServer

<h3>Edit Card Product</h3>

<EditForm class="pb-3"
          disabled="@isReadOnly"
          EditContext="editContext"
          FormName="EditCardProduct"
          OnValidSubmit="SubmitForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    @* Language selector and bulk translate button - all handled by BulkTranslateButton *@
    <BulkTranslateButton @ref="bulkTranslateButton"
                        FieldIdPrefix="cardproduct"
                        Fields="@GetFieldsMap()"
                        FieldsChanged="@((Dictionary<string, MultilingualField> fields) => { input.DisplayName = fields["Display Name"]; input.Description = fields["Description"]; StateHasChanged(); })"
                        SelectedCultureChanged="@((string culture) => StateHasChanged())" />

    <div class="mb-3">
        <label class="form-label" for="categoryType">Category Type</label>
        <InputSelect @bind-Value="input.CardProductCategoryId"
                     class="form-select"
                     disabled="@isReadOnly"
                     id="categoryType">
            @foreach (var option in categories)
            {
                <option value="@option.Id">@option.CategoryDisplayName</option>
            }
        </InputSelect>
        <ValidationMessage For="() => input.CardProductCategoryId" />
    </div>

    @* Multi-language input for Display Name *@
    <MultiLanguageInput Label="Display Name"
                       FieldId="displayName"
                       Placeholder="Enter display name"
                       Rows="1"
                       IsDisabled="@isReadOnly"
                       Field="@input.DisplayName"
                       FieldChanged="@((MultilingualField f) => input.DisplayName = f)"
                       SelectedCultureOverride="@(bulkTranslateButton?.CurrentCulture)"
                       SelectedCultureOverrideChanged="@((string culture) => StateHasChanged())" />

    @* Multi-language input for Description *@
    <MultiLanguageInput Label="Description"
                       FieldId="description"
                       Placeholder="Enter description"
                       Rows="3"
                       IsDisabled="@isReadOnly"
                       Field="@input.Description"
                       FieldChanged="@((MultilingualField f) => input.Description = f)"
                       SelectedCultureOverride="@(bulkTranslateButton?.CurrentCulture)"
                       SelectedCultureOverrideChanged="@((string culture) => StateHasChanged())" />

    @if (!isCoreOfflineMode)
    {
        <div class="mb-3">
            <label class="form-label" for="coreIdentifier">Core Identifier</label>
            <InputText @bind-Value="input.CoreTypeIdentifier"
            class="form-control"
            disabled="@isReadOnly"
            id="coreIdentifier"
            type="text" />
            <ValidationMessage For="() => input.CoreTypeIdentifier" />
        </div>
    }

    <div class="form-check mb-3">
        <InputCheckbox @bind-Value="input.IsEnabled"
        class="form-check-input"
        disabled="@isReadOnly"
        id="productEnabled" />
        <label class="form-check-label" for="productEnabled">Is Enabled</label>
        <ValidationMessage For="() => input.IsEnabled" />
    </div>

    <div class="form-check mb-3">
        <InputCheckbox @bind-Value="input.SupportsChecking"
        class="form-check-input"
        disabled="@isReadOnly"
        id="supportsChecking" />
        <label class="form-check-label" for="supportsChecking">Supports Checking</label>
        <ValidationMessage For="() => input.SupportsChecking" />
    </div>

    @if (input.SupportsChecking)
    {
        <div class="form-check mb-3" style="margin-left: 20px;">
            <InputCheckbox @bind-Value="input.RequiresChecking"
            class="form-check-input"
            disabled="@isReadOnly"
            id="requiresChecking" />
            <label class="form-check-label" for="requiresChecking">Requires Checking</label>
            <ValidationMessage For="() => input.RequiresChecking" />
        </div>
    }

    <div class="form-check mb-3">
        <InputCheckbox @bind-Value="input.SupportsSavings"
        class="form-check-input"
        disabled="@isReadOnly"
        id="supportsSavings" />
        <label class="form-check-label" for="supportsSavings">Supports Savings</label>
        <ValidationMessage For="() => input.SupportsSavings" />
    </div>

    @if (input.SupportsSavings)
    {
        <div class="form-check mb-3" style="margin-left: 20px;">
            <InputCheckbox @bind-Value="input.RequiresSavings"
            class="form-check-input"
            disabled="@isReadOnly"
            id="requiresSavings" />
            <label class="form-check-label" for="requiresSavings">Requires Savings</label>
            <ValidationMessage For="() => input.RequiresSavings" />
        </div>
    }

    @if (input.IsEnabled)
    {
        <div class="form-check mb-3">
            <InputCheckbox @bind-Value="input.IsRestrictedCardProduct"
            class="form-check-input"
            disabled="@isReadOnly"
            id="isRestricted" />
            <label class="form-check-label" for="isRestricted">Is Restricted to Products</label>
            <ValidationMessage For="() => input.IsRestrictedCardProduct" />
        </div>

        if (input.IsRestrictedCardProduct)
        {
            <h5>Restrictions</h5>
            <div class="list-group my-3">
                @foreach (var option in input.ShareProductOptions)
                {
                    <div class="list-group-item">
                        <label>
                            <InputCheckbox @bind-Value="option.Checked"
                            class="form-check-input me-1"
                            disabled="@isReadOnly"
                            type="checkbox" />
                            @option.DisplayName
                        </label>
                        <ValidationMessage For="() => option.Checked" />
                    </div>
                }
            </div>
        }
    }

    <div class="mb-3">
        <label class="form-label mb-0">Upload Card Image</label>
        <p class="form-text m-0 mb-2">Please provide an image with a 3.375/2.125 aspect ratio (width/height)</p>
        <InputFile class="form-control" disabled="@isReadOnly" OnChange="HandleCardImageFileChangeAsync" />
        <div class="form-text mb-0">Supported file types: PNG, JPG, JPEG</div>
        <div class="form-text">Max file size: @(MAX_IMAGE_FILE_BYTES / 1000)KB</div>
        <ValidationMessage For="() => input.CardImageFile" />
        @if (currentCardImageUrl is not null)
        {
            <div class="mb-2" style="max-width: 420px; width: 100%">
                <p class="form-text mb-1 mt-2">Current Card Image:</p>
                <img alt="card preview" class="img-fluid" src="@currentCardImageUrl" />
            </div>
        }
    </div>

    @if (!isReadOnly)
    {
        <div class="mb-3">
            <SaveConfirmationMessage @ref="messageRef" Title="Card Product" RouteAfterSaved="/ApplicationConfiguration/products" />
        </div>
    }
</EditForm>

@code {

    [Parameter]
    public int? Id { get; set; }

    private SaveConfirmationMessage? messageRef;
    private Input input { get; set; } = new();
    private EditContext editContext = default!;
    private ValidationMessageStore messageStore = default!;
    private IList<CardProductCategory> categories = [];
    private bool isReadOnly = true;
    private IBrowserFile? cardImageFile;
    private string? currentCardImageUrl;
    private const long MAX_IMAGE_FILE_BYTES = 512000L;
    bool isCoreOfflineMode = false;
    private AdminUser? AdminUser = default!;
    private BulkTranslateButton? bulkTranslateButton;

    protected override void OnInitialized()
    {
        editContext = new EditContext(input);
        messageStore = new ValidationMessageStore(editContext);
        editContext.OnValidationRequested += (s, e) => messageStore.Clear();
        editContext.OnFieldChanged += (s, e) => messageStore.Clear(e.FieldIdentifier);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckRoleAndUpdateReadOnlyFlagAsync();
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        await using var db = await dbFactory.CreateDbContextAsync();

        var feature = await db.SystemFeatures.GetActiveFeatureAsync();
        isCoreOfflineMode = feature?.WebApplicationFeature?.CoreOfflineModeEnabled ?? false;

        var cardProduct = await db.CardProducts
            .Include(cardProduct => cardProduct.CardProductImage)
            .FirstAsync(p => p.Id == Id);

        categories = await db.CardProductCategories.GetActiveCategories().ToListAsync();

        // Load translations using MultilingualFieldHelper
        var resourceKey = $"CardProduct.{Id}";
        var enabledLanguages = await LanguageConfigService.GetEnabledLanguagesAsync();
        var primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
        
        await MultilingualFieldHelper.LoadTranslationsAsync(
            input.DisplayName, db, resourceKey, "ProductDisplayName", 
            primaryLanguage, cardProduct.ProductDisplayName, enabledLanguages);
        
        await MultilingualFieldHelper.LoadTranslationsAsync(
            input.Description, db, resourceKey, "ProductDescription", 
            primaryLanguage, cardProduct.ProductDescription, enabledLanguages);

        // Load all other property values
        input.CardProductCategoryId = cardProduct.CardProductCategoryId;
        input.IsEnabled = cardProduct.IsEnabled;
        input.SupportsChecking = cardProduct.SupportsChecking;
        input.RequiresChecking = cardProduct.RequiresChecking;
        input.SupportsSavings = cardProduct.SupportsSavings;
        input.RequiresSavings = cardProduct.RequiresSavings;
        input.CoreTypeIdentifier = cardProduct.CoreTypeIdentifier;
        input.IsRestrictedCardProduct = cardProduct.RestrictedCardProduct;

        var cardShareTypeLinks = db.CardShareTypeLinks
            .Where(x => x.CardProductId == cardProduct.Id);

        input.ShareProductOptions = await db.ShareProducts
            .Where(x => x.IsEnabled && x.CardOrderEnabled)
            .Select(x => new CheckBoxOption
            {
                DisplayName = x.ProductDisplayName,
                ProductId = x.Id,
                Checked = cardShareTypeLinks.Any(y => y.CardProductId == cardProduct.Id && y.ShareProductId == x.Id),
            })
            .ToListAsync();

        if (cardProduct.CardProductImage is not null)
        {
            currentCardImageUrl = CreateBase64ImageUrl(
                cardProduct.CardProductImage.FileContent,
                cardProduct.CardProductImage.ContentType);
        }

        StateHasChanged();
    }

    private Dictionary<string, MultilingualField> GetFieldsMap()
    {
        return new Dictionary<string, MultilingualField>
        {
            { "Display Name", input.DisplayName },
            { "Description", input.Description }
        };
    }

    private static async Task<(byte[] bytes, string contentType)> ExtractContentFromFileAsync(IBrowserFile file)
    {
        using var memoryStream = new MemoryStream();
        await file.OpenReadStream().CopyToAsync(memoryStream);
        var contentType = file.ContentType;
        var bytes = memoryStream.ToArray();
        return (bytes, contentType);
    }

    private static string CreateBase64ImageUrl(byte[] bytes, string contentType) =>
        $"data:{contentType};base64, {Convert.ToBase64String(bytes)}";

    private async Task CheckRoleAndUpdateReadOnlyFlagAsync()
    {
        var authUser = (await authStateProvider.GetAuthenticationStateAsync()).User;
        AdminUser = await UserManager.FindByEmailAsync(authUser.Identity!.Name!);
        isReadOnly = !(authUser.IsInRole("MahaloAdmin") || authUser.IsInRole("MasterAdmin"));
    }

    private async Task HandleCardImageFileChangeAsync(InputFileChangeEventArgs e)
    {
        messageStore.Clear(editContext.Field("CardImageFile"));
        if (e.File.ContentType is not "image/jpeg" and not "image/png")
        {
            messageStore.Add(() => input.CardImageFile!, $"Unsupported image file type provided. Supported file types: JPG, JPEG, PNG");
            return;
        }

        if (e.File.Size > MAX_IMAGE_FILE_BYTES)
        {
            messageStore.Add(() => input.CardImageFile!, $"Image file must be smaller than {MAX_IMAGE_FILE_BYTES / 1000}KB");
            return;
        }
        cardImageFile = e.File;
        var (bytes, contentType) = await ExtractContentFromFileAsync(cardImageFile);
        currentCardImageUrl = CreateBase64ImageUrl(bytes, contentType);
    }

    private async Task SubmitForm()
    {
        if (!isCoreOfflineMode && string.IsNullOrEmpty(input.CoreTypeIdentifier))
        {
            messageStore.Add(() => input.CoreTypeIdentifier!, "The CoreTypeIdentifier field is required.");
            return;
        }

        if (input.IsRestrictedCardProduct && !input.ShareProductOptions.Any(x => x.Checked))
        {
            messageStore.Add(() => input.DisplayName.PrimaryValue, $"Restricted products must have at least one linked product.");
            return;
        }
        try
        {
            messageRef?.SetSaving(true);
            await using var db = await dbFactory.CreateDbContextAsync();

            var cardProduct = await db.CardProducts
                .Include(x => x.CardShareTypeLinks)
                .Include(cardProduct => cardProduct.CardProductImage)
                .FirstAsync(p => p.Id == Id);
            var originalConfig = db.Entry(cardProduct).CurrentValues.Clone().ToObject();

            if (!isCoreOfflineMode && input.CoreTypeIdentifier != cardProduct.CoreTypeIdentifier && await db.CardProducts.AnyAsync(card => card.CoreTypeIdentifier == input.CoreTypeIdentifier))
            {
                messageStore.Add(() => input.CoreTypeIdentifier!, "Core identifier already exists");
                messageRef?.SetSaving(false);
                return;
            }

            // Get primary language to determine save strategy
            var primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
            
            // Save translations using MultilingualFieldHelper
            var resourceKey = $"CardProduct.{Id}";
            
            var englishDisplayName = await MultilingualFieldHelper.SaveTranslationsAsync(
                input.DisplayName, db, resourceKey, "ProductDisplayName", primaryLanguage);
            
            var englishDescription = await MultilingualFieldHelper.SaveTranslationsAsync(
                input.Description, db, resourceKey, "ProductDescription", primaryLanguage);
            
            cardProduct.UpdateText(englishDisplayName, englishDescription);
            cardProduct.UpdateFlags(input.IsEnabled, input.SupportsChecking, input.SupportsSavings, input.RequiresChecking, input.RequiresSavings, input.CoreTypeIdentifier!, input.IsRestrictedCardProduct);
            cardProduct.UpdateCategoryId(input.CardProductCategoryId!.Value);

            // Update cache
            MultilingualFieldHelper.UpdateCache(input.DisplayName, resourceKey, "ProductDisplayName", primaryLanguage);
            MultilingualFieldHelper.UpdateCache(input.Description, resourceKey, "ProductDescription", primaryLanguage);

            foreach (var option in input.ShareProductOptions)
            {
                var existingLink = cardProduct.CardShareTypeLinks!.FirstOrDefault(x => x.ShareProductId == option.ProductId);

                if (!option.Checked && existingLink is not null)
                {
                    db.Remove(existingLink);
                }
                else if (option.Checked && existingLink is null)
                {
                    var newLink = CardShareTypeLink.Create(cardProduct, option.ProductId);
                    db.Add(newLink);
                }
            }

            await db.SaveChangesAsync();

            // Handle card image update
            if (cardImageFile is not null && Id is not null)
            {
                var (bytes, contentType) = await ExtractContentFromFileAsync(cardImageFile);

                // If card did not have image previously, add one
                if (cardProduct.CardProductImage is null)
                {
                    var newImage = CardProductImage.Create(contentType, bytes, Id.Value);
                    db.Add(newImage);
                    await db.SaveChangesAsync();
                    cardProduct.UpdateImageId(newImage.Id);
                }
                // Otherwise, update the existing card image
                else
                {
                    cardProduct.CardProductImage.Update(contentType, bytes);
                }

                await db.SaveChangesAsync();
            }

            var excludedProperties = new List<string> { nameof(cardProduct.DeleteDateUtc), nameof(cardProduct.CardProductCategoryId), nameof(cardProduct.CardShareTypeLinks), nameof(cardProduct.CardProductImageId) };
            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Products, $"Card product Id: {cardProduct.Id} was edited: ", originalConfig, cardProduct, excludedProperties);
            messageRef?.Notify(new(ToastType.Success, string.Empty));
        }
        catch
        {
            messageRef?.Notify(new(ToastType.Warning, string.Empty));
        }
    }

    private class CheckBoxOption
    {
        public bool Checked { get; set; }
        public string DisplayName { get; set; } = default!;
        public int ProductId { get; set; }
    }

    private class Input
    {
        public MultilingualField DisplayName { get; set; } = new();

        [Required]
        public int? CardProductCategoryId { get; set; }

        [Required]
        public bool IsEnabled { get; set; } = true;

        [Required]
        public bool SupportsChecking { get; set; }

        [Required]
        public bool SupportsSavings { get; set; }

        [Required]
        public bool RequiresChecking { get; set; }

        [Required]
        public bool RequiresSavings { get; set; }

        [Required]
        public bool IsRestrictedCardProduct { get; set; }

        public MultilingualField Description { get; set; } = new();

        [MaxLength(30)]
        public string? CoreTypeIdentifier { get; set; }

        public IList<CheckBoxOption> ShareProductOptions { get; set; } = [];
        public IBrowserFile? CardImageFile { get; set; }
    }
}