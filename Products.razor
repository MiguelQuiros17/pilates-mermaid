@page "/applications/products"
@using Aloha.Customer.Web.Components.Common
@using Aloha.Domain.ApplicationProducts
@using Aloha.Domain.Applications
@using Aloha.Domain.Features
@using Aloha.Domain.Products
@using Aloha.Domain.Questionnaires
@using Aloha.Domain.Services.Core.Services
@using Aloha.Domain.Services.Core.Services.CoreService.Models
@rendermode InteractiveServer
@inject IApplicationStateProvider stateProvider
@inject IApplicationStepCompletionManager applicationStepCompletionManager
@inject ICoreService coreService
@inject IDbContextFactory<AlohaDb> dbFactory
@inject IStringLocalizer<Index> l
@inject IStringLocalizer<SharedResources> sl
@inject NavigationManager nav

<h1>@l["page-heading"]</h1>

@if (isLoading)
{
    <p>
        <Spinner Color="SpinnerColor.Primary" Size="SpinnerSize.Small" />
        <span class="ms-2">Loading&hellip;</span>
    </p>
}
else if (singleProductMode)
{
    <p class="mb-4" style="white-space: pre-line">@l["page-description-single-product"]</p>

    <div class="card mb-3">
        @if (singleShareProduct is not null)
        {
            <div class="card-body">
                <h5 class="card-title">@singleShareProduct.ProductDisplayName</h5>
                <h6 class="card-subtitle mb-2 text-body-secondary">
                    @singleShareProduct.ShareProductCategory!.CategoryDisplayName
                </h6>

                @if (singleShareProduct.ProductDescription is not null)
                {
                    <p class="card-text"> @((MarkupString)singleShareProduct.ProductDescription)</p>
                }

                <Button Color="ButtonColor.Primary"
                @onclick="() => SelectSingleProduct(singleShareProduct)"
                Outline="true"
                Type="@ButtonType.Button">
                    @l["product-select-button"]
                </Button>
            </div>
        }
        @if (singleLoanProduct is not null)
        {
            <div class="card-body">
                <h5 class="card-title">@singleLoanProduct.ProductDisplayName</h5>
                <h6 class="card-subtitle mb-2 text-body-secondary">
                    @singleLoanProduct.LoanProductCategory!.CategoryDisplayName
                </h6>

                @if (singleLoanProduct.ProductDescription is not null)
                {
                    <p class="card-text"> @((MarkupString)singleLoanProduct.ProductDescription)</p>
                }

                <Button Color="ButtonColor.Primary"
                @onclick="() => SelectSingleProduct(singleLoanProduct)"
                Outline="true"
                Type="@ButtonType.Button">
                    @l["product-select-button"]
                </Button>
            </div>
        }

    </div>
}
else
{
    <p class="mb-4" style="white-space: pre-line">@l["page-description"]</p>
    @if (shareProductCategories.Any())
    {
        <TabControl @ref="shareTabs">
            @foreach (var category in shareProductCategories)
            {
                <TabView Title="@category.CategoryDisplayName">
                    @if (!string.IsNullOrEmpty(category.HelperText))
                    {
                        <div>@category.HelperText</div>
                    }
                    @if ((@category.MinRequireSelections.HasValue && @category.MinRequireSelections > 0) && (category.MaximumSelections.HasValue && category.MaximumSelections > 0))
                    {
                        <div class="mb-3">@l["text-min-max-products-count", @category.MinRequireSelections, @category.CategoryDisplayName, @category.MaximumSelections]</div>
                    }
                    else if ((@category.MinRequireSelections.HasValue && @category.MinRequireSelections > 0) && (!category.MaximumSelections.HasValue || category.MaximumSelections == 0))
                    {
                        <div class="mb-3">@l["text-min-products-count", @category.MinRequireSelections, @category.CategoryDisplayName]</div>
                    }
                    else if ((!@category.MinRequireSelections.HasValue || @category.MinRequireSelections == 0) && (category.MaximumSelections.HasValue && category.MaximumSelections > 0))
                    {
                        <div class="mb-3">@l["text-max-products-count", @category.MaximumSelections, @category.CategoryDisplayName]</div>
                    }
                    
                    @foreach (var product in shareProducts.Where(x => x.ShareProductCategoryId == category.Id))
                    {
                        <div class="card mb-3">
                            <div class="card-body">
                                <div>
                                    <div class="align-items-start gap-2 hstack mb-1">
                                        <h5 class="lh-1 m-0">@product.ProductDisplayName</h5>
                                        @if (product.IsRequiredProduct)
                                        {
                                            <Badge Color="BadgeColor.Primary"
                                            IndicatorType="BadgeIndicatorType.RoundedPill">
                                                @sl["label-required-badge"]
                                            </Badge>
                                        }
                                        @if (product.MaximumCountToBeOpened > 1)
                                        {
                                            <Badge Color="BadgeColor.Primary"
                                            IndicatorType="BadgeIndicatorType.RoundedPill">
                                                <i>@l["label-maximum-count-to-be-opened"]</i> @product.MaximumCountToBeOpened
                                            </Badge>
                                        }
                                    </div>
                                    <p class="fw-bold mb-0 text-body-secondary">
                                        @product.ShareProductCategory?.CategoryDisplayName
                                    </p>
                                </div>

                                @if (product.ProductDescription is not null)
                                {
                                    <p class="card-text mt-2"> @((MarkupString)product.ProductDescription)</p>
                                }

                                @if (product.UseLiveCoreRates)
                                {
                                    <h6 class="mt-3">Current Rates</h6>
                                    <div class="card-text mb-3">
                                        <div class="row">
                                            <div class="col col-6">@l["heading-rates-column-minimum-balance"]</div>
                                            <div class="col col-6">@l["heading-rates-column-annual-percentage-yield"]</div>
                                        </div>

                                        @foreach (var rate in realTimeDepositRates?.Accounts.FirstOrDefault(x => x.ProductId == product.Id)?.Rates ?? [])
                                        {
                                            <div class="row">
                                                <div class="col col-6">
                                                    @(rate.MinimumBalance.HasValue ? $"{rate.MinimumBalance.Value.ToString("C", new CultureInfo("en-US"))}" : l["text-rates-fallback-no-minimum-balance"])
                                                </div>
                                                <div class="col col-6">@rate.Rate.ToString("0.000")&percnt;</div>
                                            </div>
                                        }

                                        <div class="mt-2 small">@l["description-apy-helper"]</div>
                                    </div>
                                }
                                else if (!string.IsNullOrWhiteSpace(product.RatesUrl))
                                {
                                    <p>
                                        <a href="@product.RatesUrl" target="_blank">@l["link-current-rates"]</a>
                                    </p>
                                }
                                @if (input.SelectedShareProducts.Count(p => p.ApplicationShareProduct!.ShareProductId == product.Id) < product.MaximumCountToBeOpened)
                                {
                                    <Button Color="ButtonColor.Primary"
                                    @onclick="() => AddProduct(product)"
                                    Outline="true"
                                    Type="@ButtonType.Button">
                                        @l["product-add-button"]
                                    </Button>
                                }
                                else
                                {
                                    <Button Color="ButtonColor.Primary"
                                    Disabled="@true"
                                    Outline="true"
                                    Type="@ButtonType.Button">
                                        <i class="bi bi-check"></i> @l["product-in-cart-button"]
                                    </Button>
                                }
                            </div>
                        </div>
                    }
                </TabView>
            }
        </TabControl>
    }

    @if (loanProductCategories.Any())
    {
        <TabControl @ref="loanTabs">
            @foreach (var category in loanProductCategories)
            {
                <TabView Title="@category.CategoryDisplayName">
                    @if (!string.IsNullOrEmpty(category.HelperText))
                    {
                        <div>@category.HelperText</div>
                    }
                    @if ((@category.MinRequireSelections.HasValue && @category.MinRequireSelections > 0) && (category.MaximumSelections.HasValue && category.MaximumSelections > 0))
                    {
                        <div class="mb-3">@l["text-min-max-products-count", @category.MinRequireSelections, @category.CategoryDisplayName, @category.MaximumSelections]</div>
                    }
                    else if ((@category.MinRequireSelections.HasValue && @category.MinRequireSelections > 0) && (!category.MaximumSelections.HasValue || category.MaximumSelections == 0))
                    {
                        <div class="mb-3">@l["text-min-products-count", @category.MinRequireSelections, @category.CategoryDisplayName]</div>
                    }
                    else if ((!@category.MinRequireSelections.HasValue || @category.MinRequireSelections == 0) && (category.MaximumSelections.HasValue && category.MaximumSelections > 0))
                    {
                        <div class="mb-3">@l["text-max-products-count", @category.MaximumSelections, @category.CategoryDisplayName]</div>
                    }
                    @foreach (var product in loanProducts.Where(x => x.LoanProductCategoryId == category.Id))
                    {
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">@product.ProductDisplayName</h5>
                                <h6 class="card-subtitle mb-2 text-body-secondary">
                                    @product.LoanProductCategory!.CategoryDisplayName
                                </h6>

                                @if (product.ProductDescription is not null)
                                {
                                    <p class="card-text"> @((MarkupString)product.ProductDescription)</p>
                                }

                                @if (!input.SelectedLoanProducts.Contains(product))
                                {
                                    if (!hasSelectedLoanProduct)
                                    {
                                        <Button Color="ButtonColor.Primary"
                                        @onclick="() => AddProduct(product)"
                                        Outline="true"
                                        Type="@ButtonType.Button">
                                            @l["product-add-button"]
                                        </Button>
                                    }
                                }
                                else
                                {
                                    <Button Color="ButtonColor.Primary"
                                    Disabled="@true"
                                    @onclick="() => RemoveProduct(product)"
                                    Outline="true"
                                    Type="@ButtonType.Button">
                                        <i class="bi bi-check"></i> @l["product-in-cart-button"]
                                    </Button>
                                }
                            </div>
                        </div>
                    }
                </TabView>
            }
        </TabControl>
    }

    @* Selected Products *@

    <div class="my-4 p-3 rounded-3"
    style="border-style: dashed; border-color: rgba(var(--bs-body-color-rgb), 0.5)">
        <h4 class="gap-3 hstack">
            <i class="bi bi-cart4"></i>@l["cart-heading"]
        </h4>
        <p>@l["cart-description"]</p>
        <ul class="gap-2 list-unstyled m-0 vstack">
            @if (!input.SelectedShareProducts.Any() && !input.SelectedLoanProducts.Any())
            {
                <li class="card p-3 rounded-2">
                    <p class="mb-0">@l["cart-empty-fallback"]</p>
                </li>
            }

            @* Share Products *@
            @foreach (var product in input.SelectedShareProducts.OrderByDescending(x => x.ApplicationShareProduct!.IsRequiredProductInMultiple).ThenBy(x => x.ApplicationShareProduct!.ShareProductId))
            {
                <li class="card p-3 rounded-2">
                    <div class="align-items-start hstack justify-content-between">
                        <div>
                            <div class="align-items-start gap-2 hstack mb-1">
                                <h5 class="lh-1 m-0">@product.ApplicationShareProduct!.ShareProduct!.ProductDisplayName</h5>
                                <i>@(!string.IsNullOrWhiteSpace(product.ApplicationShareProduct!.Nickname) ? $"({product.ApplicationShareProduct!.Nickname})" : string.Empty)</i>
                                @if (product.ApplicationShareProduct!.IsRequiredProductInMultiple)
                                {
                                    <Badge Color="BadgeColor.Primary" IndicatorType="BadgeIndicatorType.RoundedPill">
                                        @sl["label-required-badge"]
                                    </Badge>
                                }
                            </div>
                            <p class="fw-bold mb-0 text-body-secondary">
                                @product.ApplicationShareProduct!.ShareProduct!.ShareProductCategory?.CategoryDisplayName
                            </p>
                        </div>
                        @if (!product.ApplicationShareProduct!.IsRequiredProductInMultiple)
                        {
                            <button aria-label="Remove Product"
                            class="btn px-2 py-1 rounded-1"
                            @onclick="() => RemoveProduct(product)"
                            type="button">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        }
                    </div>
                    @if (product.ApplicationShareProduct!.ShareProduct!.ProductDescription is not null)
                    {
                        <details>
                            <summary class="mt-2">@sl["button-see-details"]</summary>
                            <p class="card-text mt-2"> @((MarkupString)product.ApplicationShareProduct!.ShareProduct!.ProductDescription)</p>
                        </details>
                    }
                </li>
            }
            @* Loan Products *@
            @foreach (var product in input.SelectedLoanProducts)
            {
                <li class="card p-3 rounded-2">
                    <div class="align-items-start hstack justify-content-between">
                        <div>
                            <h5 class="lh-1 m-0 mb-1">@product.ProductDisplayName</h5>
                            <p class="fw-bold mb-0 text-body-secondary">@product.LoanProductCategory?.CategoryDisplayName</p>
                        </div>
                        <button aria-label="Remove Product"
                        class="btn px-2 py-1 rounded-1"
                        @onclick="() => RemoveProduct(product)"
                        type="button">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                    @if (product.ProductDescription is not null)
                    {
                        <details>
                            <summary class="mt-2">@sl["button-see-details"]</summary>
                            <p class="card-text mt-2"> @((MarkupString)product.ProductDescription)</p>
                        </details>
                    }
                </li>
            }
        </ul>
    </div>
    <div>
        <EditForm EditContext="editContext" FormName="AddProducts" OnValidSubmit="SubmitForm">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="d-flex justify-content-end">
                <Button Color="ButtonColor.Primary" Type="@ButtonType.Submit">@sl["button-continue"]</Button>
            </div>
        </EditForm>
    </div>
}

@code {

    private readonly Input input = new();
    private Guid appKey;
    private int applicationId;
    private InputFeature inputFeature = InputFeature.Create();
    private ProductFeature productFeature = ProductFeature.Create();

    private bool isLoading = true;
    private bool singleProductMode = false;
    private ShareProduct? singleShareProduct = null;
    private LoanProduct? singleLoanProduct = null;

    private IList<ShareProduct> shareProducts = [];
    private IList<ShareProductCategory> shareProductCategories = [];
    private RealTimeDepositRates? realTimeDepositRates;

    private IList<LoanProduct> loanProducts = [];
    private IList<LoanProductCategory> loanProductCategories = [];
    private bool hasSelectedLoanProduct => input.SelectedLoanProducts.Any();

    private EditContext editContext = default!;
    private ValidationMessageStore messageStore = default!;
    private TabControl? shareTabs;
    private TabControl? loanTabs;

    protected override void OnInitialized()
    {
        editContext = new EditContext(input);
        messageStore = new ValidationMessageStore(editContext);
        editContext.OnValidationRequested += (s, e) => messageStore.Clear();
        editContext.OnFieldChanged += (s, e) => messageStore.Clear(e.FieldIdentifier);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ValidateAndSetAppKey();
            await using var db = await dbFactory.CreateDbContextAsync();

            var applicationType = await db.UserApplications
                .Where(x => x.ApplicationKey == appKey)
                .Select(x => x.ProductApplicationTypeId)
                .FirstAsync();
            applicationId = await db.UserApplications
                .Where(x => x.ApplicationKey == appKey)
                .Select(x => x.Id)
                .FirstAsync();
            shareProducts = await db.ShareProducts
                .GetEnabledProducts()
                .WhereApplicationTypeIsLinked(applicationType)
                .Include(x => x.ShareProductCategory)
                .ToListAsync();

            loanProducts = await db.LoanProducts
                .GetEnabledProducts()
                .WhereApplicationTypeIsLinked(applicationType)
                .Include(x => x.LoanProductCategory)
                .ToListAsync();

            shareProductCategories = shareProducts.Select(x => x.ShareProductCategory!).DistinctBy(x => x.Id).ToList();
            loanProductCategories = loanProducts.Select(x => x.LoanProductCategory!).DistinctBy(x => x.Id).ToList();

            var existingShareSelections = await db.ApplicationShareProducts
                .Where(x => x.UserApplication!.ApplicationKey == appKey)
                .Include(applicationShareProduct => applicationShareProduct.ShareProduct)
                .ToListAsync();

            if (existingShareSelections.Any(x => x.ShareProduct!.IsRequiredProduct))
            {
                // Check if any existing share selection contain no required mark on the first item for any unsubmitted applications
                // for new multiple selections per product since IsRequiredProductInMultiple field added.
                var productsWithRequired = existingShareSelections
                    .Where(x => x.ShareProduct!.IsRequiredProduct)
                    .Select(x => x.ShareProduct!.Id)
                    .Distinct()
                    .ToList();
                foreach (var productId in productsWithRequired)
                {
                    var requiredProduct = existingShareSelections.OrderBy(x => x.Id).FirstOrDefault(x => x.ShareProductId == productId);
                    if (requiredProduct is not null && !requiredProduct.IsRequiredProductInMultiple)
                    {
                        requiredProduct.UpdateIsRequiredProductInMultiple(true);
                        await db.SaveChangesAsync();
                        StateHasChanged();
                    }
                }
            }

            var existingLoanSelections = await db.ApplicationLoanProducts
                .Where(x => x.UserApplication!.ApplicationKey == appKey)
                .ToListAsync();

            foreach (var product in existingShareSelections)
            {
                //Note: We check here in case the product has been unlinked from the application
                //while the application is in progress.
                var currentProduct = shareProducts.FirstOrDefault(x => x.Id == product.ShareProductId);

                if (currentProduct is null)
                {
                    db.Remove(product);
                    await db.SaveChangesAsync();
                    continue;
                }

                input.SelectedShareProducts.Add(ApplicationShareProductVM.Create(product));
            }

            foreach (var product in existingLoanSelections)
            {
                //Note: We check here in case the product has been unlinked from the application
                //while the application is in progress.
                var currentProduct = loanProducts.FirstOrDefault(x => x.Id == product.LoanProductId);

                if (currentProduct is null)
                {
                    db.Remove(product);
                    await db.SaveChangesAsync();
                    continue;
                }

                input.SelectedLoanProducts.Add(currentProduct);
            }

            foreach (var product in shareProducts.Where(x => x.IsRequiredProduct))
            {
                if (!input.SelectedShareProducts.Any(x => x.ApplicationShareProduct?.ShareProductId == product.Id))
                {
                    var requiredProduct = ApplicationShareProductVM.Create(applicationId, product, true);
                    input.SelectedShareProducts.Add(requiredProduct);
                }
            }

            /*
            * If there is only one product, don't use cart mode.
            */
            if (shareProducts.Count + loanProducts.Count == 1)
            {
                singleProductMode = true;
                singleShareProduct = shareProducts.FirstOrDefault();
                singleLoanProduct = loanProducts.FirstOrDefault();
            }

            isLoading = false;
            StateHasChanged();
            shareTabs?.ShowFirstTab();
            loanTabs?.ShowFirstTab();

            if (shareProducts.Any(x => x.UseLiveCoreRates))
            {
                realTimeDepositRates = await coreService.GetRealTimeDepositRatesAsync(CancellationToken.None);
                StateHasChanged();
            }
        }
    }

    private async Task SubmitForm()
    {
        foreach (var category in shareProductCategories)
        {
            var currentCategorySelections = input.SelectedShareProducts.Where(p => p.ApplicationShareProduct?.ShareProduct?.ShareProductCategoryId == category.Id).Count();

            if (category.MinRequireSelections.HasValue && currentCategorySelections < category.MinRequireSelections)
            {
                messageStore.Add(() => input.SelectedShareProducts!,
                    $"You must select at least {category.MinRequireSelections} products from {category.CategoryDisplayName}.");

                return;
            }

            if (category.MaximumSelections.HasValue && currentCategorySelections > category.MaximumSelections)
            {
                messageStore.Add(() => input.SelectedShareProducts!,
                    l[$"validation-maximum-products-count-per-category", category.MaximumSelections, category.CategoryDisplayName]);
                return;
            }
        }

        if (input.SelectedLoanProducts.Count <= 0 && input.SelectedShareProducts.Count <= 0)
        {
            messageStore.Add(() => input.SelectedShareProducts!, $"You must select at least one product.");
            return;
        }

        if (input.SelectedLoanProducts.Count > 1)
        {
            messageStore.Add(() => input.SelectedLoanProducts!, $"Only one loan product can be selected per application");
            return;
        }

        await using var db = await dbFactory.CreateDbContextAsync();
        var application = await db.UserApplications.FirstAsync(x => x.ApplicationKey == appKey);

        var existingShareSelections = await db.ApplicationShareProducts
            .Where(x => x.UserApplication!.ApplicationKey == appKey)
            .Include(applicationShareProduct => applicationShareProduct.QuestionnaireResponses)
            .ToListAsync();

        var existingLoanSelections = await db.ApplicationLoanProducts
            .Where(x => x.UserApplication!.ApplicationKey == appKey)
            .Include(applicationLoanProduct => applicationLoanProduct.QuestionnaireResponses)
            .ToListAsync();

        foreach (var product in input.SelectedShareProducts)
        {
            if (!existingShareSelections.Any(x => x.Id == product.ApplicationShareProduct?.Id))
            {
                var appProduct = ApplicationShareProduct.Create(application.Id, product.ApplicationShareProduct!.ShareProductId);
                db.Add(appProduct);
            }
        }

        foreach (var product in input.SelectedLoanProducts)
        {
            if (!existingLoanSelections.Any(x => x.LoanProductId == product.Id))
            {
                var appProduct = ApplicationLoanProduct.Create(application.Id, product.Id);
                db.Add(appProduct);
            }
        }

        foreach (var selection in existingShareSelections)
        {
            if (!input.SelectedShareProducts.Any(x => x.ApplicationShareProduct!.Id == selection.Id))
            {
                foreach (var questionnaireResponse in selection.QuestionnaireResponses ?? [])
                {
                    db.Remove(questionnaireResponse);
                }
                db.Remove(selection);
            }
        }

        foreach (var selection in existingLoanSelections)
        {
            if (!input.SelectedLoanProducts.Any(x => x.Id == selection.LoanProductId))
            {
                foreach (var questionnaireResponse in selection.QuestionnaireResponses ?? [])
                {
                    db.Remove(questionnaireResponse);
                }
                db.Remove(selection);
            }
        }

        application.SetStep(UserApplicationStepType.Products);
        await db.SaveChangesAsync();

        await applicationStepCompletionManager.MarkStepAsCompletedAsync(UserApplicationStepType.Products);

        nav.NavigateTo("/applications/products/questionnaires");
    }

    private async Task AddProduct(ShareProduct product)
    {
        await Task.CompletedTask;
        var addedProduct = ApplicationShareProductVM.Create(applicationId, product, false);
        // Only allow one required item for each product if not set.
        if (product.IsRequiredProduct && !input.SelectedShareProducts.Any(x => x.ApplicationShareProduct!.IsRequiredProductInMultiple && x.ApplicationShareProduct.ShareProductId != product.Id))
        {
            addedProduct!.ApplicationShareProduct!.UpdateIsRequiredProductInMultiple(false);
        }
        input.SelectedShareProducts.Add(addedProduct);
    }

    private async Task AddProduct(LoanProduct product)
    {
        await Task.CompletedTask;
        input.SelectedLoanProducts.Add(product);
    }

    private async Task RemoveProduct(ApplicationShareProductVM appProduct)
    {
        await Task.CompletedTask;
        var existingProduct = input.SelectedShareProducts.FirstOrDefault(x => x.ApplicationShareProduct?.ShareProductId == appProduct.ApplicationShareProduct?.ShareProductId && x.ApplicationShareProduct.IsRequiredProductInMultiple.Equals(false));
        input.SelectedShareProducts.Remove(existingProduct!);
    }

    private async Task RemoveProduct(LoanProduct product)
    {
        await Task.CompletedTask;
        input.SelectedLoanProducts.Remove(product);
    }

    private async Task SelectSingleProduct(ShareProduct product)
    {
        await using var db = await dbFactory.CreateDbContextAsync();
        var application = await db.UserApplications.FirstAsync(x => x.ApplicationKey == appKey);

        var existingShareSelections = await db.ApplicationShareProducts
            .Where(x => x.UserApplication!.ApplicationKey == appKey)
            .Include(applicationShareProduct => applicationShareProduct.QuestionnaireResponses)
            .ToListAsync();

        var existingLoanSelections = await db.ApplicationLoanProducts
            .Where(x => x.UserApplication!.ApplicationKey == appKey)
            .Include(applicationLoanProduct => applicationLoanProduct.QuestionnaireResponses)
            .ToListAsync();

        var appProduct = ApplicationShareProduct.Create(application.Id, product.Id);
        db.Add(appProduct);
        db.RemoveRange(existingShareSelections);
        db.RemoveRange(existingLoanSelections);
        db.RemoveRange(db.QuestionnaireResponses
            .Where(x => x.UserApplicationId == application.Id)
            .Where(x => x.QuestionnaireLevel == QuestionnaireLevel.Product));

        application.SetStep(UserApplicationStepType.Products);
        await db.SaveChangesAsync();

        await applicationStepCompletionManager.MarkStepAsCompletedAsync(UserApplicationStepType.Products);

        nav.NavigateTo("/applications/products/questionnaires");

    }

    private async Task SelectSingleProduct(LoanProduct product)
    {
        await using var db = await dbFactory.CreateDbContextAsync();
        var application = await db.UserApplications.FirstAsync(x => x.ApplicationKey == appKey);

        var existingShareSelections = await db.ApplicationShareProducts
            .Where(x => x.UserApplication!.ApplicationKey == appKey)
            .ToListAsync();

        var existingLoanSelections = await db.ApplicationLoanProducts
            .Where(x => x.UserApplication!.ApplicationKey == appKey)
            .ToListAsync();

        var appProduct = ApplicationLoanProduct.Create(application.Id, product.Id);
        db.Add(appProduct);
        db.RemoveRange(existingShareSelections);
        db.RemoveRange(existingLoanSelections);
        db.RemoveRange(db.QuestionnaireResponses
            .Where(x => x.UserApplicationId == application.Id)
            .Where(x => x.QuestionnaireLevel == QuestionnaireLevel.Product));

        application.SetStep(UserApplicationStepType.Products);
        await db.SaveChangesAsync();

        await applicationStepCompletionManager.MarkStepAsCompletedAsync(UserApplicationStepType.Products);

        nav.NavigateTo("/applications/products/questionnaires");
    }

    private async Task ValidateAndSetAppKey()
    {
        var key = await stateProvider.GetCurrentApplicationKeyAsync();

        if (key is null)
        {
            nav.NavigateTo("/");
            return;
        }

        appKey = key.Value;
    }

    private class Input
    {
        [Required]
        public IList<ApplicationShareProductVM> SelectedShareProducts { get; set; } = [];

        [Required]
        public IList<LoanProduct> SelectedLoanProducts { get; set; } = [];

        public IList<NicknameOption> ShareNicknameOptions { get; set; } = [];
    }

    private record NicknameOption
    {
        public int Id { get; init; }
        public int ProductId { get; init; }
        public string DisplayName { get; init; } = string.Empty;

        [MaxLength(30, ErrorMessage = "Maximum 30 characters")]
        public string? Nickname { get; set; }
    }

    private class ApplicationShareProductVM
    {
        public Guid Id { get; internal set; }
        public ApplicationShareProduct? ApplicationShareProduct { get; internal set; }

        public static ApplicationShareProductVM Create(ApplicationShareProduct product)
        {
            return new ApplicationShareProductVM
            {
                Id = Guid.NewGuid(),
                ApplicationShareProduct = product
            };
        }

        public static ApplicationShareProductVM Create(int applicationId, ShareProduct product, bool required)
        {
            var appShareProduct = ApplicationShareProduct.Create(applicationId, product.Id);
            appShareProduct.SetShareProduct(product);
            appShareProduct.UpdateIsRequiredProductInMultiple(required);
            return new ApplicationShareProductVM
            {
                Id = Guid.NewGuid(),
                ApplicationShareProduct = appShareProduct
            };
        }
    }
}