@page "/ApplicationConfiguration/products/loanCategories/edit/{Id:int}"
@using Microsoft.AspNetCore.Authorization
@using Aloha.Domain.Services.AdminAudit
@using Aloha.Domain.Identity.AdminUsers.Activities
@using Aloha.Domain.Identity.AdminUsers
@using Microsoft.AspNetCore.Identity
@using Aloha.Domain.Services.Translations
@attribute [Authorize(Roles = "MahaloAdmin, MasterAdmin, Audit")]
@inject AuthenticationStateProvider authStateProvider
@inject IDbContextFactory<AlohaDb> dbFactory
@inject NavigationManager nav
@inject IAdminActivityService adminActivityService
@inject UserManager<AdminUser> UserManager
@inject ILanguageConfigurationService LanguageConfigService
@rendermode InteractiveServer

<h3>Edit Loan Product Category</h3>

<EditForm class="pb-3"
          Context="editContext"
          disabled="@isReadOnly"
          EditContext="editContext"
          FormName="EditLoanProductCategory"
          OnValidSubmit="SubmitFormAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    @* Language selector and bulk translate button - all handled by BulkTranslateButton *@
    <BulkTranslateButton @ref="bulkTranslateButton"
                        FieldIdPrefix="loancategory"
                        Fields="@GetFieldsMap()"
                        FieldsChanged="@((Dictionary<string, MultilingualField> fields) => { input.DisplayName = fields["Display Name"]; input.HelperText = fields["Helper Text"]; StateHasChanged(); })"
                        SelectedCultureChanged="@((string culture) => StateHasChanged())" />

    @* Multi-language input for Display Name *@
    <MultiLanguageInput Label="Display Name"
                       FieldId="displayName"
                       Placeholder="Enter display name"
                       Rows="1"
                       IsDisabled="@isReadOnly"
                       Field="@input.DisplayName"
                       FieldChanged="@((MultilingualField f) => input.DisplayName = f)"
                       SelectedCultureOverride="@(bulkTranslateButton?.CurrentCulture)"
                       SelectedCultureOverrideChanged="@((string culture) => StateHasChanged())" />

    @* Multi-language input for Helper Text *@
    <MultiLanguageInput Label="Helper Text"
                       FieldId="helperText"
                       Placeholder="Enter helper text"
                       Rows="3"
                       IsDisabled="@isReadOnly"
                       Field="@input.HelperText"
                       FieldChanged="@((MultilingualField f) => input.HelperText = f)"
                       SelectedCultureOverride="@(bulkTranslateButton?.CurrentCulture)"
                       SelectedCultureOverrideChanged="@((string culture) => StateHasChanged())" />

    <div class="mb-3">
        <label class="form-label" for="minRequired">Minimum Required Selections</label>
        <InputNumber @bind-Value="input.MinRequireSelections"
                     class="form-control"
                     disabled="@true"
                     id="minRequired"
                     type="text" />
        <p class="form-text">Loan products cannot be marked as required products</p>
        <ValidationMessage For="() => input.MinRequireSelections" />
    </div>

    <div class="mb-3">
        <label class="form-label" for="maxSelections">Maximum Selections</label>
        <InputNumber @bind-Value="input.MaximumSelections"
                     class="form-control"
                     disabled="@true"
                     id="maxSelections"
                     type="text" />
        <p class="form-text">A maximum of one loan is selectable per loan application</p>
        <ValidationMessage For="() => input.MaximumSelections" />
    </div>

    @if (!isReadOnly)
    {
        <div class="flex-row gap-2 mb-3">
            <SaveConfirmationMessage @ref="messageRef" Title="Loan Category" RouteAfterSaved="/ApplicationConfiguration/products" />
        </div>
    }
</EditForm>

@code {

    [Parameter]
    public int? Id { get; set; }

    private SaveConfirmationMessage? messageRef;
    private Input input { get; set; } = new();
    private EditContext editContext = default!;
    private ValidationMessageStore messageStore = default!;
    private bool isReadOnly = true;
    private AdminUser? AdminUser = default!;
    private BulkTranslateButton? bulkTranslateButton;

    protected override void OnInitialized()
    {
        editContext = new EditContext(input);
        messageStore = new ValidationMessageStore(editContext);
        editContext.OnValidationRequested += (s, e) => messageStore.Clear();
        editContext.OnFieldChanged += (s, e) => messageStore.Clear(e.FieldIdentifier);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckRoleAndUpdateReadOnlyFlagAsync();
            await LoadDataAsync();
        }
    }

    private Dictionary<string, MultilingualField> GetFieldsMap()
    {
        return new Dictionary<string, MultilingualField>
        {
            { "Display Name", input.DisplayName },
            { "Helper Text", input.HelperText }
        };
    }

    private async Task LoadDataAsync()
    {
        await using var db = await dbFactory.CreateDbContextAsync();
        var category = await db.LoanProductCategories.FirstOrDefaultAsync(option => option.Id == Id);

        if (category is null)
        {
            nav.NavigateTo("/ApplicationConfiguration/products");
            return;
        }

        // Load translations using MultilingualFieldHelper
        var resourceKey = $"LoanProductCategory.{Id}";
        var enabledLanguages = await LanguageConfigService.GetEnabledLanguagesAsync();
        var primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
        
        await MultilingualFieldHelper.LoadTranslationsAsync(
            input.DisplayName, db, resourceKey, "CategoryDisplayName", 
            primaryLanguage, category.CategoryDisplayName, enabledLanguages);
        
        await MultilingualFieldHelper.LoadTranslationsAsync(
            input.HelperText, db, resourceKey, "HelperText", 
            primaryLanguage, category.HelperText, enabledLanguages);

        // Load all other property values
        input.MinRequireSelections = 0;
        input.MaximumSelections = 1;

        StateHasChanged();
    }

    private async Task CheckRoleAndUpdateReadOnlyFlagAsync()
    {
        var authUser = (await authStateProvider.GetAuthenticationStateAsync()).User;
        AdminUser = await UserManager.FindByEmailAsync(authUser.Identity!.Name!);
        isReadOnly = !(authUser.IsInRole("MahaloAdmin") || authUser.IsInRole("MasterAdmin"));
    }

    private async Task SubmitFormAsync()
    {
        if (input.MinRequireSelections > input.MaximumSelections)
        {
            messageStore.Add(() => input.MinRequireSelections!, "Minimum selections must not exceed maximum selections");
            return;
        }

        if (input.MaximumSelections is > 1)
        {
            messageStore.Add(() => input.MaximumSelections!, "Maximum selections must be less than or equal to 1");
            return;
        }
        try
        {
            messageRef?.SetSaving(true);
            await using var db = await dbFactory.CreateDbContextAsync();
            var category = await db.LoanProductCategories.FirstAsync(x => x.Id == Id);
            var originalConfig = db.Entry(category).CurrentValues.Clone().ToObject();

            // Get primary language to determine save strategy
            var primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
            
            // Save translations using MultilingualFieldHelper
            var resourceKey = $"LoanProductCategory.{Id}";
            
            var englishDisplayName = await MultilingualFieldHelper.SaveTranslationsAsync(
                input.DisplayName, db, resourceKey, "CategoryDisplayName", primaryLanguage);
            
            var englishHelperText = await MultilingualFieldHelper.SaveTranslationsAsync(
                input.HelperText, db, resourceKey, "HelperText", primaryLanguage);
            
            category.Update(englishDisplayName, englishHelperText!, input.MinRequireSelections, input.MaximumSelections);
            await db.SaveChangesAsync();

            // Update cache
            MultilingualFieldHelper.UpdateCache(input.DisplayName, resourceKey, "CategoryDisplayName", primaryLanguage);
            MultilingualFieldHelper.UpdateCache(input.HelperText, resourceKey, "HelperText", primaryLanguage);

            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Products, $"Loan product category Id: {category.Id} was edited: ", originalConfig, category, new List<string> { nameof(category.DeleteDateUtc), nameof(category.LoanProducts) });
            messageRef?.Notify(new(ToastType.Success, string.Empty));
        }
        catch
        {
            messageRef?.Notify(new(ToastType.Warning, string.Empty));
        }
    }

    private class Input
    {
        public MultilingualField DisplayName { get; set; } = new();
        public MultilingualField HelperText { get; set; } = new();

        public int? MinRequireSelections { get; set; }
        public int? MaximumSelections { get; set; }
    }
}