@page "/customization/questionnaires/edit/{Id:int}"
@using Aloha.Domain.Questionnaires
@using Microsoft.AspNetCore.Authorization
@using Aloha.Domain.Services.AdminAudit
@using Aloha.Domain.Identity.AdminUsers.Activities
@using Aloha.Domain.Identity.AdminUsers
@using Microsoft.AspNetCore.Identity
@using Aloha.Domain.Services.Translations
@using System.Globalization
@using Aloha.Domain.Localization
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Roles = "MahaloAdmin, MasterAdmin, FormManager, Audit")]
@inject AuthenticationStateProvider authStateProvider
@inject IDbContextFactory<AlohaDb> DbFactory
@inject NavigationManager Nav
@inject IAdminActivityService adminActivityService
@inject UserManager<AdminUser> UserManager
@inject ITranslationHelper TranslationHelper
@inject ILanguageConfigurationService LanguageConfigService
@rendermode InteractiveServer

<h3>Edit Questionnaire</h3>
<p>Submission of this form will update an existing questionnaire</p>
<p class="form-text">* Indicate Required Fields</p>
@if (questionnaireToEdit is not null)
{
    <EditForm EditContext="multilanguageEditContext">
        @* Bulk translate button at the top *@
        <BulkTranslateButton @ref="bulkTranslateButton"
                            SelectedCulture="@bulkSelectedCulture"
                            SelectedCultureChanged="@OnBulkCultureChanged"
                            OnBulkTranslate="@OnBulkTranslateAll"
                            OnBulkTranslateAllLanguages="@OnBulkTranslateAllLanguages"
                            GetFieldsWithExistingText="@GetFieldsWithExistingText"
                            HasEnglishTextFunc="@HasEnglishText" />

        @* Multi-language input for Name *@
        <MultiLanguageInput Label="Name"
                           FieldId="questionnaireName"
                           Placeholder="Enter questionnaire name"
                           Rows="1"
                           IsDisabled="@isReadOnly"
                           EnglishValue="@questionnaireName"
                           EnglishValueChanged="@OnNameChanged"
                           Translations="@nameTranslations"
                           TranslationsChanged="@((Dictionary<string, string> trans) => nameTranslations = trans)"
                           SelectedCultureOverride="@bulkSelectedCulture"
                           SelectedCultureOverrideChanged="@OnBulkCultureChanged" />

        @* Multi-language input for Description *@
        <MultiLanguageInput Label="Description"
                           FieldId="questionnaireDescription"
                           Placeholder="Enter questionnaire description"
                           Rows="3"
                           IsDisabled="@isReadOnly"
                           EnglishValue="@questionnaireDescription"
                           EnglishValueChanged="@OnDescriptionChanged"
                           Translations="@descriptionTranslations"
                           TranslationsChanged="@((Dictionary<string, string> trans) => descriptionTranslations = trans)"
                           SelectedCultureOverride="@bulkSelectedCulture"
                           SelectedCultureOverrideChanged="@OnBulkCultureChanged" />
    </EditForm>

    <QuestionnaireForm 
    @ref="qForm"
    InitialValues="questionnaireToEdit"
    IsReadOnly="isReadOnly"
    OnCancel="HandleCancel"
    OnSubmit="HandleSubmit"
    />
}

@code {

    [Parameter]
    public int Id { get; set; }

    private Questionnaire? questionnaireToEdit;
    private QuestionnaireForm? qForm;
    private bool isReadOnly = true;
    private AdminUser? AdminUser = default!;
    private string bulkSelectedCulture = "en-US"; // Will be initialized to primary language
    private string primaryLanguage = "en-US";
    private BulkTranslateButton? bulkTranslateButton;
    private string questionnaireName = string.Empty;
    private string questionnaireDescription = string.Empty;
    private Dictionary<string, string> nameTranslations = new();
    private Dictionary<string, string> descriptionTranslations = new();
    private EditContext multilanguageEditContext = default!;

    protected override async Task OnInitializedAsync()
    {
        await CheckRoleAndUpdateReadOnlyFlagAsync();
        primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
        bulkSelectedCulture = primaryLanguage;
        
        // Initialize EditContext for multilanguage inputs
        var multilanguageModel = new { Name = questionnaireName, Description = questionnaireDescription };
        multilanguageEditContext = new EditContext(multilanguageModel);
        
        await using var db = await DbFactory.CreateDbContextAsync();

        questionnaireToEdit = await db.Questionnaires
            .Include(questionnaire => questionnaire.Questions)!
            .ThenInclude(question => question.MultipleChoiceOptions)!
            .ThenInclude(multipleChoiceOption => multipleChoiceOption.DependentMultipleChoiceOptions)
            .Include(questionnaire => questionnaire.QuestionGroups)
            .Include(questionnaire => questionnaire.QuestionnaireApplicationTypeLinks)
            .Include(questionnaire => questionnaire.QuestionnaireShareProductLinks)
            .Include(questionnaire => questionnaire.QuestionnaireLoanProductLinks)
            .FirstOrDefaultAsync(q => q.Id == Id);

        if (questionnaireToEdit is null)
        {
            Nav.NavigateTo("/customization/questionnaires");
            return;
        }

        await LoadTranslations();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
            bulkSelectedCulture = primaryLanguage;
            StateHasChanged();
        }
    }

    private async Task CheckRoleAndUpdateReadOnlyFlagAsync()
    {
        var authUser = (await authStateProvider.GetAuthenticationStateAsync()).User;
        AdminUser = await UserManager.FindByEmailAsync(authUser.Identity!.Name!);

        isReadOnly = !(
            authUser.IsInRole("MahaloAdmin") ||
            authUser.IsInRole("MasterAdmin") ||
            authUser.IsInRole("FormManager"));
    }

    private void HandleCancel()
    {
        Nav.NavigateTo("/customization/questionnaires");
    }

    private void OnNameChanged(string value)
    {
        questionnaireName = value;
    }

    private void OnDescriptionChanged(string value)
    {
        questionnaireDescription = value;
    }

    private async Task OnBulkCultureChanged(string culture)
    {
        bulkSelectedCulture = culture;
        StateHasChanged();
    }

    private bool HasEnglishText()
    {
        return !string.IsNullOrWhiteSpace(questionnaireName) ||
               !string.IsNullOrWhiteSpace(questionnaireDescription);
    }

    private List<string> GetFieldsWithExistingText()
    {
        var fields = new List<string>();
        if (nameTranslations.TryGetValue(bulkSelectedCulture, out var nameTrans) && !string.IsNullOrWhiteSpace(nameTrans))
        {
            fields.Add("Name");
        }
        if (descriptionTranslations.TryGetValue(bulkSelectedCulture, out var descTrans) && !string.IsNullOrWhiteSpace(descTrans))
        {
            fields.Add("Description");
        }
        return fields;
    }

    private async Task OnBulkTranslateAll()
    {
        bulkTranslateButton?.ClearError();
        
        if (string.IsNullOrWhiteSpace(bulkSelectedCulture) || bulkSelectedCulture == primaryLanguage)
        {
            return;
        }

        var errors = new List<string>();

        // Translate Name
        if (!string.IsNullOrWhiteSpace(questionnaireName))
        {
            try
            {
                var translated = await TranslationHelper.TranslateAsync(questionnaireName, bulkSelectedCulture);
                if (translated != null)
                {
                    nameTranslations[bulkSelectedCulture] = translated;
                }
                else
                {
                    errors.Add($"Name: Translation failed (no result returned)");
                }
            }
            catch (Exception ex)
            {
                errors.Add($"Name: {ex.Message}");
            }
        }

        // Translate Description
        if (!string.IsNullOrWhiteSpace(questionnaireDescription))
        {
            try
            {
                var translated = await TranslationHelper.TranslateAsync(questionnaireDescription, bulkSelectedCulture);
                if (translated != null)
                {
                    descriptionTranslations[bulkSelectedCulture] = translated;
                }
                else
                {
                    errors.Add($"Description: Translation failed (no result returned)");
                }
            }
            catch (Exception ex)
            {
                errors.Add($"Description: {ex.Message}");
            }
        }

        if (errors.Any())
        {
            var isApiConfigured = TranslationHelper.IsTranslationApiConfigured();
            var errorMessage = isApiConfigured 
                ? $"Some translations failed: {string.Join("; ", errors)}. Please check your API configuration."
                : "Translation API is not configured. Please configure Azure Translator or Google Translate API keys in appsettings.json.";
            bulkTranslateButton?.SetError(errorMessage);
        }

        StateHasChanged();
    }

    private async Task OnBulkTranslateAllLanguages()
    {
        bulkTranslateButton?.ClearError();
        
        var availableLanguages = await TranslationHelper.GetAvailableLanguagesAsync();
        var errors = new List<string>();

        // Translate Name to all languages
        if (!string.IsNullOrWhiteSpace(questionnaireName))
        {
            foreach (var lang in availableLanguages)
            {
                if (lang == primaryLanguage) continue; // Skip primary language
                
                try
                {
                    var translated = await TranslationHelper.TranslateAsync(questionnaireName, lang);
                    if (translated != null)
                    {
                        nameTranslations[lang] = translated;
                    }
                    else
                    {
                        errors.Add($"Name ({CultureInfo.GetCultureInfo(lang).DisplayName}): Translation failed");
                    }
                }
                catch (Exception ex)
                {
                    errors.Add($"Name ({CultureInfo.GetCultureInfo(lang).DisplayName}): {ex.Message}");
                }
            }
        }

        // Translate Description to all languages
        if (!string.IsNullOrWhiteSpace(questionnaireDescription))
        {
            foreach (var lang in availableLanguages)
            {
                if (lang == primaryLanguage) continue; // Skip primary language
                
                try
                {
                    var translated = await TranslationHelper.TranslateAsync(questionnaireDescription, lang);
                    if (translated != null)
                    {
                        descriptionTranslations[lang] = translated;
                    }
                    else
                    {
                        errors.Add($"Description ({CultureInfo.GetCultureInfo(lang).DisplayName}): Translation failed");
                    }
                }
                catch (Exception ex)
                {
                    errors.Add($"Description ({CultureInfo.GetCultureInfo(lang).DisplayName}): {ex.Message}");
                }
            }
        }

        if (errors.Any())
        {
            var isApiConfigured = TranslationHelper.IsTranslationApiConfigured();
            var errorMessage = isApiConfigured 
                ? $"Some translations failed: {string.Join("; ", errors)}. Please check your API configuration."
                : "Translation API is not configured. Please configure Azure Translator or Google Translate API keys in appsettings.json.";
            bulkTranslateButton?.SetError(errorMessage);
        }

        StateHasChanged();
    }

    private async Task LoadTranslations()
    {
        if (questionnaireToEdit == null) return;

        await using var db = await DbFactory.CreateDbContextAsync();

        // Build resource key: "Questionnaire.{Id}"
        var resourceKey = $"Questionnaire.{Id}";
        
        // Load existing translations from LocalizationStrings table
        var translations = await db.Set<LocalizationString>()
            .Where(s => s.ResourceKey == resourceKey 
                     && (s.Key == "Name" || s.Key == "Description"))
            .Include(s => s.LocalizationCulture)
            .ToListAsync();
        
        // Get all enabled languages to know which translations to load
        var enabledLanguages = await LanguageConfigService.GetEnabledLanguagesAsync();
        
        // Load primary language values
        if (primaryLanguage.StartsWith("en"))
        {
            // Primary language is English, so entity properties contain the primary language value
            questionnaireName = questionnaireToEdit.Name ?? "";
            questionnaireDescription = questionnaireToEdit.Description ?? "";
        }
        else
        {
            // Primary language is Spanish, so we need to load Spanish from database
            // If Spanish translation exists, use it; otherwise use English as fallback
            var spanishName = translations
                .FirstOrDefault(t => t.LocalizationCulture?.Culture == primaryLanguage && t.Key == "Name");
            questionnaireName = spanishName?.DefaultText ?? questionnaireToEdit.Name ?? "";
            
            var spanishDescription = translations
                .FirstOrDefault(t => t.LocalizationCulture?.Culture == primaryLanguage && t.Key == "Description");
            questionnaireDescription = spanishDescription?.DefaultText ?? questionnaireToEdit.Description ?? "";
        }
        
        // Load all non-primary language translations into the Translations dictionary
        foreach (var trans in translations)
        {
            var culture = trans.LocalizationCulture?.Culture;
            if (string.IsNullOrWhiteSpace(culture))
            {
                continue;
            }
            
            // Skip primary language culture - it's stored in questionnaireName/Description
            if (culture == primaryLanguage)
            {
                continue;
            }
            
            // Only load translations for enabled languages
            if (!enabledLanguages.Contains(culture))
            {
                continue;
            }
            
            if (trans.Key == "Name")
            {
                nameTranslations[culture] = trans.DefaultText ?? "";
            }
            else if (trans.Key == "Description")
            {
                descriptionTranslations[culture] = trans.DefaultText ?? "";
            }
        }
        
        // If primary language is not English, put English values (from entity properties) into Translations dictionary
        // so they can be displayed when English is selected
        if (!primaryLanguage.StartsWith("en"))
        {
            var englishCulture = enabledLanguages.FirstOrDefault(l => l.StartsWith("en"));
            if (englishCulture != null)
            {
                // Use entity property values for English (they're always in English)
                // Only set if not already loaded from database
                if (!nameTranslations.ContainsKey(englishCulture))
                {
                    nameTranslations[englishCulture] = questionnaireToEdit.Name ?? "";
                }
                if (!descriptionTranslations.ContainsKey(englishCulture))
                {
                    descriptionTranslations[englishCulture] = questionnaireToEdit.Description ?? "";
                }
            }
        }

        // Note: We cannot set questionnaireToEdit.Name/Description directly due to internal set accessors
        // The multilanguage values will be merged into QuestionnaireForm.Input in HandleSubmit
    }

    private async Task HandleSubmit(QuestionnaireForm.Input values)
    {
        try
        {
            qForm?.SetSaving(true);
            var questionnaireId = questionnaireToEdit!.Id;
            
            // Merge multilanguage values into form values
            // Use primary language values from our multilanguage inputs
            values.Name = questionnaireName;
            values.Description = questionnaireDescription;
            
            await using var db = await DbFactory.CreateDbContextAsync();
            await DeleteQuestionnaireLinkedEntities(db, questionnaireId);
            await UpdateQuestionnaire(db, questionnaireId, values);
            qForm?.Notify(new(ToastType.Success, string.Empty));
        }
        catch
        {
            qForm?.Notify(new(ToastType.Warning, string.Empty));
        }
    }

    private async Task UpdateQuestionnaire(AlohaDb db, int questionnaireId, QuestionnaireForm.Input values)
    {
        var questionnaire = await db.Questionnaires
               .Include(q => q.Questions!)
               .ThenInclude(q => q.QuestionGroup)
               .Include(q => q.Questions!)
               .ThenInclude(q => q.MultipleChoiceOptions!)
               .ThenInclude(q => q.DependentMultipleChoiceOptions)
               .Include(q => q.QuestionGroups)
               .Include(questionnaire => questionnaire.QuestionnaireApplicationTypeLinks)
               .Include(questionnaire => questionnaire.QuestionnaireShareProductLinks)
               .Include(questionnaire => questionnaire.QuestionnaireLoanProductLinks)
               .FirstAsync(q => q.Id == questionnaireId);
        var oldConfig = db.Entry(questionnaire).CurrentValues.Clone().ToObject();

        // Create Ungrouped Questions
        foreach (var draftQuestion in values.UngroupedQuestions)
        {
            var question = Question.Create(
                questionnaire.Id,
                draftQuestion.Name,
                draftQuestion.IsRequired,
                draftQuestion.SortOrder,
                draftQuestion.Type,
                draftQuestion.Description,
                questionGroupId: null);

            db.Add(question);
            await db.SaveChangesAsync();

            var excludedQuestionProperties = new List<string> { nameof(question.QuestionnaireId), nameof(question.QuestionGroupId), nameof(question.MultipleChoiceOptions), nameof(question.Questionnaire), nameof(question.QuestionGroup) };
            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Question created for questionnaire {questionnaire.Name}: ", oldConfig, question, excludedQuestionProperties);

            // Create multiple choice options
            if (draftQuestion.Type is QuestionType.SingleSelect or QuestionType.MultipleSelect &&
                draftQuestion.MultipleChoiceOptions is not null &&
                draftQuestion.MultipleChoiceOptions.Any())
            {
                foreach (var draftOption in draftQuestion.MultipleChoiceOptions!)
                {
                    var option = MultipleChoiceOption.Create(
                        draftOption.Name,
                        draftOption.SortOrder,
                        draftOption.DependentQuestionType,
                        question.Id,
                        draftOption.DependentQuestionName);

                    db.Add(option);
                    await db.SaveChangesAsync();

                    var excludedOptionProperties = new List<string> { nameof(option.DependentQuestionName), nameof(option.QuestionId), nameof(option.DependentMultipleChoiceOptions) };
                    await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Option created for question {question.Name}: ", option, excludedOptionProperties);

                    if (draftOption.HasDependentQuestion &&
                        draftOption.DependentQuestionType is DependentQuestionType.MultipleSelect or DependentQuestionType.SingleSelect &&
                        draftOption.DependentMultipleChoiceOptions is not null &&
                        draftOption.DependentMultipleChoiceOptions.Any())
                    {
                        foreach (var draftDependentOption in draftOption.DependentMultipleChoiceOptions!)
                        {
                            var dependentOption = DependentMultipleChoiceOption.Create(
                                draftDependentOption.Name,
                                draftDependentOption.SortOrder,
                                draftDependentOption.HasFreeFormField,
                                option.Id,
                                draftDependentOption.FreeFormFieldDescription);

                            db.Add(dependentOption);
                            var excludedDependentOptionProperties = new List<string> { nameof(dependentOption.MultipleChoiceOptionId), nameof(dependentOption.MultipleChoiceOption) };
                            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Dependent Option created for option {option.Name}: ", dependentOption, excludedDependentOptionProperties);
                        }

                        await db.SaveChangesAsync();
                    }
                }

                await db.SaveChangesAsync();
            }
        }

        await db.SaveChangesAsync();

        // Create Question Groups
        foreach (var draftQuestionGroup in values.QuestionGroups)
        {
            var questionGroup = QuestionGroup.Create(
                draftQuestionGroup.Name!,
                draftQuestionGroup.SortOrder,
                questionnaire.Id,
                draftQuestionGroup.Description);

            db.Add(questionGroup);
            await db.SaveChangesAsync();

            var excludedQuestionGroupProperties = new List<string> { nameof(questionGroup.QuestionnaireId), nameof(questionGroup.Questions), nameof(questionGroup.Questionnaire) };
            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Question group created for questionnaire {questionnaire.Name}: ", questionGroup, excludedQuestionGroupProperties);

            // Create Grouped Questions
            foreach (var draftQuestion in draftQuestionGroup.Questions)
            {
                var question = Question.Create(
                    questionnaire.Id,
                    draftQuestion.Name,
                    draftQuestion.IsRequired,
                    draftQuestion.SortOrder,
                    draftQuestion.Type,
                    draftQuestion.Description,
                    questionGroup.Id);

                db.Add(question);
                await db.SaveChangesAsync();

                // Create multiple choice options
                if (draftQuestion.Type is QuestionType.SingleSelect or QuestionType.MultipleSelect &&
                    draftQuestion.MultipleChoiceOptions is not null &&
                    draftQuestion.MultipleChoiceOptions.Any())
                {
                    foreach (var draftOption in draftQuestion.MultipleChoiceOptions!)
                    {
                        var option = MultipleChoiceOption.Create(
                            draftOption.Name,
                            draftOption.SortOrder,
                            draftOption.DependentQuestionType,
                            question.Id,
                            draftOption.DependentQuestionName);

                        db.Add(option);
                        await db.SaveChangesAsync();

                        var excludedQuestionProperties = new List<string> { nameof(question.QuestionnaireId), nameof(question.QuestionGroupId), nameof(question.MultipleChoiceOptions), nameof(question.Questionnaire), nameof(question.QuestionGroup) };
                        await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Grouped Question created for questionnaire {questionnaire.Name}: ", question, excludedQuestionProperties);

                        if (draftOption.HasDependentQuestion &&
                            draftOption.DependentQuestionType is DependentQuestionType.MultipleSelect or DependentQuestionType.SingleSelect &&
                            draftOption.DependentMultipleChoiceOptions is not null &&
                            draftOption.DependentMultipleChoiceOptions.Any())
                        {
                            foreach (var draftDependentOption in draftOption.DependentMultipleChoiceOptions!)
                            {
                                var dependentOption = DependentMultipleChoiceOption.Create(
                                    draftDependentOption.Name,
                                    draftDependentOption.SortOrder,
                                    draftDependentOption.HasFreeFormField,
                                    option.Id,
                                    draftDependentOption.FreeFormFieldDescription);

                                db.Add(dependentOption);

                                var excludedDependentOptionProperties = new List<string> { nameof(dependentOption.MultipleChoiceOptionId), nameof(dependentOption.MultipleChoiceOption) };
                                await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Dependent Option created for option {option.Name}: ", dependentOption, excludedDependentOptionProperties);
                            }
                            await db.SaveChangesAsync();
                        }
                    }

                    await db.SaveChangesAsync();
                }
            }

            await db.SaveChangesAsync();
        }

        // Create Application Type Links
        foreach (var appTypeCheckbox in values.ApplicationTypes.Where(x => x.IsChecked))
        {
            var link = QuestionnaireApplicationTypeLink.Create(
                questionnaire.Id,
                appTypeCheckbox.Id);

            db.Add(link);
            await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Application type {appTypeCheckbox.DisplayName} was linked to questionnaire {questionnaire.Id}");
        }

        await db.SaveChangesAsync();

        if (values.Level == QuestionnaireLevel.Product)
        {
            // Create Share Product Links
            foreach (var productCheckbox in values.Products
                         .Where(x => x.Type == QuestionnaireForm.ProductType.Share)
                         .Where(x => x.IsChecked))
            {
                var link = QuestionnaireShareProductLink.Create(
                    questionnaire.Id,
                    productCheckbox.Id);

                db.Add(link);
                await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Share product {productCheckbox.DisplayName} was linked to questionnaire {questionnaire.Id}");
            }

            // Create Loan Product Links
            foreach (var productCheckbox in values.Products
                         .Where(x => x.Type == QuestionnaireForm.ProductType.Loan)
                         .Where(x => x.IsChecked))
            {
                var link = QuestionnaireLoanProductLink.Create(
                    questionnaire.Id,
                    productCheckbox.Id);

                db.Add(link);
                await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Loan product {productCheckbox.DisplayName} was linked to questionnaire {questionnaire.Id}");
            }

            await db.SaveChangesAsync();
        }

        questionnaire.Update(values.Name!, values.IsEnabled, values.IsRequired, values.Level, values.Description);
        questionnaire.BumpVersion();

        await db.SaveChangesAsync();

        // Save translations to LocalizationStrings table
        var resourceKey = $"Questionnaire.{questionnaireId}";
        
        // Get all cultures from database
        var cultures = await db.Set<LocalizationCulture>().ToListAsync();
        var cultureMap = cultures.ToDictionary(c => c.Culture, c => c.Id);
        
        // Get primary language to determine save strategy
        var primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
        
        // Save Name translations
        foreach (var translation in nameTranslations)
        {
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                continue; // Skip if culture doesn't exist
            }
            
            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Name");
            
            if (existing != null)
            {
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Name",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }
        
        // Save primary language Name to database if primary is not English
        // (When primary is English, it's saved in the entity property, not in LocalizationStrings)
        if (!primaryLanguage.StartsWith("en"))
        {
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Name");
                
                if (existing != null)
                {
                    existing.UpdateDefault(questionnaireName ?? "");
                }
                else
                {
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Name",
                        defaultText: questionnaireName ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
        }
        
        // Save Description translations
        foreach (var translation in descriptionTranslations)
        {
            if (!cultureMap.TryGetValue(translation.Key, out var cultureId))
            {
                continue; // Skip if culture doesn't exist
            }
            
            var existing = await db.Set<LocalizationString>()
                .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == cultureId 
                                       && s.ResourceKey == resourceKey 
                                       && s.Key == "Description");
            
            if (existing != null)
            {
                existing.UpdateDefault(translation.Value ?? "");
            }
            else
            {
                var newString = LocalizationString.Create(
                    localizationCultureId: cultureId,
                    resourceKey: resourceKey,
                    key: "Description",
                    defaultText: translation.Value ?? ""
                );
                db.Set<LocalizationString>().Add(newString);
            }
        }
        
        // Save primary language Description to database if primary is not English
        // (When primary is English, it's saved in the entity property, not in LocalizationStrings)
        if (!primaryLanguage.StartsWith("en"))
        {
            if (cultureMap.TryGetValue(primaryLanguage, out var primaryCultureId))
            {
                var existing = await db.Set<LocalizationString>()
                    .FirstOrDefaultAsync(s => EF.Property<int>(s, "LocalizationCultureId") == primaryCultureId 
                                           && s.ResourceKey == resourceKey 
                                           && s.Key == "Description");
                
                if (existing != null)
                {
                    existing.UpdateDefault(questionnaireDescription ?? "");
                }
                else
                {
                    var newString = LocalizationString.Create(
                        localizationCultureId: primaryCultureId,
                        resourceKey: resourceKey,
                        key: "Description",
                        defaultText: questionnaireDescription ?? ""
                    );
                    db.Set<LocalizationString>().Add(newString);
                }
            }
        }

        await db.SaveChangesAsync();

        var excludedProperties = new List<string> { nameof(questionnaire.Questions), nameof(questionnaire.QuestionGroups), nameof(questionnaire.QuestionnaireResponses),
                nameof(questionnaire.QuestionnaireShareProductLinks), nameof(questionnaire.QuestionnaireApplicationTypeLinks), nameof(questionnaire.QuestionnaireLoanProductLinks) };
        await adminActivityService.TrackAdminUserActivityAsync(AdminUser!, AdminActivityType.Questionnaires, $"Questionnaire Id: {questionnaire.Id} was edited: ", oldConfig, questionnaire, excludedProperties);
    }

    private static async Task DeleteQuestionnaireLinkedEntities(AlohaDb db, int questionnaireId)
    {
        var questionnaire = await db.Questionnaires
            .Include(questionnaire => questionnaire.QuestionGroups)
            .Include(questionnaire => questionnaire.QuestionnaireApplicationTypeLinks)
            .Include(questionnaire => questionnaire.QuestionnaireShareProductLinks)
            .Include(questionnaire => questionnaire.QuestionnaireLoanProductLinks)
            .Include(questionnaire => questionnaire.Questions)!
            .ThenInclude(question => question.MultipleChoiceOptions)!
            .ThenInclude(multipleChoiceOption => multipleChoiceOption.DependentMultipleChoiceOptions)
            .FirstAsync(q => q.Id == questionnaireId);

        if (questionnaire.Questions != null)
        {
            foreach (var question in questionnaire.Questions)
            {
                if (question.MultipleChoiceOptions != null)
                {
                    foreach (var option in question.MultipleChoiceOptions)
                    {
                        if (option.DependentMultipleChoiceOptions != null)
                        {
                            foreach (var depOption in option.DependentMultipleChoiceOptions)
                            {
                                db.Remove(depOption);
                            }
                        }
                        db.Remove(option);
                    }
                }
                db.Remove(question);
            }
        }

        if (questionnaire.QuestionGroups != null)
        {
            foreach (var group in questionnaire.QuestionGroups)
            {
                db.Remove(group);
            }
        }

        if (questionnaire.QuestionnaireApplicationTypeLinks != null)
        {
            foreach (var link in questionnaire.QuestionnaireApplicationTypeLinks)
            {
                db.Remove(link);
            }
        }

        if (questionnaire.QuestionnaireShareProductLinks != null)
        {
            foreach (var link in questionnaire.QuestionnaireShareProductLinks)
            {
                db.Remove(link);
            }
        }

        if (questionnaire.QuestionnaireLoanProductLinks != null)
        {
            foreach (var link in questionnaire.QuestionnaireLoanProductLinks)
            {
                db.Remove(link);
            }
        }

        await db.SaveChangesAsync();
    }
}