@using Aloha.Customer.Web.Components.Common
@using Aloha.Customer.Web.Components.Common.Forms
@using Aloha.Domain.Questionnaires
@using Aloha.Domain.Services.Translations
@using Microsoft.AspNetCore.Localization
@inject IDbContextFactory<AlohaDb> dbFactory
@inject IStringLocalizer<MemberQuestionnaireForm> l
@inject IStringLocalizer<SharedResources> sl
@inject ITranslationHelper TranslationHelper
@inject IHttpContextAccessor HttpContextAccessor
@rendermode InteractiveServer

@if (isLoading)
{
    <Spinner/>
}
else
{
    <h2 class="h4 mb-1">@displayedQuestionnaireName</h2>

    @if (!string.IsNullOrWhiteSpace(displayedQuestionnaireDescription))
    {
        <p>@displayedQuestionnaireDescription</p>
    }

    <RequiredFieldHelper/>

    <EditForm
        novalidate
        class="needs-validation"
        EditContext="editContext"
        FormName=@($"Questionnaire{QuestionnaireId}")
        Context="QuestionnaireFormContext"
        OnSubmit="() => HandleSubmitAsync()"
    >
        <FluentValidationValidator/>
        @foreach (var responseGroup in input.QuestionResponseGroups)
        {
            <div class="mb-3">
                @if (responseGroup.QuestionGroup is not null)
                {
                    var groupName = GetLocalizedText(responseGroup.QuestionGroup.Id, "Name");
                    var groupDescription = GetLocalizedText(responseGroup.QuestionGroup.Id, "Description");
                    <h3 class="h5 mb-1">@groupName</h3>
                    @if (!string.IsNullOrWhiteSpace(groupDescription))
                    {
                        <p>@groupDescription</p>
                    }
                }
                @foreach (var questionResponse in responseGroup.QuestionResponses)
                {
                    @if (questionResponse.Question.Type == QuestionType.FreeForm)
                    {
                        <div class="mb-3">
                            <label for="@($"question-{questionResponse.Question.Id}-free-form-input")"
                                   class="form-label">
                                @GetLocalizedText(questionResponse.Question.Id, "Name")
                                @{
                                    var questionDesc = GetLocalizedText(questionResponse.Question.Id, "Description");
                                }
                                @if (!string.IsNullOrWhiteSpace(questionDesc))
                                {
                                    <span> - @questionDesc</span>
                                }
                                @if (questionResponse.Question.IsRequired)
                                {
                                    <span class="text-danger">*</span>
                                }
                            </label>
                            <InputText
                                @bind-Value="questionResponse.FreeFormFieldValue"
                                id="@($"question-{questionResponse.Question.Id}-free-form-input")"
                                class="form-control"/>
                            <ValidationMessage class="invalid-feedback"
                                               For="() => questionResponse.FreeFormFieldValue"/>
                        </div>
                    }

                    @if (questionResponse.Question.Type == QuestionType.SingleSelect)
                    {
                        <fieldset>
                            <legend class="mb-0">
                                @GetLocalizedText(questionResponse.Question.Id, "Name")
                                @if (questionResponse.Question.IsRequired)
                                {
                                    <span class="text-danger">*</span>
                                }
                            </legend>
                            <InputRadioGroup
                                Name="@($"question-{questionResponse.Question.Id}-radio")"
                                @bind-Value="questionResponse.SelectedMultipleChoiceResponseId"
                                @bind-Value:after="() => ClearChildOptionsForUnselectedRadios(questionResponse)"
                            >
                                @foreach (var multipleChoiceResponse in questionResponse.MultipleChoiceResponses)
                                {
                                    <div class="form-check">
                                        <InputRadio
                                            id="@($"option-{multipleChoiceResponse.MultipleChoiceOption.Id}")"
                                            class="form-check-input"
                                            type="radio"
                                            Value="multipleChoiceResponse.MultipleChoiceOption.Id"/>
                                        <label
                                            for="@($"option-{multipleChoiceResponse.MultipleChoiceOption.Id}")"
                                            class="form-check-label">
                                            @GetLocalizedText(multipleChoiceResponse.MultipleChoiceOption.Id, "Name")
                                        </label>
                                    </div>
                                    <div style="margin-left: 2rem">
                                        @if (multipleChoiceResponse.MultipleChoiceOption.DependentQuestionType == DependentQuestionType.FreeForm)
                                        {
                                            <div class="mb-3">
                                                <label
                                                    class="form-label"
                                                    for="@($"option-{multipleChoiceResponse.MultipleChoiceOption.Id}-free-form-field")">
                                                    @GetLocalizedText(multipleChoiceResponse.MultipleChoiceOption.Id, "DependentQuestionName")
                                                </label>
                                                <InputText
                                                    @bind-Value="multipleChoiceResponse.FreeFormFieldValue"
                                                    id="@($"option-{multipleChoiceResponse.MultipleChoiceOption.Id}-free-form-field")"
                                                    class="form-control"/>
                                                <ValidationMessage class="invalid-feedback"
                                                                   For="() => multipleChoiceResponse.FreeFormFieldValue"/>
                                            </div>
                                        }
                                        @if (multipleChoiceResponse.MultipleChoiceOption.DependentQuestionType == DependentQuestionType.SingleSelect)
                                        {
                                            <fieldset>
                                                <legend
                                                    class="mb-0">@GetLocalizedText(multipleChoiceResponse.MultipleChoiceOption.Id, "DependentQuestionName")</legend>
                                                <InputRadioGroup
                                                    Name="@($"option-{multipleChoiceResponse.MultipleChoiceOption.Id}-radio")"
                                                    @bind-Value="multipleChoiceResponse.SelectedDependentMultipleChoiceResponseId"
                                                >
                                                    @foreach (var depResponse in multipleChoiceResponse.DependentMultipleChoiceResponses)
                                                    {
                                                        <div class="form-check">
                                                            <InputRadio
                                                                id="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}")"
                                                                type="radio"
                                                                class="form-check-input"
                                                                Value="depResponse.DependentMultipleChoiceOption.Id"/>
                                                            <label
                                                                for="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}")"
                                                                class="form-check-label">
                                                                @GetLocalizedText(depResponse.DependentMultipleChoiceOption.Id, "Name")
                                                                @{
                                                                    var depOptionDesc = GetLocalizedText(depResponse.DependentMultipleChoiceOption.Id, "FreeFormFieldDescription");
                                                                }
                                                                @if (
                                                                    depResponse.DependentMultipleChoiceOption.HasFreeFormField &&
                                                                    !string.IsNullOrWhiteSpace(depOptionDesc))
                                                                {
                                                                    <span
                                                                        id="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}-single-select-free-form-field")">
                                                                        - @depOptionDesc
                                                                    </span>
                                                                }
                                                            </label>
                                                            @if (depResponse.DependentMultipleChoiceOption.HasFreeFormField)
                                                            {
                                                                <InputText
                                                                    @bind-Value="depResponse.FreeFormFieldValue"
                                                                    aria-labelledby="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}-single-select-free-form-field")"
                                                                    class="form-control"/>
                                                            }
                                                        </div>
                                                    }
                                                </InputRadioGroup>
                                                <ValidationMessage class="invalid-feedback"
                                                                   For="() => multipleChoiceResponse.FreeFormFieldValue"/>
                                            </fieldset>
                                        }
                                        @if (multipleChoiceResponse.MultipleChoiceOption.DependentQuestionType == DependentQuestionType.MultipleSelect)
                                        {
                                            <fieldset>
                                                <legend
                                                    class="mb-0">@GetLocalizedText(multipleChoiceResponse.MultipleChoiceOption.Id, "DependentQuestionName")</legend>
                                                @foreach (var depResponse in multipleChoiceResponse.DependentMultipleChoiceResponses)
                                                {
                                                    <div class="form-check">
                                                        <InputCheckbox
                                                            @bind-Value="depResponse.IsChecked"
                                                            id="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}")"
                                                            type="checkbox"
                                                            class="form-check-input"/>
                                                        <label
                                                            for="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}")"
                                                            class="form-check-label">
                                                            @GetLocalizedText(depResponse.DependentMultipleChoiceOption.Id, "Name")
                                                            @{
                                                                var depOptionDescMultiple = GetLocalizedText(depResponse.DependentMultipleChoiceOption.Id, "FreeFormFieldDescription");
                                                            }
                                                            @if (
                                                                depResponse.DependentMultipleChoiceOption.HasFreeFormField &&
                                                                !string.IsNullOrWhiteSpace(depOptionDescMultiple))
                                                            {
                                                                <span
                                                                    id="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}-multiple-choice-free-form-field")">
                                                                    - @depOptionDescMultiple
                                                                </span>
                                                            }
                                                        </label>
                                                        @if (depResponse.DependentMultipleChoiceOption.HasFreeFormField)
                                                        {
                                                            <InputText
                                                                @bind-Value="depResponse.FreeFormFieldValue"
                                                                aria-labelledby="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}-multiple-choice-free-form-field")"
                                                                class="form-control"/>
                                                        }
                                                    </div>
                                                }
                                            </fieldset>
                                        }
                                    </div>
                                }
                            </InputRadioGroup>
                            <ValidationMessage class="invalid-feedback"
                                               For="() => questionResponse.MultipleChoiceResponses"/>
                        </fieldset>
                    }

                    @if (questionResponse.Question.Type == QuestionType.MultipleSelect)
                    {
                        <fieldset>
                            <legend class="mb-0">
                                @GetLocalizedText(questionResponse.Question.Id, "Name")
                                @if (questionResponse.Question.IsRequired)
                                {
                                    <span class="text-danger">*</span>
                                }
                            </legend>
                            @foreach (var multipleChoiceResponse in questionResponse.MultipleChoiceResponses)
                            {
                                <div class="form-check">
                                    <InputCheckbox
                                        @bind-Value="multipleChoiceResponse.IsChecked"
                                        @bind-Value:after="() => ClearChildOptionsIfUnselected(multipleChoiceResponse)"
                                        id="@($"option-{multipleChoiceResponse.MultipleChoiceOption.Id}")"
                                        class="form-check-input"
                                        type="checkbox"/>
                                    <label for="@($"option-{multipleChoiceResponse.MultipleChoiceOption.Id}")"
                                           class="form-check-label">
                                        @GetLocalizedText(multipleChoiceResponse.MultipleChoiceOption.Id, "Name")
                                    </label>
                                </div>
                                <div style="margin-left: 2rem">
                                    @if (multipleChoiceResponse.MultipleChoiceOption.DependentQuestionType == DependentQuestionType.FreeForm)
                                    {
                                        <div class="mb-3">
                                            <label
                                                class="form-label"
                                                for="@($"option-{multipleChoiceResponse.MultipleChoiceOption.Id}-free-form-field")">
                                                @GetLocalizedText(multipleChoiceResponse.MultipleChoiceOption.Id, "DependentQuestionName")
                                            </label>
                                            <InputText
                                                @bind-Value="multipleChoiceResponse.FreeFormFieldValue"
                                                class="form-control"
                                                id="@($"option-{multipleChoiceResponse.MultipleChoiceOption.Id}-free-form-field")"/>
                                            <ValidationMessage class="invalid-feedback"
                                                               For="() => multipleChoiceResponse.FreeFormFieldValue"/>
                                        </div>
                                    }
                                    @if (multipleChoiceResponse.MultipleChoiceOption.DependentQuestionType == DependentQuestionType.SingleSelect)
                                    {
                                        <fieldset>
                                            <legend
                                                class="mb-0">@GetLocalizedText(multipleChoiceResponse.MultipleChoiceOption.Id, "DependentQuestionName")</legend>
                                            <InputRadioGroup
                                                Name="@($"option-{multipleChoiceResponse.MultipleChoiceOption.Id}-radio")"
                                                @bind-Value="multipleChoiceResponse.SelectedDependentMultipleChoiceResponseId"
                                            >
                                                @foreach (var depResponse in multipleChoiceResponse.DependentMultipleChoiceResponses)
                                                {
                                                    <div class="form-check">
                                                        <InputRadio
                                                            Value="depResponse.DependentMultipleChoiceOption.Id"
                                                            id="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}")"
                                                            class="form-check-input"/>
                                                        <label
                                                            for="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}")"
                                                            class="form-check-label">
                                                            @GetLocalizedText(depResponse.DependentMultipleChoiceOption.Id, "Name")
                                                            @{
                                                                var depOptionDesc2 = GetLocalizedText(depResponse.DependentMultipleChoiceOption.Id, "FreeFormFieldDescription");
                                                            }
                                                            @if (
                                                                depResponse.DependentMultipleChoiceOption.HasFreeFormField &&
                                                                !string.IsNullOrWhiteSpace(depOptionDesc2))
                                                            {
                                                                <span
                                                                    id="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}-free-form-field")">
                                                                    - @depOptionDesc2
                                                                </span>
                                                            }
                                                        </label>
                                                        @if (depResponse.DependentMultipleChoiceOption.HasFreeFormField)
                                                        {
                                                            <InputText
                                                                @bind-Value="depResponse.FreeFormFieldValue"
                                                                aria-labelledby="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}-free-form-field")"
                                                                class="form-control"/>
                                                        }
                                                    </div>
                                                }
                                            </InputRadioGroup>
                                        </fieldset>
                                    }
                                    @if (multipleChoiceResponse.MultipleChoiceOption.DependentQuestionType == DependentQuestionType.MultipleSelect)
                                    {
                                        <fieldset>
                                            <legend
                                                class="mb-0">@GetLocalizedText(multipleChoiceResponse.MultipleChoiceOption.Id, "DependentQuestionName")</legend>
                                            @foreach (var depResponse in multipleChoiceResponse.DependentMultipleChoiceResponses)
                                            {
                                                <div class="form-check">
                                                    <InputCheckbox
                                                        @bind-Value="depResponse.IsChecked"
                                                        id="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}")"
                                                        type="checkbox"
                                                        class="form-check-input"/>
                                                    <label
                                                        for="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}")"
                                                        class="form-check-label">
                                                        @GetLocalizedText(depResponse.DependentMultipleChoiceOption.Id, "Name")
                                                        @{
                                                            var depOptionDescMultiple2 = GetLocalizedText(depResponse.DependentMultipleChoiceOption.Id, "FreeFormFieldDescription");
                                                        }
                                                        @if (
                                                            depResponse.DependentMultipleChoiceOption.HasFreeFormField &&
                                                            !string.IsNullOrWhiteSpace(depOptionDescMultiple2))
                                                        {
                                                            <span
                                                                id="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}-free-form-field")">
                                                                - @depOptionDescMultiple2
                                                            </span>
                                                        }
                                                    </label>
                                                    @if (depResponse.DependentMultipleChoiceOption.HasFreeFormField)
                                                    {
                                                        <InputText
                                                            @bind-Value="depResponse.FreeFormFieldValue"
                                                            aria-labelledby="@($"dependent-option-{depResponse.DependentMultipleChoiceOption.Id}-free-form-field")"
                                                            class="form-control"/>
                                                    }
                                                </div>
                                            }
                                        </fieldset>
                                    }
                                </div>
                            }
                            <ValidationMessage class="invalid-feedback"
                                               For="() => questionResponse.MultipleChoiceResponses"/>
                        </fieldset>
                    }
                }
            </div>
        }
        <hr class="border border-1 opacity-50">
        @if (input.HasSubmitted && editContext.GetValidationMessages().Any())
        {
            <Alert Color="AlertColor.Danger">
                <Icon class="me-2" Name="IconName.ExclamationTriangleFill"></Icon>
                @sl["error-form-invalid"]
            </Alert>
        }
        <div class="d-flex justify-content-end gap-1">
            <a href="@CancellationUrl" class="btn btn-outline-primary">@sl["button-cancel"]</a>
            <button class="btn btn-primary">@sl["button-continue"]</button>
        </div>
        <FormNavigationWarning @ref="formNavigationWarning" ConfirmRequired="editContext.IsModified()"/>
    </EditForm>
}

@code {

    [Parameter, EditorRequired]
    public EventCallback<(Input, Questionnaire)> OnSubmit { get; set; }

    [Parameter]
    public int? QuestionnaireId { get; set; }

    [Parameter]
    public int? QuestionnaireResponseId { get; set; }

    private EditContext editContext = null!;
    private FormNavigationWarning? formNavigationWarning;
    private Questionnaire? questionnaire;
    private ValidationMessageStore messageStore = null!;
    private bool isLoading = true;
    private readonly Input input = new();
    private bool isEditingResponse => QuestionnaireResponseId is not null;
    private string displayedQuestionnaireName = "";
    private string? displayedQuestionnaireDescription = null;
    private Dictionary<(int entityId, string propertyName), string> translationCache = new();

    protected override void OnInitialized()
    {
        Console.WriteLine("[MemberQuestionnaireForm] OnInitialized START");
        editContext = new EditContext(input);
        messageStore = new ValidationMessageStore(editContext);
        editContext.OnValidationRequested += (s, e) => messageStore.Clear();
        editContext.OnFieldChanged += (s, e) => messageStore.Clear(e.FieldIdentifier);
        editContext.SetFieldCssClassProvider(new CustomFieldClassProvider());
        Console.WriteLine("[MemberQuestionnaireForm] OnInitialized END");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        Console.WriteLine($"[MemberQuestionnaireForm] OnAfterRenderAsync START - firstRender: {firstRender}");
        if (firstRender)
        {
            Console.WriteLine("[MemberQuestionnaireForm] First render - starting data load");
            await using var db = await dbFactory.CreateDbContextAsync();
            Console.WriteLine("[MemberQuestionnaireForm] Database context created");

            // Attempt pre-fill from existing responses if questionnaire response ID was provided
            if (QuestionnaireResponseId is not null)
            {
                Console.WriteLine($"[MemberQuestionnaireForm] Loading existing response - QuestionnaireResponseId: {QuestionnaireResponseId}");
                var questionnaireResponse = await db.QuestionnaireResponses
                    .Include(x => x.QuestionResponses)
                    .Include(x => x.QuestionResponseGroups!)
                    .ThenInclude(x => x.QuestionResponses)
                    .FirstAsync(x => x.Id == QuestionnaireResponseId);
                Console.WriteLine($"[MemberQuestionnaireForm] QuestionnaireResponse loaded - QuestionnaireId: {questionnaireResponse.QuestionnaireId}");

                questionnaire = await FetchQuestionnaireByIdAsync(db, questionnaireResponse.QuestionnaireId);
                Console.WriteLine($"[MemberQuestionnaireForm] Questionnaire fetched - Id: {questionnaire?.Id}, Name: {questionnaire?.Name}");

                // If current questionnaire version is different from version responded to, create empty form
                if (questionnaire.Version != questionnaireResponse.QuestionnaireVersion)
                {
                    Console.WriteLine($"[MemberQuestionnaireForm] Version mismatch - creating empty form. Questionnaire Version: {questionnaire.Version}, Response Version: {questionnaireResponse.QuestionnaireVersion}");
                    input.QuestionResponseGroups = MapQuestionnaireToQuestionResponseGroupInputs(questionnaire);
                }
                // Otherwise, build form with fields pre-populated
                else
                {
                    Console.WriteLine("[MemberQuestionnaireForm] Versions match - pre-populating form");
                    var lookup = MapQuestionnaireToDetailLookup(questionnaire);
                    input.QuestionResponseGroups = MapQuestionnaireResponseToQuestionResponseGroupInputs(lookup, questionnaireResponse);
                }
            }
            // Otherwise, create empty form from scratch
            else if (QuestionnaireId is not null)
            {
                Console.WriteLine($"[MemberQuestionnaireForm] Loading questionnaire from scratch - QuestionnaireId: {QuestionnaireId}");
                questionnaire = await FetchQuestionnaireByIdAsync(db, QuestionnaireId!.Value);
                Console.WriteLine($"[MemberQuestionnaireForm] Questionnaire fetched - Id: {questionnaire?.Id}, Name: {questionnaire?.Name}");
                input.QuestionResponseGroups = MapQuestionnaireToQuestionResponseGroupInputs(questionnaire);
                Console.WriteLine($"[MemberQuestionnaireForm] QuestionResponseGroups mapped - Count: {input.QuestionResponseGroups?.Count ?? 0}");
            }
            else
            {
                Console.WriteLine("[MemberQuestionnaireForm] WARNING: Neither QuestionnaireResponseId nor QuestionnaireId provided!");
            }

            // Load all translations for questionnaire and nested entities
            if (questionnaire != null)
            {
                Console.WriteLine("[MemberQuestionnaireForm] Starting to load translations");
                await LoadAllTranslationsAsync(questionnaire);
                Console.WriteLine("[MemberQuestionnaireForm] Translations loaded");
            }
            else
            {
                Console.WriteLine("[MemberQuestionnaireForm] WARNING: questionnaire is null, cannot load translations");
            }

            isLoading = false;
            Console.WriteLine($"[MemberQuestionnaireForm] isLoading set to false, calling StateHasChanged. displayedQuestionnaireName: '{displayedQuestionnaireName}'");
            StateHasChanged();
            Console.WriteLine("[MemberQuestionnaireForm] StateHasChanged called");
        }
        else
        {
            Console.WriteLine("[MemberQuestionnaireForm] Not first render, skipping data load");
        }
        Console.WriteLine("[MemberQuestionnaireForm] OnAfterRenderAsync END");
    }

    private async Task LoadAllTranslationsAsync(Questionnaire q)
    {
        Console.WriteLine($"[MemberQuestionnaireForm] LoadAllTranslationsAsync START - Questionnaire Id: {q.Id}");
        var currentCulture = GetCurrentCulture();
        Console.WriteLine($"[MemberQuestionnaireForm] Current culture: {currentCulture ?? "null"}");
        translationCache.Clear();
        Console.WriteLine("[MemberQuestionnaireForm] Translation cache cleared");

        // Load questionnaire translations
        Console.WriteLine($"[MemberQuestionnaireForm] Loading questionnaire translations - Id: {q.Id}, Name (entity): '{q.Name}'");
        displayedQuestionnaireName = await TranslationHelper.GetLocalTextAsync(q, "Name", currentCulture) ?? q.Name ?? "";
        Console.WriteLine($"[MemberQuestionnaireForm] Questionnaire Name (translated): '{displayedQuestionnaireName}'");
        displayedQuestionnaireDescription = await TranslationHelper.GetLocalTextAsync(q, "Description", currentCulture);
        Console.WriteLine($"[MemberQuestionnaireForm] Questionnaire Description (translated): '{displayedQuestionnaireDescription ?? "null"}'");
        translationCache[(q.Id, "Name")] = displayedQuestionnaireName;
        if (displayedQuestionnaireDescription != null)
        {
            translationCache[(q.Id, "Description")] = displayedQuestionnaireDescription;
        }

        // Load question group translations
        if (q.QuestionGroups != null)
        {
            Console.WriteLine($"[MemberQuestionnaireForm] Loading {q.QuestionGroups.Count} question group translations");
            foreach (var group in q.QuestionGroups)
            {
                var groupName = await TranslationHelper.GetLocalTextAsync(group, "Name", currentCulture) ?? group.Name ?? "";
                var groupDesc = await TranslationHelper.GetLocalTextAsync(group, "Description", currentCulture) ?? group.Description ?? "";
                translationCache[(group.Id, "Name")] = groupName;
                translationCache[(group.Id, "Description")] = groupDesc;
                Console.WriteLine($"[MemberQuestionnaireForm] QuestionGroup {group.Id} - Name: '{groupName}', Description: '{groupDesc}'");
            }
        }
        else
        {
            Console.WriteLine("[MemberQuestionnaireForm] No question groups to load");
        }

        // Load question translations
        if (q.Questions != null)
        {
            Console.WriteLine($"[MemberQuestionnaireForm] Loading {q.Questions.Count} question translations");
            foreach (var question in q.Questions)
            {
                var questionName = await TranslationHelper.GetLocalTextAsync(question, "Name", currentCulture) ?? question.Name ?? "";
                var questionDesc = await TranslationHelper.GetLocalTextAsync(question, "Description", currentCulture) ?? question.Description ?? "";
                translationCache[(question.Id, "Name")] = questionName;
                translationCache[(question.Id, "Description")] = questionDesc;
                Console.WriteLine($"[MemberQuestionnaireForm] Question {question.Id} - Name: '{questionName}', Description: '{questionDesc}'");

                // Load option translations
                if (question.MultipleChoiceOptions != null)
                {
                    Console.WriteLine($"[MemberQuestionnaireForm] Loading {question.MultipleChoiceOptions.Count} option translations for Question {question.Id}");
                    foreach (var option in question.MultipleChoiceOptions)
                    {
                        var optionNameTranslated = await TranslationHelper.GetLocalTextAsync(option, "Name", currentCulture);
                        var optionName = optionNameTranslated ?? option.Name ?? "";
                        var depQuestionNameTranslated = await TranslationHelper.GetLocalTextAsync(option, "DependentQuestionName", currentCulture);
                        var depQuestionName = depQuestionNameTranslated ?? option.DependentQuestionName ?? "";
                        translationCache[(option.Id, "Name")] = optionName;
                        translationCache[(option.Id, "DependentQuestionName")] = depQuestionName;
                        Console.WriteLine($"[MemberQuestionnaireForm] Option {option.Id} - Translated Name: '{optionNameTranslated}', Final Name: '{optionName}', Translated DepQuestionName: '{depQuestionNameTranslated}', Final DepQuestionName: '{depQuestionName}'");

                        // Load dependent option translations
                        if (option.DependentMultipleChoiceOptions != null)
                        {
                            Console.WriteLine($"[MemberQuestionnaireForm] Loading {option.DependentMultipleChoiceOptions.Count} dependent option translations for Option {option.Id}");
                            foreach (var depOption in option.DependentMultipleChoiceOptions)
                            {
                                var depOptionName = await TranslationHelper.GetLocalTextAsync(depOption, "Name", currentCulture) ?? depOption.Name ?? "";
                                var depOptionDesc = await TranslationHelper.GetLocalTextAsync(depOption, "FreeFormFieldDescription", currentCulture) ?? depOption.FreeFormFieldDescription ?? "";
                                translationCache[(depOption.Id, "Name")] = depOptionName;
                                translationCache[(depOption.Id, "FreeFormFieldDescription")] = depOptionDesc;
                                Console.WriteLine($"[MemberQuestionnaireForm] DependentOption {depOption.Id} - Name: '{depOptionName}', FreeFormFieldDescription: '{depOptionDesc}'");
                            }
                        }
                    }
                }
            }
        }
        else
        {
            Console.WriteLine("[MemberQuestionnaireForm] No questions to load");
        }
        Console.WriteLine($"[MemberQuestionnaireForm] LoadAllTranslationsAsync END - Cache size: {translationCache.Count}");
    }

    private string? GetCurrentCulture()
    {
        Console.WriteLine("[MemberQuestionnaireForm] GetCurrentCulture START");
        var httpContext = HttpContextAccessor.HttpContext;
        if (httpContext != null)
        {
            Console.WriteLine("[MemberQuestionnaireForm] HttpContext is not null");
            var requestCulture = httpContext.Features.Get<IRequestCultureFeature>();
            if (requestCulture?.RequestCulture?.Culture != null)
            {
                var cultureName = requestCulture.RequestCulture.Culture.Name;
                Console.WriteLine($"[MemberQuestionnaireForm] Detected culture: {cultureName}");
                // Map to supported cultures
                if (cultureName == "en-US" || cultureName == "en-GB" || cultureName == "es-CR")
                {
                    Console.WriteLine($"[MemberQuestionnaireForm] GetCurrentCulture END - returning: {cultureName}");
                    return cultureName;
                }
                else if (cultureName.StartsWith("en"))
                {
                    Console.WriteLine("[MemberQuestionnaireForm] GetCurrentCulture END - returning: en-US (mapped from en*)");
                    return "en-US";
                }
                else if (cultureName.StartsWith("es"))
                {
                    Console.WriteLine("[MemberQuestionnaireForm] GetCurrentCulture END - returning: es-CR (mapped from es*)");
                    return "es-CR";
                }
            }
            else
            {
                Console.WriteLine("[MemberQuestionnaireForm] IRequestCultureFeature or Culture is null");
            }
        }
        else
        {
            Console.WriteLine("[MemberQuestionnaireForm] HttpContext is null");
        }
        Console.WriteLine("[MemberQuestionnaireForm] GetCurrentCulture END - returning: null");
        return null;
    }

    private string GetLocalizedText(int entityId, string propertyName)
    {
        var found = translationCache.TryGetValue((entityId, propertyName), out var text);
        if (!found)
        {
            Console.WriteLine($"[MemberQuestionnaireForm] GetLocalizedText - Cache miss for entityId: {entityId}, propertyName: {propertyName}. Cache size: {translationCache.Count}");
            if (translationCache.Count > 0)
            {
                var sampleKeys = string.Join(", ", translationCache.Keys.Take(10).Select(k => $"({k.entityId}, {k.propertyName})"));
                Console.WriteLine($"[MemberQuestionnaireForm] GetLocalizedText - Sample cache keys: {sampleKeys}");
            }
            else
            {
                Console.WriteLine($"[MemberQuestionnaireForm] GetLocalizedText - WARNING: Translation cache is empty! This should not happen if translations were loaded correctly.");
            }
        }
        var result = found ? text : "";
        Console.WriteLine($"[MemberQuestionnaireForm] GetLocalizedText - entityId: {entityId}, propertyName: {propertyName}, found: {found}, result: '{result}'");
        return result;
    }

    private async Task<Questionnaire> FetchQuestionnaireByIdAsync(AlohaDb db, int id)
    {
        Console.WriteLine($"[MemberQuestionnaireForm] FetchQuestionnaireByIdAsync START - id: {id}");
        var questionnaire = await db.Questionnaires
            .AsSplitQuery()
            .Include(q => q.Questions!)
            .ThenInclude(q => q.QuestionGroup)
            .Include(q => q.Questions!)
            .ThenInclude(q => q.MultipleChoiceOptions!)
            .ThenInclude(q => q.DependentMultipleChoiceOptions)
            .Include(q => q.QuestionGroups)
            .FirstAsync(q => q.Id == id);
        Console.WriteLine($"[MemberQuestionnaireForm] FetchQuestionnaireByIdAsync END - Questionnaire Id: {questionnaire.Id}, Questions Count: {questionnaire.Questions?.Count ?? 0}, QuestionGroups Count: {questionnaire.QuestionGroups?.Count ?? 0}");
        return questionnaire;
    }

    private static IList<QuestionResponseGroupInput> MapQuestionnaireResponseToQuestionResponseGroupInputs(
        QuestionnaireDetailLookup lookup,
        QuestionnaireResponse questionnaireResponse)
    {
        var questionResponseGroups = new List<QuestionResponseGroupInput>();

        var ungroupedQuestionResponses = (questionnaireResponse.QuestionResponses ?? [])
            .Where(response => response.QuestionResponseGroup == null)
            .ToArray();

        questionResponseGroups.Add(new QuestionResponseGroupInput
        {
            QuestionGroup = null,
            QuestionResponses = MapQuestionResponsesToQuestionResponseInputs(lookup, ungroupedQuestionResponses)
        });

        questionResponseGroups.AddRange(
            (questionnaireResponse.QuestionResponseGroups ?? []).Select(questionResponseGroup =>
                new QuestionResponseGroupInput
                {
                    QuestionGroup = lookup.QuestionGroupMap[questionResponseGroup.QuestionGroupId],
                    QuestionResponses = MapQuestionResponsesToQuestionResponseInputs(
                        lookup,
                        questionResponseGroup.QuestionResponses ?? [])
                }));

        return questionResponseGroups;
    }

    private static IList<QuestionResponseInput> MapQuestionResponsesToQuestionResponseInputs(
        QuestionnaireDetailLookup lookup,
        IList<QuestionResponse> questionResponses)
    {
        return questionResponses
            .Select(questionResponse =>
            {
                var questionResponseInput = new QuestionResponseInput
                {
                    Question = lookup.QuestionMap[questionResponse.Snapshot.QuestionId],
                    FreeFormFieldValue = questionResponse.Snapshot.FreeFormResponse,
                    SelectedMultipleChoiceResponseId = questionResponse.Snapshot.SelectedMultipleChoiceOptionId
                };

                questionResponseInput.MultipleChoiceResponses = (questionResponse.Snapshot.MultipleChoiceResponses ?? [])
                    .Select(optionResponse =>
                    {
                        var multipleChoiceResponseInput = new MultipleChoiceResponseInput
                        {
                            QuestionResponse = questionResponseInput,
                            MultipleChoiceOption = lookup.OptionMap[optionResponse.MultipleChoiceOptionId],
                            IsChecked = optionResponse.IsChecked == true,
                            FreeFormFieldValue = optionResponse.FreeFormResponse,
                            SelectedDependentMultipleChoiceResponseId = optionResponse.SelectedDependentMultipleChoiceOptionId,
                        };

                        multipleChoiceResponseInput.DependentMultipleChoiceResponses = (optionResponse.DependentMultipleChoiceResponses ?? [])
                            .Select(depOptionResponse => new DependentMultipleChoiceResponseInput
                            {
                                MultipleChoiceResponse = multipleChoiceResponseInput,
                                DependentMultipleChoiceOption = lookup.DepOptionMap[depOptionResponse.DependentMultipleChoiceOptionId],
                                IsChecked = depOptionResponse.IsChecked == true,
                                FreeFormFieldValue = depOptionResponse.FreeFormResponse,
                            })
                            .ToArray();

                        return multipleChoiceResponseInput;
                    })
                    .ToArray();

                return questionResponseInput;
            })
            .ToArray();
    }

    private static IList<QuestionResponseGroupInput> MapQuestionnaireToQuestionResponseGroupInputs(
        Questionnaire questionnaire)
    {
        var questionResponseGroups = new List<QuestionResponseGroupInput>();

        var ungroupedQuestions = new QuestionResponseGroupInput
        {
            QuestionResponses = questionnaire.Questions
                    ?.Where(question => question.QuestionGroup == null)
                    .OrderBy(q => q.SortOrder)
                    .Select(MapQuestionToQuestionResponseInput)
                    .ToArray() ??
                []
        };

        questionResponseGroups.Add(ungroupedQuestions);

        if (questionnaire.QuestionGroups != null)
        {
            questionResponseGroups.AddRange(questionnaire.QuestionGroups
                .OrderBy(g => g.SortOrder)
                .Select(MapQuestionGroupToQuestionResponseGroupInput)
            );
        }

        return questionResponseGroups;
    }

    private static QuestionResponseGroupInput MapQuestionGroupToQuestionResponseGroupInput(QuestionGroup group)
    {
        return new QuestionResponseGroupInput
        {
            QuestionGroup = group,
            QuestionResponses = group.Questions
                    ?.OrderBy(x => x.SortOrder)
                    .Select(MapQuestionToQuestionResponseInput)
                    .ToArray() ??
                []
        };
    }

    private static QuestionResponseInput MapQuestionToQuestionResponseInput(Question question)
    {
        var questionResponse = new QuestionResponseInput { Question = question };

        questionResponse.MultipleChoiceResponses = question.MultipleChoiceOptions
                ?.OrderBy(x => x.SortOrder)
                .Select(option => MapMultipleChoiceOptionToMultipleChoiceResponseInput(option, questionResponse))
                .ToArray() ??
            [];

        return questionResponse;
    }

    private static MultipleChoiceResponseInput MapMultipleChoiceOptionToMultipleChoiceResponseInput(
        MultipleChoiceOption option,
        QuestionResponseInput questionResponse)
    {
        var optionResponse = new MultipleChoiceResponseInput
        {
            MultipleChoiceOption = option,
            QuestionResponse = questionResponse
        };

        optionResponse.DependentMultipleChoiceResponses = option.DependentMultipleChoiceOptions
                ?.OrderBy(x => x.SortOrder)
                .Select(depOption => MapDependentMultipleChoiceOptionToDependentMultipleChoiceResponseInput(
                    depOption,
                    optionResponse))
                .ToArray() ??
            [];

        return optionResponse;
    }

    private static DependentMultipleChoiceResponseInput MapDependentMultipleChoiceOptionToDependentMultipleChoiceResponseInput(
        DependentMultipleChoiceOption depOption,
        MultipleChoiceResponseInput optionResponse)
    {
        return new DependentMultipleChoiceResponseInput
        {
            DependentMultipleChoiceOption = depOption,
            MultipleChoiceResponse = optionResponse
        };
    }

    private static QuestionnaireDetailLookup MapQuestionnaireToDetailLookup(Questionnaire questionnaire)
    {
        var lookup = new QuestionnaireDetailLookup();

        foreach (var question in questionnaire.Questions ?? [])
        {
            lookup.QuestionMap[question.Id] = question;

            foreach (var option in question.MultipleChoiceOptions ?? [])
            {
                lookup.OptionMap[option.Id] = option;

                foreach (var depOption in option.DependentMultipleChoiceOptions ?? [])
                {
                    lookup.DepOptionMap[depOption.Id] = depOption;
                }
            }
        }

        foreach (var group in questionnaire.QuestionGroups ?? [])
        {
            lookup.QuestionGroupMap[group.Id] = group;
        }

        return lookup;
    }

    private async Task HandleSubmitAsync()
    {
        input.HasSubmitted = true;
        foreach (var qrg in input.QuestionResponseGroups)
        {
            foreach (var qr in qrg.QuestionResponses!)
            {
                qr.HasSubmitted = true;
            }
        }
        if (!editContext.Validate())
        {
            StateHasChanged();
            return;
        }
        formNavigationWarning?.SkipNavigationWarning();
        await OnSubmit.InvokeAsync((input, questionnaire!));
    }

    private void ClearChildOptionsIfUnselected(MultipleChoiceResponseInput multipleChoiceResponseInput)
    {
        if (multipleChoiceResponseInput.IsChecked)
        {
            return;
        }

        multipleChoiceResponseInput.FreeFormFieldValue = null;
        multipleChoiceResponseInput.SelectedDependentMultipleChoiceResponseId = null;
        foreach (var depResponse in multipleChoiceResponseInput.DependentMultipleChoiceResponses)
        {
            depResponse.IsChecked = false;
            depResponse.FreeFormFieldValue = null;
        }
    }

    private void ClearChildOptionsForUnselectedRadios(QuestionResponseInput questionResponseInput)
    {
        foreach (var optionResponse in questionResponseInput.MultipleChoiceResponses
                     .Where(x => x.QuestionResponse.Question.Type == QuestionType.SingleSelect)
                     .Where(x => x.MultipleChoiceOption.Id != questionResponseInput.SelectedMultipleChoiceResponseId))
        {
            optionResponse.FreeFormFieldValue = null;
            optionResponse.SelectedDependentMultipleChoiceResponseId = null;

            foreach (var depResponse in optionResponse.DependentMultipleChoiceResponses)
            {
                depResponse.IsChecked = false;
                depResponse.FreeFormFieldValue = null;
            }
        }
    }

    private string CancellationUrl => questionnaire?.Level switch
    {
        QuestionnaireLevel.Application => "/applications/questionnaires",
        QuestionnaireLevel.Applicant => "/applications/people/questionnaires",
        QuestionnaireLevel.Product => "/applications/products/questionnaires",
        _ => "/applications/summary"
    };

    public class Input
    {
        public bool HasSubmitted { get; set; } = false;
        public IList<QuestionResponseGroupInput> QuestionResponseGroups { get; set; } = [];
    }

    public class QuestionResponseGroupInput
    {
        public QuestionGroup? QuestionGroup { get; set; }
        public IList<QuestionResponseInput> QuestionResponses { get; set; } = [];
    }

    public class QuestionResponseInput
    {
        public bool HasSubmitted { get; set; } = false;
        public Question Question { get; set; } = null!;
        public IList<MultipleChoiceResponseInput> MultipleChoiceResponses { get; set; } = [];
        public string? FreeFormFieldValue { get; set; }
        public int? SelectedMultipleChoiceResponseId { get; set; }
    }

    public class MultipleChoiceResponseInput
    {
        public MultipleChoiceOption MultipleChoiceOption { get; set; } = null!;
        public QuestionResponseInput QuestionResponse { get; set; } = null!;
        public IList<DependentMultipleChoiceResponseInput> DependentMultipleChoiceResponses { get; set; } = [];
        public int? SelectedDependentMultipleChoiceResponseId { get; set; }
        public string? FreeFormFieldValue { get; set; }
        public bool IsChecked { get; set; }
    }

    public class DependentMultipleChoiceResponseInput
    {
        public DependentMultipleChoiceOption DependentMultipleChoiceOption { get; set; } = null!;
        public MultipleChoiceResponseInput MultipleChoiceResponse { get; set; } = null!;
        public string? FreeFormFieldValue { get; set; }
        public bool IsChecked { get; set; }
    }

    public class FormValidator : AbstractValidator<Input>
    {
        public FormValidator(IStringLocalizer<MemberQuestionnaireForm> l)
        {
            When(input => input.HasSubmitted, () =>
            {
                RuleForEach(form => form.QuestionResponseGroups).SetValidator(new QuestionResponseGroupValidator(l));
            });
        }
    }

    public class QuestionResponseGroupValidator : AbstractValidator<QuestionResponseGroupInput>
    {
        public QuestionResponseGroupValidator(IStringLocalizer<MemberQuestionnaireForm> l)
        {
            RuleForEach(group => group.QuestionResponses).SetValidator(new QuestionResponseValidator(l));
        }
    }

    public class QuestionResponseValidator : AbstractValidator<QuestionResponseInput>
    {
        public QuestionResponseValidator(IStringLocalizer<MemberQuestionnaireForm> l)
        {
            When(questionResponse => questionResponse.HasSubmitted, () =>
            {
                When(questionResponse => questionResponse.Question.Type is QuestionType.FreeForm, () =>
                {
                    RuleFor(questionResponse => questionResponse.FreeFormFieldValue)
                        .NotEmpty()
                        .When(questionResponse => questionResponse.Question.IsRequired)
                        .WithMessage(l["error-free-form-response-required"]);

                RuleFor(questionResponse => questionResponse.FreeFormFieldValue)
                    .MaximumLength(200)
                    .WithMessage(l["validation-maximum-length", 200]);
                });

                When(questionResponse => questionResponse.Question.Type is QuestionType.SingleSelect, () =>
                {
                    RuleFor(questionResponse => questionResponse.SelectedMultipleChoiceResponseId)
                        .NotNull()
                        .When(questionResponse => questionResponse.Question.IsRequired)
                        .WithMessage(l["error-option-required"]);

                    When(question => question.SelectedMultipleChoiceResponseId is not null, () =>
                    {
                        RuleForEach(question => question.MultipleChoiceResponses)
                            .SetValidator(new MultipleChoiceResponseValidator(l));
                    });
                });

                When(questionResponse => questionResponse.Question.Type is QuestionType.MultipleSelect, () =>
                {
                    When(questionResponse =>
                            questionResponse.Question.IsRequired &&
                            questionResponse.MultipleChoiceResponses.All(option => !option.IsChecked),
                        () =>
                        {
                            RuleForEach(questionResponse => questionResponse.MultipleChoiceResponses)
                                .ChildRules(optionResponse =>
                                {
                                    optionResponse.RuleFor(o => o.IsChecked)
                                        .Must(isChecked => isChecked)
                                        .WithMessage(l["error-option-required"]);
                                });
                        });

                    When(questionResponse => questionResponse.MultipleChoiceResponses.Any(option => option.IsChecked), () =>
                    {
                        RuleForEach(questionResponse => questionResponse.MultipleChoiceResponses)
                            .SetValidator(new MultipleChoiceResponseValidator(l));
                    });
                });
            });
        }
    }

    public class MultipleChoiceResponseValidator : AbstractValidator<MultipleChoiceResponseInput>
    {
        public MultipleChoiceResponseValidator(IStringLocalizer<MemberQuestionnaireForm> l)
        {
            When(o =>
                    (o.QuestionResponse.Question.Type == QuestionType.SingleSelect &&
                        o.QuestionResponse.SelectedMultipleChoiceResponseId == o.MultipleChoiceOption.Id) ||
                    (o.QuestionResponse.Question.Type == QuestionType.MultipleSelect &&
                        o.IsChecked),
                () =>
                {
                    When(o => o.MultipleChoiceOption.DependentQuestionType is DependentQuestionType.FreeForm, () =>
                    {
                        RuleFor(o => o.FreeFormFieldValue)
                            .NotEmpty()
                            .WithMessage(l["error-option-free-form-response-required"]);

                        RuleFor(o => o.FreeFormFieldValue)
                            .MaximumLength(200)
                            .WithMessage(l["validation-maximum-length", 200]);
                    });

                    When(o => o.MultipleChoiceOption.DependentQuestionType is DependentQuestionType.SingleSelect, () =>
                    {
                        RuleFor(o => o.SelectedDependentMultipleChoiceResponseId)
                            .NotNull()
                            .WithMessage(l["error-dependent-option-required"]);

                        RuleForEach(o => o.DependentMultipleChoiceResponses)
                            .ChildRules(depResponse =>
                            {
                                depResponse.When(dep => dep.DependentMultipleChoiceOption.Id == dep.MultipleChoiceResponse.SelectedDependentMultipleChoiceResponseId, () =>
                                {
                                    depResponse.RuleFor(dep => dep.FreeFormFieldValue)
                                        .NotEmpty()
                                        .When(dep => dep.DependentMultipleChoiceOption.HasFreeFormField)
                                        .WithMessage(l["error-dependent-option-free-form-response-required"]);

                                    depResponse.RuleFor(dep => dep.FreeFormFieldValue)
                                        .MaximumLength(200)
                                        .WithMessage(l["validation-maximum-length", 200]);
                                });
                            });
                    });

                    When(o => o.MultipleChoiceOption.DependentQuestionType is DependentQuestionType.MultipleSelect, () =>
                    {
                        When(o => o.DependentMultipleChoiceResponses.All(dep => !dep.IsChecked), () =>
                        {
                            RuleForEach(o => o.DependentMultipleChoiceResponses)
                                .ChildRules(depResponse =>
                                {
                                    depResponse.RuleFor(dep => dep.IsChecked)
                                        .Must(isChecked => isChecked)
                                        .WithMessage(l["error-dependent-option-required"]);
                                });
                        });

                        RuleForEach(o => o.DependentMultipleChoiceResponses)
                            .ChildRules(depResponse =>
                            {
                                depResponse.When(dep => dep.IsChecked, () =>
                                {
                                    depResponse.RuleFor(dep => dep.FreeFormFieldValue)
                                        .NotEmpty()
                                        .When(dep => dep.DependentMultipleChoiceOption.HasFreeFormField)
                                        .WithMessage(l["error-dependent-option-free-form-response-required"]);

                                    depResponse.RuleFor(dep => dep.FreeFormFieldValue)
                                        .MaximumLength(200)
                                        .WithMessage(l["validation-maximum-length", 200]);
                                });
                            });
                    });
                });
        }
    }

    public class CustomFieldClassProvider : FieldCssClassProvider
    {
        public override string GetFieldCssClass(EditContext editContext, in FieldIdentifier fieldIdentifier)
        {
            var isValid = editContext.IsValid(fieldIdentifier);
            return isValid ? "" : "is-invalid";
        }
    }

    private class QuestionnaireDetailLookup
    {
        public Dictionary<int, QuestionGroup> QuestionGroupMap { get; set; } = [];
        public Dictionary<int, Question> QuestionMap { get; set; } = [];
        public Dictionary<int, MultipleChoiceOption> OptionMap { get; set; } = [];
        public Dictionary<int, DependentMultipleChoiceOption> DepOptionMap { get; set; } = [];
    }

}
