@using Aloha.Domain.Questionnaires
@using FluentValidation
@using Blazored.FluentValidation
@using Aloha.Domain.Services.Translations
@using System.Globalization
@inject ITranslationHelper TranslationHelper
@inject ILanguageConfigurationService LanguageConfigService
@rendermode InteractiveServer

<EditForm novalidate
          FormName="QuestionGroup"
          EditContext="editContext"
          Context="questionGroupFormContext"
          OnSubmit="HandleSubmitAsync">
    <FluentValidationValidator/>
    @* Bulk translate button at the top *@
    <BulkTranslateButton @ref="bulkTranslateButton"
                        SelectedCulture="@bulkSelectedCulture"
                        SelectedCultureChanged="@OnBulkCultureChanged"
                        OnBulkTranslate="@OnBulkTranslateAll"
                        OnBulkTranslateAllLanguages="@OnBulkTranslateAllLanguages"
                        GetFieldsWithExistingText="@GetFieldsWithExistingText"
                        HasEnglishTextFunc="@HasEnglishText" />

    @* Multi-language input for Name *@
    <MultiLanguageInput Label="Name"
                       FieldId="groupName"
                       Placeholder="Enter group name"
                       Rows="1"
                       IsDisabled="false"
                       EnglishValue="@input.Name"
                       EnglishValueChanged="@((string value) => input.Name = value)"
                       Translations="@input.NameTranslations"
                       TranslationsChanged="@((Dictionary<string, string> trans) => input.NameTranslations = trans)"
                       SelectedCultureOverride="@bulkSelectedCulture"
                       SelectedCultureOverrideChanged="@OnBulkCultureChanged" />

    @* Multi-language input for Description *@
    <MultiLanguageInput Label="Description"
                       FieldId="groupDescription"
                       Placeholder="Enter group description"
                       Rows="3"
                       IsDisabled="false"
                       EnglishValue="@input.Description"
                       EnglishValueChanged="@((string value) => input.Description = value)"
                       Translations="@input.DescriptionTranslations"
                       TranslationsChanged="@((Dictionary<string, string> trans) => input.DescriptionTranslations = trans)"
                       SelectedCultureOverride="@bulkSelectedCulture"
                       SelectedCultureOverrideChanged="@OnBulkCultureChanged" />
    <div class="d-flex flex-column">
        @if (input.HasSubmitted && editContext.GetValidationMessages().Any())
        {
            <Alert Color="AlertColor.Danger">
                <Icon class="me-2" Name="IconName.ExclamationTriangleFill"></Icon>
                Some information is missing and/or invalid. Please review your responses.
            </Alert>
        }
        <div class="mt-2 d-flex gap-2">
            @if (IsEditing)
            {
                <button class="btn btn-secondary" @onclick="OnClose.InvokeAsync" type="button">Cancel</button>
                <button class="btn btn-primary">Save Group Edits</button>
            }
            else
            {
                <button class="btn btn-primary">Add Group</button>
            }
        </div>
    </div>
</EditForm>

@code {

    private readonly Input input = new();
    private EditContext editContext = default!;
    private ValidationMessageStore messageStore = default!;

    private DraftInput? initialValues;
    private string bulkSelectedCulture = "en-US";
    private string primaryLanguage = "en-US";
    private BulkTranslateButton? bulkTranslateButton;

    [Parameter, EditorRequired]
    public EventCallback<Input> OnSubmit { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<Input> OnClose { get; set; }

    [Parameter]
    public DraftInput? InitialValues { get; set; }

    [Parameter]
    public bool IsEditing { get; set; }

    protected override void OnInitialized()
    {
        editContext = new EditContext(input);
        messageStore = new ValidationMessageStore(editContext);
        editContext.OnValidationRequested += (_, _) => messageStore.Clear();
        editContext.OnFieldChanged += (_, e) => messageStore.Clear(e.FieldIdentifier);
    }

    protected override async Task OnInitializedAsync()
    {
        primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
        bulkSelectedCulture = primaryLanguage;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            primaryLanguage = await LanguageConfigService.GetPrimaryLanguageAsync();
            bulkSelectedCulture = primaryLanguage;
            StateHasChanged();
        }
    }

    protected override void OnParametersSet()
    {
        if (InitialValues == initialValues)
        {
            return;
        }

        initialValues = InitialValues;

        if (initialValues is null)
        {
            input.Clear();
            messageStore.Clear();
            editContext.MarkAsUnmodified();
            editContext.NotifyValidationStateChanged();
        }
        else
        {
            input.UpdateFromDraft(initialValues);
            editContext.Validate();
        }
    }

    public async Task HandleSubmitAsync()
    {
        input.HasSubmitted = true;
        if (!editContext.Validate())
        {
            StateHasChanged();
            return;
        }
        input.Trim();
        await OnSubmit.InvokeAsync(input);
        await OnClose.InvokeAsync();
        input.Clear();
    }

    public class DraftInput
    {
        public required Guid DraftId { get; set; }
        public required string Name { get; set; }
        public string? Description { get; set; }
        public int SortOrder { get; set; }
        public IList<QuestionForm.DraftInput> Questions { get; set; } = [];
        public Dictionary<string, string> NameTranslations { get; set; } = new();
        public Dictionary<string, string> DescriptionTranslations { get; set; } = new();

        public static DraftInput CreateFromQuestionGroup(QuestionGroup group, Dictionary<string, string>? nameTranslations = null, Dictionary<string, string>? descriptionTranslations = null)
        {
            var draftId = Guid.NewGuid();

            return new DraftInput
            {
                DraftId = draftId,
                Name = group.Name,
                Description = group.Description,
                SortOrder = group.SortOrder,
                Questions = group.Questions?
                        .Select(q => QuestionForm.DraftInput.CreateFromQuestion(q, draftId))
                        .ToList() ??
                    [],
                NameTranslations = nameTranslations ?? new Dictionary<string, string>(),
                DescriptionTranslations = descriptionTranslations ?? new Dictionary<string, string>()
            };
        }
    }

    public class Input
    {
        public bool HasSubmitted { get; set; }

        public string? Name { get; set; }
        public string? Description { get; set; }
        public Dictionary<string, string> NameTranslations { get; set; } = new();
        public Dictionary<string, string> DescriptionTranslations { get; set; } = new();

        public void UpdateFromDraft(DraftInput draft)
        {
            Name = draft.Name;
            Description = draft.Description;
            NameTranslations = new Dictionary<string, string>(draft.NameTranslations);
            DescriptionTranslations = new Dictionary<string, string>(draft.DescriptionTranslations);
        }

        public void Trim()
        {
            Name = Name?.Trim();
            Description = string.IsNullOrWhiteSpace(Description) ? null : Description.Trim();
        }

        public void Clear()
        {
            Name = null;
            Description = null;
            NameTranslations.Clear();
            DescriptionTranslations.Clear();
        }
    }

    public class FormValidator : AbstractValidator<Input>
    {
        public FormValidator()
        {
            When(input => input.HasSubmitted, () =>
            {
                RuleFor(p => p.Name).NotEmpty().WithMessage("Group name is required");
            });
        }
    }

    private async Task OnBulkCultureChanged(string culture)
    {
        bulkSelectedCulture = culture;
        StateHasChanged();
    }

    private bool HasEnglishText()
    {
        return !string.IsNullOrWhiteSpace(input.Name) ||
               !string.IsNullOrWhiteSpace(input.Description);
    }

    private List<string> GetFieldsWithExistingText()
    {
        var fields = new List<string>();
        if (input.NameTranslations.TryGetValue(bulkSelectedCulture, out var nameTrans) && !string.IsNullOrWhiteSpace(nameTrans))
        {
            fields.Add("Name");
        }
        if (input.DescriptionTranslations.TryGetValue(bulkSelectedCulture, out var descTrans) && !string.IsNullOrWhiteSpace(descTrans))
        {
            fields.Add("Description");
        }
        return fields;
    }

    private async Task OnBulkTranslateAll()
    {
        bulkTranslateButton?.ClearError();
        
        if (string.IsNullOrWhiteSpace(bulkSelectedCulture) || bulkSelectedCulture == primaryLanguage)
        {
            return;
        }

        var errors = new List<string>();

        // Translate Name
        if (!string.IsNullOrWhiteSpace(input.Name))
        {
            try
            {
                var translated = await TranslationHelper.TranslateAsync(input.Name, bulkSelectedCulture);
                if (translated != null)
                {
                    input.NameTranslations[bulkSelectedCulture] = translated;
                }
                else
                {
                    errors.Add($"Name: Translation failed (no result returned)");
                }
            }
            catch (Exception ex)
            {
                errors.Add($"Name: {ex.Message}");
            }
        }

        // Translate Description
        if (!string.IsNullOrWhiteSpace(input.Description))
        {
            try
            {
                var translated = await TranslationHelper.TranslateAsync(input.Description, bulkSelectedCulture);
                if (translated != null)
                {
                    input.DescriptionTranslations[bulkSelectedCulture] = translated;
                }
                else
                {
                    errors.Add($"Description: Translation failed (no result returned)");
                }
            }
            catch (Exception ex)
            {
                errors.Add($"Description: {ex.Message}");
            }
        }

        if (errors.Any())
        {
            var isApiConfigured = TranslationHelper.IsTranslationApiConfigured();
            var errorMessage = isApiConfigured 
                ? $"Some translations failed: {string.Join("; ", errors)}. Please check your API configuration."
                : "Translation API is not configured. Please configure Azure Translator or Google Translate API keys in appsettings.json.";
            bulkTranslateButton?.SetError(errorMessage);
        }

        StateHasChanged();
    }

    private async Task OnBulkTranslateAllLanguages()
    {
        bulkTranslateButton?.ClearError();
        
        var availableLanguages = await TranslationHelper.GetAvailableLanguagesAsync();
        var errors = new List<string>();

        // Translate Name to all languages
        if (!string.IsNullOrWhiteSpace(input.Name))
        {
            foreach (var lang in availableLanguages)
            {
                if (lang == primaryLanguage) continue;
                
                try
                {
                    var translated = await TranslationHelper.TranslateAsync(input.Name, lang);
                    if (translated != null)
                    {
                        input.NameTranslations[lang] = translated;
                    }
                    else
                    {
                        errors.Add($"Name ({CultureInfo.GetCultureInfo(lang).DisplayName}): Translation failed");
                    }
                }
                catch (Exception ex)
                {
                    errors.Add($"Name ({CultureInfo.GetCultureInfo(lang).DisplayName}): {ex.Message}");
                }
            }
        }

        // Translate Description to all languages
        if (!string.IsNullOrWhiteSpace(input.Description))
        {
            foreach (var lang in availableLanguages)
            {
                if (lang == primaryLanguage) continue;
                
                try
                {
                    var translated = await TranslationHelper.TranslateAsync(input.Description, lang);
                    if (translated != null)
                    {
                        input.DescriptionTranslations[lang] = translated;
                    }
                    else
                    {
                        errors.Add($"Description ({CultureInfo.GetCultureInfo(lang).DisplayName}): Translation failed");
                    }
                }
                catch (Exception ex)
                {
                    errors.Add($"Description ({CultureInfo.GetCultureInfo(lang).DisplayName}): {ex.Message}");
                }
            }
        }

        if (errors.Any())
        {
            var isApiConfigured = TranslationHelper.IsTranslationApiConfigured();
            var errorMessage = isApiConfigured 
                ? $"Some translations failed: {string.Join("; ", errors)}. Please check your API configuration."
                : "Translation API is not configured. Please configure Azure Translator or Google Translate API keys in appsettings.json.";
            bulkTranslateButton?.SetError(errorMessage);
        }

        StateHasChanged();
    }

}