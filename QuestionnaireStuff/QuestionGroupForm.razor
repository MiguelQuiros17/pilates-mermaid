@using Aloha.Domain.Questionnaires
@using FluentValidation
@using Blazored.FluentValidation
@using Aloha.Domain.Services.Translations
@using System.Globalization
@using Aloha.Admin.Web.Components.Features.Customization.Questionnaires
@inject ITranslationHelper TranslationHelper
@inject ILanguageConfigurationService LanguageConfigService
@rendermode InteractiveServer

<EditForm novalidate
          FormName="QuestionGroup"
          EditContext="editContext"
          Context="questionGroupFormContext"
          OnSubmit="HandleSubmitAsync">
    <FluentValidationValidator/>
    @* Multi-language input for Name *@
    <MultiLanguageInput Label="Name"
                       FieldId="groupName"
                       Placeholder="Enter group name"
                       Rows="1"
                       IsDisabled="false"
                       EnglishValue="@input.Name"
                       EnglishValueChanged="@((string value) => input.Name = value)"
                       Translations="@input.NameTranslations"
                       TranslationsChanged="@((Dictionary<string, string> trans) => input.NameTranslations = trans)"
                       SelectedCultureOverride="@SelectedCulture"
                       SelectedCultureOverrideChanged="@((string culture) => { })" />

    @* Multi-language input for Description *@
    <MultiLanguageInput Label="Description"
                       FieldId="groupDescription"
                       Placeholder="Enter group description"
                       Rows="3"
                       IsDisabled="false"
                       EnglishValue="@input.Description"
                       EnglishValueChanged="@((string value) => input.Description = value)"
                       Translations="@input.DescriptionTranslations"
                       TranslationsChanged="@((Dictionary<string, string> trans) => input.DescriptionTranslations = trans)"
                       SelectedCultureOverride="@SelectedCulture"
                       SelectedCultureOverrideChanged="@((string culture) => { })" />
    <div class="d-flex flex-column">
        @if (input.HasSubmitted && editContext.GetValidationMessages().Any())
        {
            <Alert Color="AlertColor.Danger">
                <Icon class="me-2" Name="IconName.ExclamationTriangleFill"></Icon>
                Some information is missing and/or invalid. Please review your responses.
            </Alert>
        }
        <div class="mt-2 d-flex gap-2">
            @if (IsEditing)
            {
                <button class="btn btn-secondary" @onclick="OnClose.InvokeAsync" type="button">Cancel</button>
                <button class="btn btn-primary">Save Group Edits</button>
            }
            else
            {
                <button class="btn btn-primary">Add Group</button>
            }
        </div>
    </div>
</EditForm>

@code {

    private readonly Input input = new();
    private EditContext editContext = default!;
    private ValidationMessageStore messageStore = default!;

    private DraftInput? initialValues;

    [Parameter, EditorRequired]
    public EventCallback<Input> OnSubmit { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<Input> OnClose { get; set; }

    [Parameter]
    public DraftInput? InitialValues { get; set; }

    [Parameter]
    public bool IsEditing { get; set; }

    [Parameter]
    public string SelectedCulture { get; set; } = "en-US";

    protected override void OnInitialized()
    {
        editContext = new EditContext(input);
        messageStore = new ValidationMessageStore(editContext);
        editContext.OnValidationRequested += (_, _) => messageStore.Clear();
        editContext.OnFieldChanged += (_, e) => messageStore.Clear(e.FieldIdentifier);
    }


    protected override void OnParametersSet()
    {
        if (InitialValues == initialValues)
        {
            return;
        }

        initialValues = InitialValues;

        if (initialValues is null)
        {
            input.Clear();
            messageStore.Clear();
            editContext.MarkAsUnmodified();
            editContext.NotifyValidationStateChanged();
        }
        else
        {
            input.UpdateFromDraft(initialValues);
            editContext.Validate();
        }
    }

    public async Task HandleSubmitAsync()
    {
        input.HasSubmitted = true;
        if (!editContext.Validate())
        {
            StateHasChanged();
            return;
        }
        input.Trim();
        await OnSubmit.InvokeAsync(input);
        await OnClose.InvokeAsync();
        input.Clear();
    }

    public class DraftInput
    {
        public required Guid DraftId { get; set; }
        public required string Name { get; set; }
        public string? Description { get; set; }
        public int SortOrder { get; set; }
        public IList<Aloha.Admin.Web.Components.Features.Customization.Questionnaires.QuestionForm.DraftInput> Questions { get; set; } = [];
        public Dictionary<string, string> NameTranslations { get; set; } = new();
        public Dictionary<string, string> DescriptionTranslations { get; set; } = new();

        public static QuestionGroupForm.DraftInput CreateFromQuestionGroup(QuestionGroup group, Dictionary<string, string>? nameTranslations = null, Dictionary<string, string>? descriptionTranslations = null)
        {
            var draftId = Guid.NewGuid();
            
            IList<Aloha.Admin.Web.Components.Features.Customization.Questionnaires.QuestionForm.DraftInput> questionsList;
            if (group.Questions != null && group.Questions.Any())
            {
                questionsList = group.Questions
                    .Select((Question q) => Aloha.Admin.Web.Components.Features.Customization.Questionnaires.QuestionForm.DraftInput.CreateFromQuestion(q, draftId, nameTranslations: null, descriptionTranslations: null))
                    .ToList();
            }
            else
            {
                questionsList = new List<Aloha.Admin.Web.Components.Features.Customization.Questionnaires.QuestionForm.DraftInput>();
            }

            return new DraftInput
            {
                DraftId = draftId,
                Name = group.Name,
                Description = group.Description,
                SortOrder = group.SortOrder,
                Questions = questionsList,
                NameTranslations = nameTranslations ?? new Dictionary<string, string>(),
                DescriptionTranslations = descriptionTranslations ?? new Dictionary<string, string>()
            };
        }
    }

    public class Input
    {
        public bool HasSubmitted { get; set; }

        public string? Name { get; set; }
        public string? Description { get; set; }
        public Dictionary<string, string> NameTranslations { get; set; } = new();
        public Dictionary<string, string> DescriptionTranslations { get; set; } = new();

        public void UpdateFromDraft(DraftInput draft)
        {
            Name = draft.Name;
            Description = draft.Description;
            NameTranslations = new Dictionary<string, string>(draft.NameTranslations);
            DescriptionTranslations = new Dictionary<string, string>(draft.DescriptionTranslations);
        }

        public void Trim()
        {
            Name = Name?.Trim();
            Description = string.IsNullOrWhiteSpace(Description) ? null : Description.Trim();
        }

        public void Clear()
        {
            Name = null;
            Description = null;
            NameTranslations.Clear();
            DescriptionTranslations.Clear();
        }
    }

    public class FormValidator : AbstractValidator<Input>
    {
        public FormValidator()
        {
            When(input => input.HasSubmitted, () =>
            {
                RuleFor(p => p.Name).NotEmpty().WithMessage("Group name is required");
            });
        }
    }

}