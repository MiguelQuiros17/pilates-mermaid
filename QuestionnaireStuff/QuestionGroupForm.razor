@using Aloha.Domain.Questionnaires
@using FluentValidation
@using Blazored.FluentValidation
@using Aloha.Domain.Services.Translations
@using System.Globalization
@using Aloha.Admin.Web.Components.Features.Customization.Questionnaires
@inject ITranslationHelper TranslationHelper
@inject ILanguageConfigurationService LanguageConfigService
@rendermode InteractiveServer

<EditForm novalidate
          FormName="QuestionGroup"
          EditContext="editContext"
          Context="questionGroupFormContext"
          OnSubmit="HandleSubmitAsync">
    <FluentValidationValidator/>
    @* Multi-language input for Name *@
    <MultiLanguageInput Label="Name"
                       FieldId="groupName"
                       Placeholder="Enter group name"
                       Rows="1"
                       IsDisabled="false"
                       Field="@input.NameField"
                       FieldChanged="@((MultilingualField f) => input.NameField = f)"
                       SelectedCultureOverride="@SelectedCulture"
                       SelectedCultureOverrideChanged="@((string culture) => { })" />

    @* Multi-language input for Description *@
    <MultiLanguageInput Label="Description"
                       FieldId="groupDescription"
                       Placeholder="Enter group description"
                       Rows="3"
                       IsDisabled="false"
                       Field="@input.DescriptionField"
                       FieldChanged="@((MultilingualField f) => input.DescriptionField = f)"
                       SelectedCultureOverride="@SelectedCulture"
                       SelectedCultureOverrideChanged="@((string culture) => { })" />
    <div class="d-flex flex-column">
        @if (input.HasSubmitted && editContext.GetValidationMessages().Any())
        {
            <Alert Color="AlertColor.Danger">
                <Icon class="me-2" Name="IconName.ExclamationTriangleFill"></Icon>
                Some information is missing and/or invalid. Please review your responses.
            </Alert>
        }
        <div class="mt-2 d-flex gap-2">
            @if (IsEditing)
            {
                <button class="btn btn-secondary" @onclick="OnClose.InvokeAsync" type="button">Cancel</button>
                <button class="btn btn-primary">Save Group Edits</button>
            }
            else
            {
                <button class="btn btn-primary">Add Group</button>
            }
        </div>
    </div>
</EditForm>

@code {

    private readonly Input input = new();
    private EditContext editContext = default!;
    private ValidationMessageStore messageStore = default!;

    private DraftInput? initialValues;

    [Parameter, EditorRequired]
    public EventCallback<Input> OnSubmit { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<Input> OnClose { get; set; }

    [Parameter]
    public DraftInput? InitialValues { get; set; }

    [Parameter]
    public bool IsEditing { get; set; }

    [Parameter]
    public string SelectedCulture { get; set; } = "en-US";

    protected override void OnInitialized()
    {
        editContext = new EditContext(input);
        messageStore = new ValidationMessageStore(editContext);
        editContext.OnValidationRequested += (_, _) => messageStore.Clear();
        editContext.OnFieldChanged += (_, e) => messageStore.Clear(e.FieldIdentifier);
    }


    protected override void OnParametersSet()
    {
        if (InitialValues == initialValues)
        {
            return;
        }

        initialValues = InitialValues;

        if (initialValues is null)
        {
            input.Clear();
            messageStore.Clear();
            editContext.MarkAsUnmodified();
            editContext.NotifyValidationStateChanged();
        }
        else
        {
            input.UpdateFromDraft(initialValues);
            editContext.Validate();
        }
    }

    public async Task HandleSubmitAsync()
    {
        input.HasSubmitted = true;
        if (!editContext.Validate())
        {
            StateHasChanged();
            return;
        }
        input.Trim();
        await OnSubmit.InvokeAsync(input);
        await OnClose.InvokeAsync();
        input.Clear();
    }

    public class DraftInput
    {
        public required Guid DraftId { get; set; }
        public MultilingualField NameField { get; set; } = new();
        public MultilingualField DescriptionField { get; set; } = new();
        public int SortOrder { get; set; }
        public IList<QuestionForm.DraftInput> Questions { get; set; } = [];

        public static QuestionGroupForm.DraftInput CreateFromQuestionGroup(QuestionGroup group, MultilingualField? nameField = null, MultilingualField? descriptionField = null)
        {
            var draftId = Guid.NewGuid();
            
            IList<QuestionForm.DraftInput> questionsList;
            if (group.Questions != null && group.Questions.Any())
            {
                questionsList = group.Questions
                    .Select((Question q) => QuestionForm.DraftInput.CreateFromQuestion(q, draftId, nameField: null, descriptionField: null))
                    .ToList();
            }
            else
            {
                questionsList = new List<QuestionForm.DraftInput>();
            }

            var result = new DraftInput
            {
                DraftId = draftId,
                SortOrder = group.SortOrder,
                Questions = questionsList
            };

            if (nameField != null)
            {
                result.NameField = new MultilingualField { PrimaryValue = nameField.PrimaryValue };
                foreach (var kvp in nameField.Translations)
                {
                    result.NameField.Translations[kvp.Key] = kvp.Value;
                }
            }
            else
            {
                result.NameField.PrimaryValue = group.Name;
            }

            if (descriptionField != null)
            {
                result.DescriptionField = new MultilingualField { PrimaryValue = descriptionField.PrimaryValue };
                foreach (var kvp in descriptionField.Translations)
                {
                    result.DescriptionField.Translations[kvp.Key] = kvp.Value;
                }
            }
            else
            {
                result.DescriptionField.PrimaryValue = group.Description ?? string.Empty;
            }

            return result;
        }
    }

    public class Input
    {
        public bool HasSubmitted { get; set; }

        public MultilingualField NameField { get; set; } = new();
        public MultilingualField DescriptionField { get; set; } = new();

        public void UpdateFromDraft(DraftInput draft)
        {
            NameField = new MultilingualField { PrimaryValue = draft.NameField.PrimaryValue };
            foreach (var kvp in draft.NameField.Translations)
            {
                NameField.Translations[kvp.Key] = kvp.Value;
            }

            DescriptionField = new MultilingualField { PrimaryValue = draft.DescriptionField.PrimaryValue };
            foreach (var kvp in draft.DescriptionField.Translations)
            {
                DescriptionField.Translations[kvp.Key] = kvp.Value;
            }
        }

        public void Trim()
        {
            NameField.PrimaryValue = NameField.PrimaryValue?.Trim() ?? string.Empty;
            DescriptionField.PrimaryValue = DescriptionField.PrimaryValue?.Trim() ?? string.Empty;
        }

        public void Clear()
        {
            NameField.Clear();
            DescriptionField.Clear();
        }
    }

    public class FormValidator : AbstractValidator<Input>
    {
        public FormValidator()
        {
            When(input => input.HasSubmitted, () =>
            {
                RuleFor(p => p.NameField.PrimaryValue).NotEmpty().WithMessage("Group name is required");
            });
        }
    }

}