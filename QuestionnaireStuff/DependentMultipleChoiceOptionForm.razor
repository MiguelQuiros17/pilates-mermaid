@using Aloha.Domain.Questionnaires
@using FluentValidation
@using Blazored.FluentValidation
@using Aloha.Domain.Services.Translations
@using System.Globalization
@inject ITranslationHelper TranslationHelper
@inject ILanguageConfigurationService LanguageConfigService
@rendermode InteractiveServer

<EditForm novalidate
          FormName="DependentMultipleChoiceOption"
          EditContext="editContext"
          Context="dependentMultipleChoiceOptionFormContext"
          OnSubmit="HandleSubmitAsync">
    <FluentValidationValidator/>
    @* Multi-language input for Option Name *@
    <MultiLanguageInput Label="Option Name"
                       FieldId="dependentOptionName"
                       Placeholder="Enter option name"
                       Rows="1"
                       IsDisabled="false"
                       Field="@input.NameField"
                       FieldChanged="@((MultilingualField f) => input.NameField = f)"
                       SelectedCultureOverride="@SelectedCulture"
                       SelectedCultureOverrideChanged="@((string culture) => { })" />

    <div class="mb-2">
        <InputCheckbox class="form-check-input"
                       @bind-Value="input.HasFreeFormField"
                       id="dependent-question-has-free-form"/>
        <label class="form-check-label" for="dependent-question-has-free-form">
            Has Free Form Field?
        </label>
    </div>
    @if (input.HasFreeFormField)
    {
        @* Multi-language input for Free Form Field Description *@
        <MultiLanguageInput Label="Free Form Field Helper Text"
                           FieldId="freeFormFieldDescription"
                           Placeholder="For example..."
                           Rows="3"
                           IsDisabled="false"
                           Field="@input.FreeFormFieldDescriptionField"
                           FieldChanged="@((MultilingualField f) => input.FreeFormFieldDescriptionField = f)"
                           SelectedCultureOverride="@SelectedCulture"
                           SelectedCultureOverrideChanged="@((string culture) => { })" />
    }
    <div class="d-flex flex-column">
        @if (input.HasSubmitted && editContext.GetValidationMessages().Any())
        {
            <Alert Color="AlertColor.Danger">
                <Icon class="me-2" Name="IconName.ExclamationTriangleFill"></Icon>
                Some information is missing and/or invalid. Please review your responses.
            </Alert>
        }
        <div class="mt-2 d-flex gap-2">
            @if (IsEditing)
            {
                <button class="btn btn-outline-primary">Save Dependent Option Edits</button>
                <button class="btn btn-outline-secondary" type="button" @onclick="OnClose.InvokeAsync">Cancel</button>
            }
            else
            {
                <button class="btn btn-outline-primary">Add Dependent Option</button>
            }
        </div>
    </div>
</EditForm>

@code {

    private DraftInput? initialValues;
    private Input input = default!;
    private ValidationMessageStore messageStore = default!;
    private EditContext editContext = default!;

    [Parameter]
    public bool IsEditing { get; set; }

    [Parameter]
    public DraftInput? InitialValues { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<Input> OnSubmit { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<Input> OnClose { get; set; }

    [Parameter]
    public string SelectedCulture { get; set; } = "en-US";

    [Parameter]
    public string PrimaryLanguage { get; set; } = "en-US";

    protected override void OnInitialized()
    {
        initialValues = InitialValues;
        input = Input.CreateFromDraft(initialValues);
        editContext = new EditContext(input);
        messageStore = new ValidationMessageStore(editContext);
        editContext.OnValidationRequested += (_, _) => messageStore.Clear();
        editContext.OnFieldChanged += (_, e) => messageStore.Clear(e.FieldIdentifier);
    }


    protected override void OnParametersSet()
    {
        if (InitialValues == initialValues)
        {
            return;
        }

        // If initial values change...
        initialValues = InitialValues;

        // Clear the form if new values are null...
        if (initialValues is null)
        {
            input.Clear();
            messageStore.Clear();
            editContext.MarkAsUnmodified();
            editContext.NotifyValidationStateChanged();
        }
        // Otherwise, replace form values with initial values
        else
        {
            input.UpdateFromDraft(initialValues);
            editContext.Validate();
        }
    }

    private async Task HandleSubmitAsync()
    {
        input.HasSubmitted = true;
        if (!editContext.Validate())
        {
            StateHasChanged();
            return;
        }
        input.Trim();
        await OnSubmit.InvokeAsync(input);
        await OnClose.InvokeAsync();
        input.Clear();
    }

    public class DraftInput
    {
        public required Guid DraftId { get; set; }
        public MultilingualField NameField { get; set; } = new();
        public bool HasFreeFormField { get; set; }
        public MultilingualField FreeFormFieldDescriptionField { get; set; } = new();
        public int SortOrder { get; set; }

        public static DraftInput CreateFromDependentOption(DependentMultipleChoiceOption depOption, MultilingualField? nameField = null, MultilingualField? freeFormFieldDescriptionField = null)
        {
            var result = new DraftInput
            {
                DraftId = Guid.NewGuid(),
                SortOrder = depOption.SortOrder,
                HasFreeFormField = depOption.HasFreeFormField
            };

            if (nameField != null)
            {
                result.NameField = new MultilingualField { PrimaryValue = nameField.PrimaryValue };
                foreach (var kvp in nameField.Translations)
                {
                    result.NameField.Translations[kvp.Key] = kvp.Value;
                }
            }
            else
            {
                result.NameField.PrimaryValue = depOption.Name;
            }

            if (freeFormFieldDescriptionField != null)
            {
                result.FreeFormFieldDescriptionField = new MultilingualField { PrimaryValue = freeFormFieldDescriptionField.PrimaryValue };
                foreach (var kvp in freeFormFieldDescriptionField.Translations)
                {
                    result.FreeFormFieldDescriptionField.Translations[kvp.Key] = kvp.Value;
                }
            }
            else
            {
                result.FreeFormFieldDescriptionField.PrimaryValue = depOption.FreeFormFieldDescription ?? string.Empty;
            }

            return result;
        }
    }

    public class Input
    {
        public bool HasSubmitted { get; set; }

        public MultilingualField NameField { get; set; } = new();
        public bool HasFreeFormField { get; set; }
        public MultilingualField FreeFormFieldDescriptionField { get; set; } = new();

        public static Input CreateFromDraft(DraftInput? draft)
        {
            var newInput = new Input();

            if (draft is not null)
            {
                newInput.UpdateFromDraft(draft);
            }

            return newInput;
        }

        public void UpdateFromDraft(DraftInput draft)
        {
            NameField = new MultilingualField { PrimaryValue = draft.NameField.PrimaryValue };
            foreach (var kvp in draft.NameField.Translations)
            {
                NameField.Translations[kvp.Key] = kvp.Value;
            }

            HasFreeFormField = draft.HasFreeFormField;

            FreeFormFieldDescriptionField = new MultilingualField { PrimaryValue = draft.FreeFormFieldDescriptionField.PrimaryValue };
            foreach (var kvp in draft.FreeFormFieldDescriptionField.Translations)
            {
                FreeFormFieldDescriptionField.Translations[kvp.Key] = kvp.Value;
            }
        }

        public void Trim()
        {
            NameField.PrimaryValue = NameField.PrimaryValue?.Trim() ?? string.Empty;
            FreeFormFieldDescriptionField.PrimaryValue = FreeFormFieldDescriptionField.PrimaryValue?.Trim() ?? string.Empty;
        }

        public void Clear()
        {
            NameField.Clear();
            HasFreeFormField = false;
            FreeFormFieldDescriptionField.Clear();
        }
    }

    public class FormValidator : AbstractValidator<Input>
    {
        public FormValidator()
        {
            When(input => input.HasSubmitted, () =>
            {
                RuleFor(p => p.NameField.PrimaryValue).NotEmpty().WithMessage("Dependent option name is required");
            });
        }
    }

}