@using Aloha.Domain.Questionnaires
@using FluentValidation
@using Blazored.FluentValidation
@using Aloha.Domain.Services.Translations
@using System.Globalization
@inject ITranslationHelper TranslationHelper
@inject ILanguageConfigurationService LanguageConfigService
@rendermode InteractiveServer

<EditForm novalidate
          OnSubmit="HandleSubmitAsync"
          EditContext="editContext"
          Context="multipleChoiceOptionFormContext"
          FormName="MultipleChoiceOption">
    <FluentValidationValidator/>
    @* Multi-language input for Option Name *@
    <MultiLanguageInput Label="Option Name"
                       FieldId="optionName"
                       Placeholder="Enter option name"
                       Rows="1"
                       IsDisabled="false"
                       Field="@input.NameField"
                       FieldChanged="@((MultilingualField f) => input.NameField = f)"
                       SelectedCultureOverride="@SelectedCulture"
                       SelectedCultureOverrideChanged="@((string culture) => { })" />

    <div class="mb-2">
        <InputCheckbox class="form-check-input"
                       @bind-Value="input.HasDependentQuestion"
                       id="has-dependent-question"/>
        <label class="form-check-label" for="has-dependent-question">Has Dependent Question?</label>
    </div>

    @if (input.HasDependentQuestion)
    {
        @* Multi-language input for Dependent Question Name *@
        <MultiLanguageInput Label="Dependent Question Name"
                           FieldId="dependentQuestionName"
                           Placeholder="Please specify..."
                           Rows="1"
                           IsDisabled="false"
                           Field="@input.DependentQuestionNameField"
                           FieldChanged="@((MultilingualField f) => input.DependentQuestionNameField = f)"
                           SelectedCultureOverride="@SelectedCulture"
                           SelectedCultureOverrideChanged="@((string culture) => { })" />
        <div class="mb-2">
            <label class="form-label">Dependent Question Type*</label>
            <InputSelect class="form-select"
                         required
                         @bind-Value="input.DependentQuestionType">
                @foreach (var questionType in Enum.GetValues<DependentQuestionType>())
                {
                    <option value="@questionType">@questionType.ToDisplayName()</option>
                }
            </InputSelect>
            <ValidationMessage For="() => input.DependentQuestionType"/>
        </div>

        @if (input.DependentQuestionType is DependentQuestionType.MultipleSelect or DependentQuestionType.SingleSelect)
        {
            <div class="card my-3">
                <div class="card-header">Dependent Question Options</div>
                <div class="card-body">
                    <ul class="mb-0 list-unstyled">
                        @if (!input.DependentMultipleChoiceOptions.Any())
                        {
                            <li>No multiple choice options have been added to this dependent question yet</li>
                        }
                        else
                        {
                            @foreach (var depOption in input.DependentMultipleChoiceOptions.OrderBy(o => o.SortOrder))
                            {
                                var isDepOptionBeingEdited = dependentOptionBeingEdited?.DraftId == depOption.DraftId;
                                <li style=@(isDepOptionBeingEdited ? "border-width: 2px; border-radius: 4px; border-color: var(--bs-primary); border-style: solid; padding: 8px" : string.Empty)>
                                    @if (isDepOptionBeingEdited)
                                    {
                                        <p class="text-primary fw-bold mb-0">Currently Editing</p>
                                        <hr class="my-2"/>
                                    }
                                    <div class="d-flex justify-content-start" style="gap: 8px">
                                        <div>
                                            <label for=@($"sort-option-{depOption.DraftId}")>Sort*</label>
                                            <InputNumber id=@($"sort-option-{depOption.DraftId}")
                                                         min="0"
                                                         @bind-Value="depOption.SortOrder"
                                                         class="form-control"
                                                         style="width: 64px"/>
                                        </div>
                                        <div class="flex-fill">
                                            <div>
                                                @{
                                                    var depOptionName = depOption.NameField.Get(SelectedCulture, PrimaryLanguage);
                                                }
                                                @depOptionName
                                                @if (depOption.HasFreeFormField)
                                                {
                                                    var freeFormDesc = depOption.FreeFormFieldDescriptionField.Get(SelectedCulture, PrimaryLanguage);
                                                    @if (!string.IsNullOrWhiteSpace(freeFormDesc))
                                                    {
                                                        <span class="fst-italic">
                                                            - @freeFormDesc
                                                        </span>
                                                    }

                                                    <span> (Free Form)</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-baseline gap-2">
                                            <button class="btn btn-outline-secondary"
                                                    type="button"
                                                    @onclick=@(() => OpenEditDependentMultipleChoiceOptionForm(depOption))>
                                                <Icon Name="IconName.PencilFill"/>
                                            </button>
                                            <button class="btn btn-outline-danger"
                                                    type="button"
                                                    @onclick=@(() => RemoveDependentMultipleChoiceOption(depOption))>
                                                <Icon Name="IconName.TrashFill"/>
                                            </button>
                                        </div>
                                    </div>
                                </li>
                            }
                        }
                    </ul>
                </div>
            </div>

            <div class="d-flex mb-4">
                <div class="d-lg-block d-none"
                     style="border-width: 0; border-left-width: 1px; border-style: solid; border-color: var(--bs-border-color)">
                    <div class="mx-3"></div>
                </div>
                <div class="flex-fill">
                    <h5 class="mb-2">@($"{(IsEditing ? "Edit" : "Add")} ")Dependent Multiple Choice Option</h5>
                    <DependentMultipleChoiceOptionForm
                        OnSubmit="@(isEditingDependentOption
                                      ? EditDependentMultipleChoiceOption
                                      : AddDependentMultipleChoiceOption)"
                        OnClose="CloseEditDependentMultipleChoiceOptionForm"
                        InitialValues="dependentOptionBeingEdited"
                        IsEditing="isEditingDependentOption"
                        SelectedCulture="@SelectedCulture"
                        PrimaryLanguage="@PrimaryLanguage"
                    />
                </div>
            </div>
        }
    }

    <div class="d-flex flex-column">
        @if (input.HasSubmitted && editContext.GetValidationMessages().Any())
        {
            <Alert Color="AlertColor.Danger">
                <Icon class="me-2" Name="IconName.ExclamationTriangleFill"></Icon>
                Some information is missing and/or invalid. Please review your responses.
            </Alert>
        }
        <div class="mt-2 d-flex gap-2">
            @if (IsEditing)
            {
                <button class="btn btn-outline-primary">Save Option Edits</button>
                <button class="btn btn-outline-secondary" @onclick="OnClose.InvokeAsync" type="button">Cancel</button>
            }
            else
            {
                <button class="btn btn-outline-primary">Add Option</button>
            }
        </div>
    </div>
</EditForm>

@code {

    private bool isEditingDependentOption;
    private DependentMultipleChoiceOptionForm.DraftInput? dependentOptionBeingEdited;

    private DraftInput? initialValues;
    private Input input = default!;
    private ValidationMessageStore messageStore = default!;
    private EditContext editContext = default!;

    [Parameter]
    public bool IsEditing { get; set; }

    [Parameter]
    public DraftInput? InitialValues { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<Input> OnSubmit { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<Input> OnClose { get; set; }

    [Parameter]
    public string SelectedCulture { get; set; } = "en-US";

    [Parameter]
    public string PrimaryLanguage { get; set; } = "en-US";

    protected override void OnInitialized()
    {
        initialValues = InitialValues;
        input = Input.CreateFromDraft(initialValues);
        editContext = new EditContext(input);
        messageStore = new ValidationMessageStore(editContext);
        editContext.OnValidationRequested += (_, _) => messageStore.Clear();
        editContext.OnFieldChanged += (_, e) => messageStore.Clear(e.FieldIdentifier);
    }


    protected override void OnParametersSet()
    {
        if (InitialValues == initialValues)
        {
            return;
        }

        // If initial values change...
        initialValues = InitialValues;

        // Clear the form if new values are null...
        if (initialValues is null)
        {
            input.Clear();
            messageStore.Clear();
            editContext.MarkAsUnmodified();
            editContext.NotifyValidationStateChanged();
        }
        // Otherwise, replace form values with initial values
        else
        {
            input.UpdateFromDraft(initialValues);
            editContext.Validate();
        }

        // Clear sub-forms
        CloseEditDependentMultipleChoiceOptionForm();
    }

    private void OpenEditDependentMultipleChoiceOptionForm(DependentMultipleChoiceOptionForm.DraftInput depOption)
    {
        isEditingDependentOption = true;
        dependentOptionBeingEdited = depOption;
    }

    private void CloseEditDependentMultipleChoiceOptionForm()
    {
        isEditingDependentOption = false;
        dependentOptionBeingEdited = null;
    }

    private void EditDependentMultipleChoiceOption(DependentMultipleChoiceOptionForm.Input values)
    {
        var depOption = input.DependentMultipleChoiceOptions
            .First(o => o.DraftId == dependentOptionBeingEdited!.DraftId);

        depOption.NameField = new MultilingualField { PrimaryValue = values.NameField.PrimaryValue };
        foreach (var kvp in values.NameField.Translations)
        {
            depOption.NameField.Translations[kvp.Key] = kvp.Value;
        }
        depOption.HasFreeFormField = values.HasFreeFormField;

        if (values.HasFreeFormField && !string.IsNullOrWhiteSpace(values.FreeFormFieldDescriptionField.PrimaryValue))
        {
            depOption.FreeFormFieldDescriptionField = new MultilingualField { PrimaryValue = values.FreeFormFieldDescriptionField.PrimaryValue };
            foreach (var kvp in values.FreeFormFieldDescriptionField.Translations)
            {
                depOption.FreeFormFieldDescriptionField.Translations[kvp.Key] = kvp.Value;
            }
        }
        else
        {
            depOption.FreeFormFieldDescriptionField.Clear();
        }

        CloseEditDependentMultipleChoiceOptionForm();
    }

    private void AddDependentMultipleChoiceOption(DependentMultipleChoiceOptionForm.Input values)
    {
        var draft = new DependentMultipleChoiceOptionForm.DraftInput
        {
            DraftId = Guid.NewGuid(),
            HasFreeFormField = values.HasFreeFormField
        };

        draft.NameField = new MultilingualField { PrimaryValue = values.NameField.PrimaryValue };
        foreach (var kvp in values.NameField.Translations)
        {
            draft.NameField.Translations[kvp.Key] = kvp.Value;
        }

        if (values.HasFreeFormField)
        {
            draft.FreeFormFieldDescriptionField = new MultilingualField { PrimaryValue = values.FreeFormFieldDescriptionField.PrimaryValue };
            foreach (var kvp in values.FreeFormFieldDescriptionField.Translations)
            {
                draft.FreeFormFieldDescriptionField.Translations[kvp.Key] = kvp.Value;
            }
        }

        input.DependentMultipleChoiceOptions.Add(draft);
    }

    private void RemoveDependentMultipleChoiceOption(DependentMultipleChoiceOptionForm.DraftInput depOption)
    {
        input.DependentMultipleChoiceOptions.Remove(depOption);

        if (dependentOptionBeingEdited?.DraftId == depOption.DraftId)
        {
            CloseEditDependentMultipleChoiceOptionForm();
        }
    }

    private async Task HandleSubmitAsync()
    {
        input.HasSubmitted = true;
        if (!editContext.Validate())
        {
            StateHasChanged();
            return;
        }
        input.Trim();
        await OnSubmit.InvokeAsync(input);
        await OnClose.InvokeAsync();
        input.Clear();
        CloseEditDependentMultipleChoiceOptionForm();
    }

    public class DraftInput
    {
        public required Guid DraftId { get; set; }
        public MultilingualField NameField { get; set; } = new();
        public bool HasDependentQuestion { get; set; }
        public DependentQuestionType DependentQuestionType { get; set; }
        public MultilingualField DependentQuestionNameField { get; set; } = new();
        public IList<DependentMultipleChoiceOptionForm.DraftInput>? DependentMultipleChoiceOptions { get; set; }
        public int SortOrder { get; set; }

        public static DraftInput CreateFromOption(MultipleChoiceOption option, MultilingualField? nameField = null, MultilingualField? dependentQuestionNameField = null, Func<DependentMultipleChoiceOption, MultilingualField?, MultilingualField?, DependentMultipleChoiceOptionForm.DraftInput>? createDependentOption = null)
        {
            var result = new DraftInput
            {
                DraftId = Guid.NewGuid(),
                HasDependentQuestion = option.DependentQuestionType != DependentQuestionType.None,
                SortOrder = option.SortOrder,
                DependentQuestionType = option.DependentQuestionType,
                DependentMultipleChoiceOptions = option.DependentMultipleChoiceOptions?
                    .Select(dep => createDependentOption != null 
                        ? createDependentOption(dep, null, null)
                        : DependentMultipleChoiceOptionForm.DraftInput.CreateFromDependentOption(dep))
                    .ToList()
            };

            if (nameField != null)
            {
                result.NameField = new MultilingualField { PrimaryValue = nameField.PrimaryValue };
                foreach (var kvp in nameField.Translations)
                {
                    result.NameField.Translations[kvp.Key] = kvp.Value;
                }
            }
            else
            {
                result.NameField.PrimaryValue = option.Name;
            }

            if (dependentQuestionNameField != null)
            {
                result.DependentQuestionNameField = new MultilingualField { PrimaryValue = dependentQuestionNameField.PrimaryValue };
                foreach (var kvp in dependentQuestionNameField.Translations)
                {
                    result.DependentQuestionNameField.Translations[kvp.Key] = kvp.Value;
                }
            }
            else
            {
                result.DependentQuestionNameField.PrimaryValue = option.DependentQuestionName ?? string.Empty;
            }

            return result;
        }
    }

    public class Input
    {
        public bool HasSubmitted { get; set; }

        public MultilingualField NameField { get; set; } = new();
        public bool HasDependentQuestion { get; set; }
        public MultilingualField DependentQuestionNameField { get; set; } = new();
        public DependentQuestionType DependentQuestionType { get; set; } = DependentQuestionType.None;
        public IList<DependentMultipleChoiceOptionForm.DraftInput> DependentMultipleChoiceOptions { get; set; } = [];

        public static Input CreateFromDraft(DraftInput? draft)
        {
            var newInput = new Input();

            if (draft is not null)
            {
                newInput.UpdateFromDraft(draft);
            }

            return newInput;
        }

        public void UpdateFromDraft(DraftInput draft)
        {
            NameField = new MultilingualField { PrimaryValue = draft.NameField.PrimaryValue };
            foreach (var kvp in draft.NameField.Translations)
            {
                NameField.Translations[kvp.Key] = kvp.Value;
            }

            HasDependentQuestion = draft.HasDependentQuestion;

            DependentQuestionNameField = new MultilingualField { PrimaryValue = draft.DependentQuestionNameField.PrimaryValue };
            foreach (var kvp in draft.DependentQuestionNameField.Translations)
            {
                DependentQuestionNameField.Translations[kvp.Key] = kvp.Value;
            }

            DependentQuestionType = draft.DependentQuestionType;

            DependentMultipleChoiceOptions = draft.DependentMultipleChoiceOptions == null
                ? []
                : [..draft.DependentMultipleChoiceOptions];
        }

        public void Trim()
        {
            NameField.PrimaryValue = NameField.PrimaryValue?.Trim() ?? string.Empty;
            DependentQuestionNameField.PrimaryValue = DependentQuestionNameField.PrimaryValue?.Trim() ?? string.Empty;
        }

        public void Clear()
        {
            NameField.Clear();
            HasDependentQuestion = false;
            DependentQuestionNameField.Clear();
            DependentQuestionType = DependentQuestionType.None;
            DependentMultipleChoiceOptions = [];
        }
    }

    public class FormValidator : AbstractValidator<Input>
    {
        public FormValidator()
        {
            When(input => input.HasSubmitted, () =>
            {
                RuleFor(p => p.NameField.PrimaryValue).NotEmpty().WithMessage("Option name is required");

                When(p => p.HasDependentQuestion, () =>
                {
                    RuleFor(p => p.DependentQuestionNameField.PrimaryValue).NotEmpty().WithMessage("Dependent question name is required");

                    When(p => p.DependentQuestionType is DependentQuestionType.SingleSelect or DependentQuestionType.MultipleSelect, () =>
                    {
                        RuleFor(p => p.DependentMultipleChoiceOptions)
                            .NotEmpty()
                            .WithMessage("Dependent question options must contain at least one option");
                    });
                });
            });
        }
    }

}