@using System.Linq.Expressions
@using Aloha.Domain.Questionnaires
@using Aloha.Admin.Web.Components.Features.Customization.Questionnaires
@rendermode InteractiveServer

<li style=@(IsEditing ? "border-width: 2px; border-radius: 4px; border-color: var(--bs-primary); border-style: solid; padding: 8px" : string.Empty)>
    @if (IsEditing)
    {
        <p class="text-primary fw-bold mb-0">Currently Editing</p>
        <hr class="my-2"/>
    }
    <div class="d-flex justify-content-start" style="gap: 8px">
        @if (!IsReadOnly)
        {
            <div>
                @{
                    var sortQuestionId = "sort-question-" + Question.DraftId.ToString();
                }
                <label for="@sortQuestionId">Sort*</label>
                <InputNumber id="@sortQuestionId"
                             min="0"
                             disabled="@IsReadOnly"
                             Value="SortOrder"
                             ValueChanged="SortOrderChanged"
                             ValueExpression="SortOrderExpression"
                             class="form-control"
                             style="width: 64px"/>
            </div>
        }
        <div class="flex-fill">
            <div class="fw-bold">
                @{
                    var questionName = GetLocalizedText(Question.Name, Question.NameTranslations, SelectedCulture, PrimaryLanguage);
                }
                @if (string.IsNullOrWhiteSpace(questionName))
                {
                    <span class="text-danger">(empty)</span>
                }
                else
                {
                    @questionName
                }
                @if (Question.IsRequired)
                {
                    <span class="text-danger">*</span>
                }
                @{
                    var questionDescription = GetLocalizedText(Question.Description, Question.DescriptionTranslations, SelectedCulture, PrimaryLanguage);
                }
                @if (string.IsNullOrWhiteSpace(questionDescription))
                {
                    <span class="fst-italic fw-normal text-danger"> - (empty)</span>
                }
                else
                {
                    <span class="fst-italic fw-normal"> - @questionDescription</span>
                }
            </div>

            <div>@Question.Type.ToDisplayName()</div>

            @if (
                Question.Type != QuestionType.FreeForm &&
                Question.MultipleChoiceOptions is not null &&
                Question.MultipleChoiceOptions.Any())
            {
                <ul>
                    @foreach (var option in Question.MultipleChoiceOptions.OrderBy(o => o.SortOrder))
                    {
                        <li>
                            <div>
                                @{
                                    var optionName = GetLocalizedText(option.Name, option.NameTranslations, SelectedCulture, PrimaryLanguage);
                                }
                                @if (string.IsNullOrWhiteSpace(optionName))
                                {
                                    <span class="text-danger">(empty)</span>
                                }
                                else
                                {
                                    @optionName
                                }
                                @if (option.HasDependentQuestion)
                                {
                                    var dependentQuestionName = GetLocalizedText(option.DependentQuestionName, option.DependentQuestionNameTranslations, SelectedCulture, PrimaryLanguage);
                                    @if (string.IsNullOrWhiteSpace(dependentQuestionName))
                                    {
                                        <span class="fst-italic text-danger">- (empty)</span>
                                    }
                                    else
                                    {
                                        <span class="fst-italic">- @dependentQuestionName</span>
                                    }

                                    <span> (@option.DependentQuestionType.ToDisplayName())</span>
                                }
                            </div>
                            @if (
                                option.HasDependentQuestion &&
                                option.DependentQuestionType is DependentQuestionType.SingleSelect or DependentQuestionType.MultipleSelect &&
                                option.DependentMultipleChoiceOptions is not null &&
                                option.DependentMultipleChoiceOptions.Any())
                            {
                                <ul>
                                    @foreach (var depOption in option.DependentMultipleChoiceOptions.OrderBy(o => o.SortOrder))
                                    {
                                        <li>
                                            <div>
                                                @{
                                                    var depOptionName = GetLocalizedText(depOption.Name, depOption.NameTranslations, SelectedCulture, PrimaryLanguage);
                                                }
                                                @if (string.IsNullOrWhiteSpace(depOptionName))
                                                {
                                                    <span class="text-danger">(empty)</span>
                                                }
                                                else
                                                {
                                                    @depOptionName
                                                }
                                                @if (depOption.HasFreeFormField)
                                                {
                                                    var freeFormDescription = GetLocalizedText(depOption.FreeFormFieldDescription, depOption.FreeFormFieldDescriptionTranslations, SelectedCulture, PrimaryLanguage);
                                                    @if (string.IsNullOrWhiteSpace(freeFormDescription))
                                                    {
                                                        <span class="fst-italic text-danger">
                                                            - (empty)
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="fst-italic">
                                                            - @freeFormDescription
                                                        </span>
                                                    }
                                                    <span> (Free Form)</span>
                                                }
                                            </div>
                                        </li>
                                    }
                                </ul>
                            }
                        </li>
                    }
                </ul>
            }
        </div>
        @if (!IsReadOnly)
        {
            <div class="d-flex align-items-baseline gap-2">
                <button class="btn btn-outline-secondary"
                        type="button"
                        @onclick="@(async () => await OnEdit.InvokeAsync(Question))">
                    <Icon Name="IconName.PencilFill"/>
                </button>
                <button class="btn btn-outline-danger"
                        type="button"
                        @onclick="@(async () => await OnRemove.InvokeAsync(Question))">
                    <Icon Name="IconName.TrashFill"/>
                </button>
            </div>
        }
    </div>
</li>

@code {

    [Parameter]
    public bool IsReadOnly { get; set; }

    [Parameter]
    public bool IsEditing { get; set; }

    [Parameter, EditorRequired]
    public Aloha.Admin.Web.Components.Features.Customization.Questionnaires.QuestionForm.DraftInput Question { get; set; } = default!;

    [Parameter]
    public int SortOrder { get; set; }

    [Parameter]
    public EventCallback<int> SortOrderChanged { get; set; }

    [Parameter]
    public Expression<Func<int>> SortOrderExpression { get; set; } = default!;

    [Parameter]
    public EventCallback<Aloha.Admin.Web.Components.Features.Customization.Questionnaires.QuestionForm.DraftInput> OnRemove { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<Aloha.Admin.Web.Components.Features.Customization.Questionnaires.QuestionForm.DraftInput> OnEdit { get; set; }

    [Parameter]
    public string SelectedCulture { get; set; } = "en-US";

    [Parameter]
    public string PrimaryLanguage { get; set; } = "en-US";

    private string GetLocalizedText(string? primaryValue, Dictionary<string, string> translations, string selectedCulture, string primaryLang)
    {
        if (selectedCulture == primaryLang)
        {
            return primaryValue ?? "";
        }
        
        if (translations.TryGetValue(selectedCulture, out var translatedValue))
        {
            return translatedValue ?? "";
        }
        
        return primaryValue ?? "";
    }

}